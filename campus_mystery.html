<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿·éœ§æ ¡åœ’ - åŠ‡æœ¬æ®ºéŠæˆ²</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* åŸºæœ¬æ¨£å¼èˆ‡å­—é«”è¨­å®š */
        :root {
            --bg-color: #f3f4f6;
            --card-bg: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-dark: #111827;
            --accent-purple: #8b5cf6;
            --accent-purple-dark: #7c3aed;
            --accent-blue: #60a5fa;
            --accent-blue-dark: #3b82f6;
            --keyword-blue: var(--accent-blue);
            --keyword-red: #f87171;
            --tag-border: #6b7280;
            --tag-text: #9ca3af;
            --shadow-color-light: rgba(0, 0, 0, 0.08);
            --shadow-color-medium: rgba(0, 0, 0, 0.12);
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            /* **ä¿®æ”¹ï¼šä¸»è¦å­—é«”ä»ç‚º Noto Sans TC** */
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            overscroll-behavior: none;
            background-color: var(--bg-color);
            font-size: 16px;
            color: var(--text-dark);
        }
        #game-container {
             min-height: 100vh;
             display: flex;
             flex-direction: column;
        }
        /* é—œéµå­—é«˜äº® */
        .keyword { color: var(--keyword-blue); font-weight: bold; }
        .choice-keyword { color: var(--keyword-red); font-weight: bold; }

        /* æ¨™é¡Œæ¨£å¼ */
        /* **ä¿®æ”¹ï¼šç‚ºéŠæˆ²æ¨™é¡Œå’Œç« ç¯€æ¨™é¡ŒåŠ å…¥ Noto Serif TC** */
        .game-title-gradient {
            font-family: 'Noto Serif TC', serif; /* æ¨™é¡Œä½¿ç”¨è¥¯ç·šé«” */
            background: linear-gradient(to right, var(--accent-blue), var(--accent-blue-dark));
            -webkit-background-clip: text; background-clip: text; color: transparent;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.1));
        }
        .chapter-title-style {
            font-family: 'Noto Serif TC', serif; /* æ¨™é¡Œä½¿ç”¨è¥¯ç·šé«” */
            color: #e5e7eb; text-shadow: 1px 1px 3px rgba(0,0,0,0.6); font-size: 1.85rem;
        }

        /* å°è©±æ¡†æ¨£å¼ */
        .dialogue-box {
            border: 1px solid #e0e0e0; padding: 1.1rem; margin-bottom: 1.1rem;
            /* **ä¿®æ”¹ï¼šå¢åŠ åœ“è§’å’Œå¾®èª¿é™°å½±** */
            border-radius: 12px; /* åœ“è§’æ›´å¤§ */
            background-color: rgba(255, 255, 255, 0.97);
            box-shadow: 0 6px 18px var(--shadow-color-light); /* é™°å½±èª¿æ•´ */
            line-height: 1.8; font-size: 1.08rem;
            animation: fadeIn 0.5s ease-out;
            position: relative;
            padding-right: 3rem;
         }
        .dialogue-box.player { border-left: 5px solid var(--accent-blue); background-color: rgba(239, 246, 255, 0.97); }
        .dialogue-box.npc { border-left: 5px solid #9ca3af; background-color: rgba(249, 250, 251, 0.97); }
        .character-name { font-weight: 700; margin-bottom: 0.6rem; font-size: 1.15rem; }
        .dialogue-box.player .character-name { color: var(--accent-blue-dark); }
        .dialogue-box.npc .character-name { color: #374151; }
        /* æ’­æ”¾æŒ‰éˆ•æ¨£å¼ */
        .speak-button {
            position: absolute; top: 0.75rem; right: 0.75rem; background: none;
            border: none; font-size: 1.5rem; cursor: pointer; color: #9ca3af;
            transition: color 0.2s ease, transform 0.2s ease; padding: 0.25rem; line-height: 1;
        }
        .speak-button:hover { color: var(--accent-purple); transform: scale(1.1); }
        .speak-button:active { transform: scale(0.95); }
        .speak-button.speaking { color: var(--accent-purple); animation: pulse 1.5s infinite ease-in-out; }
        .speak-button.paused { color: #fbbf24; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { display: inline-block; padding: 0.8rem 1.6rem; margin: 0.5rem; border-radius: 8px; background-image: linear-gradient(to right, var(--accent-purple), var(--accent-purple-dark)); color: white; text-align: center; cursor: pointer; transition: all 0.3s ease; font-weight: bold; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06); border: none; font-size: 1rem; }
        /* **ä¿®æ”¹ï¼šå¾®èª¿ Hover æ•ˆæœ** */
        .btn:hover {
            background-image: linear-gradient(to right, var(--accent-purple-dark), #6d28d9);
            box-shadow: 0 7px 14px rgba(0, 0, 0, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08); /* é™°å½±è®ŠåŒ– */
            transform: translateY(-3px); /* ä¸Šç§»æ›´å¤š */
        }
        .btn:active { transform: translateY(-1px); box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); } /* active æ™‚ä¸‹å£“å°‘ä¸€é» */
        .btn-secondary { background-image: linear-gradient(to right, #6b7280, #9ca3af); }
        .btn-secondary:hover { background-image: linear-gradient(to right, #4b5563, #6b7280); }
        .btn-confirm { background-image: linear-gradient(to right, #10b981, #34d399); }
        .btn-confirm:hover { background-image: linear-gradient(to right, #059669, #10b981); }
        .btn-disabled { background-image: none; background-color: #d1d5db; cursor: not-allowed; box-shadow: none; transform: none; }
        .btn-small { padding: 5px 10px; font-size: 0.875rem; margin: 0; }
        .btn-select-char { width: 100%; margin-top: auto; padding: 0.7rem 1rem; font-size: 0.95rem;}
        /* é–‹å§‹ç•«é¢è³‡è¨Šæ–‡å­— */
        .start-info-text { font-size: 1.15rem; color: #cbd5e1; margin-bottom: 0.6rem; }
        .start-info-text span { font-weight: bold; color: #f1f5f9; }
        /* è§’è‰²å¡ç‰‡æ¨£å¼ */
        #character-options { display: flex; flex-direction: column; gap: 1.75rem; width: 100%; max-width: 650px; margin: 0 auto; padding-bottom: 3rem; }
        .character-card { background-color: var(--card-bg); border-radius: 10px; padding: 0; margin: 0; box-shadow: 0 12px 25px rgba(0, 0, 0, 0.12), 0 4px 8px rgba(0, 0, 0, 0.08); transition: transform 0.3s ease, box-shadow 0.3s ease, border 0.3s ease; cursor: pointer; border: 2px solid transparent; display: flex; overflow: hidden; align-items: stretch; }
        .character-card:hover { transform: scale(1.03); box-shadow: 0 18px 35px rgba(0, 0, 0, 0.15), 0 7px 12px rgba(0, 0, 0, 0.1); }
        .character-card.selected { border-color: var(--accent-purple); box-shadow: 0 15px 30px rgba(139, 92, 246, 0.2), 0 5px 10px rgba(139, 92, 246, 0.15); }
        .character-image-container { flex-shrink: 0; width: 160px; }
        .character-image-container img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .character-info-container { flex-grow: 1; padding: 1.5rem 1.75rem; display: flex; flex-direction: column; color: var(--text-secondary); }
        .character-info-container h3 { font-family: 'Noto Serif TC', serif; font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.8rem; text-align: left; } /* è§’è‰²åç¨±ä¹Ÿç”¨è¥¯ç·šé«” */
        .character-description { font-size: 1rem; line-height: 1.7; color: var(--text-secondary); font-weight: 400; margin-bottom: 1.2rem; text-align: left; flex-grow: 1; }
        .character-tags { display: flex; flex-wrap: wrap; gap: 0.7rem; margin-bottom: 1.5rem; justify-content: flex-start; }
        .keyword-tag-box { background-color: rgba(255, 255, 255, 0.08); color: var(--tag-text); padding: 6px 14px; border: 1px solid var(--tag-border); border-radius: 6px; font-size: 0.85rem; font-weight: 500; white-space: nowrap; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease; }
        .keyword-tag-box:hover { background-color: rgba(255, 255, 255, 0.15); color: #e5e7eb; border-color: #9ca3af; }

        /* **ä¿®æ”¹ï¼šå½ˆå‡ºè¦–çª—åŠ å…¥æ·¡å…¥æ·¡å‡ºæ•ˆæœ** */
        .modal {
            /* display: none; æ”¹ç”¨ visibility å’Œ opacity æ§åˆ¶ */
            visibility: hidden; /* åˆå§‹éš±è— */
            opacity: 0; /* åˆå§‹é€æ˜ */
            position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0,0,0,0.6); /* èƒŒæ™¯ç¨å¾®èª¿æš—ä¸€é» */
            /* åŠ å…¥éæ¸¡æ•ˆæœ */
            transition: opacity 0.3s ease-out, visibility 0.3s ease-out;
            /* animation: fadeInModal 0.3s ease-out; /* ç§»é™¤èˆŠå‹•ç•« */ */
        }
        /* æ–°å¢ active ç‹€æ…‹ */
        .modal.active {
            visibility: visible; /* é¡¯ç¤º */
            opacity: 1; /* ä¸é€æ˜ */
        }
        .modal-content {
            background-color: #ffffff; padding: 25px; border: none;
            border-radius: 12px; position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.25);
            width: 90%;
            /* åŠ å…¥å…§å®¹çš„éæ¸¡æ•ˆæœ */
            transform: translateY(-20px); /* åˆå§‹ç¨å¾®å‘ä¸Šç§» */
            opacity: 0; /* åˆå§‹é€æ˜ */
            transition: opacity 0.3s ease-out 0.1s, transform 0.3s ease-out 0.1s; /* å»¶é²ä¸€é»å‡ºç¾ */
        }
        .modal.active .modal-content {
            transform: translateY(0); /* æ¢å¾©åŸä½ */
            opacity: 1; /* ä¸é€æ˜ */
        }
        /* ç­†è¨˜æœ¬ç‰¹å®šæ¨£å¼ */
        #notebook-modal .modal-content {
             margin: 10% auto;
             max-width: 600px;
        }
        #clue-list li { margin-bottom: 0.75rem; font-size: 1.05rem; color: #374151; }
        /* è¨­å®šè¦–çª—ç‰¹å®šæ¨£å¼ */
        #settings-modal .modal-content {
            position: absolute;
            top: 4rem; right: 1rem;
            margin: 0;
            max-width: 350px; width: auto;
        }
        .settings-controls-grid { display: grid; gap: 0.75rem; }
        /* ... (è¨­å®šè¦–çª—å…§å…¶ä»–æ¨£å¼ä¿æŒä¸è®Š) ... */
        .settings-group { display: flex; align-items: center; gap: 0.5rem; min-height: 2.25rem; }
        .settings-group label { font-size: 0.9rem; color: #374151; width: 50px; text-align: right; flex-shrink: 0; }
        .settings-group .control-container { display: flex; flex-grow: 1; align-items: center; gap: 0.5rem; min-width: 0; }
        .settings-group .control-container > input[type="range"], .settings-group .control-container > select { flex-grow: 1; min-width: 50px; width: 100%; box-sizing: border-box; }
        .settings-group input[type="range"] { height: 1.75rem; cursor: pointer; padding: 0 4px; vertical-align: middle; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; -webkit-appearance: none; appearance: none; }
        .settings-group input[type="range"]::-webkit-slider-runnable-track { height: 6px; background: #ddd; border-radius: 3px; }
        .settings-group input[type="range"]::-moz-range-track { height: 6px; background: #ddd; border-radius: 3px; }
        .settings-group input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: var(--accent-purple); border-radius: 50%; cursor: pointer; margin-top: -5px; }
        .settings-group input[type="range"]::-moz-range-thumb { width: 16px; height: 16px; background: var(--accent-purple); border-radius: 50%; cursor: pointer; border: none; }
        .settings-group select { padding: 4px 8px; background-color: white; height: 2rem; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; vertical-align: middle; -webkit-appearance: none; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%236B7280%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto; }
        .settings-group .btn-small { padding: 4px 10px; font-size: 0.8rem; flex-shrink: 0; margin-left: auto; }
        .settings-group span#settings-speed-display { font-weight: bold; color: #1f2937; min-width: 40px; text-align: center; background-color: #e5e7eb; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; margin: 0 0.25rem; flex-shrink: 0; line-height: 1.5rem; }
        .settings-group.speed-control .control-container{ justify-content: flex-start; }
        .settings-group.speed-control .btn-small { margin: 0; }
        .settings-group hr { width: 100%; margin: 0.5rem 0; border-color: #e5e7eb; border-top-width: 1px; grid-column: 1 / -1; }
        .modal-close-button { color: #9ca3af; position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s ease; line-height: 1; }
        .modal-close-button:hover, .modal-close-button:focus { color: var(--text-dark); text-decoration: none; }

        /* å ´æ™¯èƒŒæ™¯ */
        .scene-background {
             background-size: cover; background-position: center;
             min-height: 100vh; transition: background-image 1s ease-in-out;
             position: relative; display: flex; flex-direction: column; width: 100%;
        }
        .scene-background::before { content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.25); z-index: 1; }
        .scene-content { position: relative; z-index: 2; flex-grow: 1; display: flex; flex-direction: column; //justify-content: center; }
        /* è¨­å®šæŒ‰éˆ•æ¨£å¼ */
        .settings-button-container { position: absolute; top: 1rem; right: 1rem; z-index: 60; }
        .settings-button { background-color: rgba(255, 255, 255, 0.8); border: none; border-radius: 50%; padding: 0.6rem; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.15); transition: background-color 0.2s ease, transform 0.2s ease; display: flex; align-items: center; justify-content: center; }
        .settings-button:hover { background-color: rgba(255, 255, 255, 0.95); transform: scale(1.1); }
        .settings-icon { font-size: 1.3rem; color: #4b5563; line-height: 1; }

        /* å‹•ç•« */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* .fade-in class ä»ç„¶ç”¨æ–¼å°è©±æ¡†/é¸é …çš„é€²å…¥ */
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        #story-display > .dialogue-box, #choices-display > .btn { opacity: 0; } /* åˆå§‹é€æ˜ */
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆèª¿æ•´ */
        @media (max-width: 768px) {
            body { font-size: 15px; }
            .modal-content { width: 90%; padding: 20px; }
            #notebook-modal .modal-content { margin: 15% auto; max-width: 90%;}
            #settings-modal .modal-content { top: 3.5rem; right: 0.5rem; max-width: calc(100% - 1rem); width: auto; }
            #character-options { max-width: 95%; gap: 1rem; padding-bottom: 1rem; }
            .character-card { flex-direction: column; }
            .character-image-container { width: 100%; height: 180px; }
            .character-info-container { padding: 1rem; }
            .character-description { font-size: 0.9rem; }
            .dialogue-box { font-size: 1rem; padding-right: 2.5rem; }
            .speak-button { font-size: 1.3rem; top: 0.5rem; right: 0.5rem; }
            .btn { padding: 0.6rem 1.2rem; font-size: 0.95rem;}
            .settings-button-container { top: 0.5rem; right: 0.5rem; }
            .settings-button { padding: 0.5rem; }
            .settings-icon { font-size: 1.1rem; }
            .settings-group label { width: 40px; font-size: 0.8rem;}
            .settings-group input[type="range"] { min-width: 80px; }
            .settings-group select { min-width: 120px; font-size: 0.8rem;}
            .settings-group .btn-small { font-size: 0.75rem;}
            .settings-group span { font-size: 0.75rem; min-width: 35px;}
        }
        @media (max-width: 480px) {
             body { font-size: 14px; }
             .character-image-container { height: 150px; }
             .character-info-container h3 { font-size: 1.2rem;}
             .character-description { font-size: 0.85rem; }
             .keyword-tag-box { font-size: 0.75rem; padding: 4px 10px;}
             .btn-select-char { font-size: 0.9rem;}
             .dialogue-box { font-size: 0.95rem; }
             .btn { padding: 0.5rem 1rem; font-size: 0.9rem; }
             #settings-modal .modal-content { max-width: calc(100% - 1rem); }
             .settings-group label { width: 35px; }
             .settings-group .control-container { gap: 0.25rem; }
             .settings-group select { min-width: 100px; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="game-container" class="container mx-auto p-0 md:p-4 max-w-none md:max-w-4xl min-h-screen flex flex-col">

        <div class="settings-button-container">
            <button id="open-settings-button" class="settings-button" title="éŠæˆ²è¨­å®š">
                <span class="settings-icon">âš™ï¸</span>
            </button>
        </div>

        <div id="start-screen" class="flex flex-col items-center justify-center flex-grow scene-background" style="background-image: url('https://images.unsplash.com/photo-1562774053-701939374585?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8dW5pdmVyc2l0eSUyMGNhbXB1c3xlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=1200&q=80');">
            <div class="scene-content text-center p-4">
                <div class="bg-black bg-opacity-70 p-8 md:p-10 rounded-lg shadow-xl text-white max-w-xl mx-auto">
                    <h1 class="text-5xl font-bold mb-6 game-title-gradient">è¿·éœ§æ ¡åœ’</h1>
                    <p class="mb-3 text-lg leading-relaxed">æ·±å¤œçš„<span class="keyword">æ ¡åœ’</span>åœ–æ›¸é¤¨ï¼Œå‚³ä¾†ä¸€è²å°–å«ï¼Œæ‰“ç ´äº†å¾€æ—¥çš„å¯§éœ... <span title="Mystery">â“</span></p>
                    <p class="mb-6 text-lg leading-relaxed">å‚™å—å°Šæ•¬çš„ç‰©ç†ç³»<span class="keyword">å¼µæ•™æˆ</span>è¢«ç™¼ç¾é™³å±æ–¼<span class="keyword">è¾¦å…¬å®¤</span>å…§ã€‚ç¾å ´ç–‘é»é‡é‡ï¼Œä½ æ˜¯å¦èƒ½å¾è››çµ²é¦¬è·¡ä¸­æ‰¾å‡ºéš±è—çš„<span class="keyword">çœŸå…‡</span>ï¼Ÿ<span title="Detective">ğŸ•µï¸</span></p>
                    <div class="text-gray-300 mb-8 space-y-2">
                        <p class="start-info-text">å»ºè­°éŠç©äººæ•¸ï¼š<span>1</span> äºº</p>
                        <p class="start-info-text">é è¨ˆç¸½æ™‚é•·ï¼šç´„ <span>20-30</span> åˆ†é˜</p>
                        <p class="start-info-text">é›£åº¦ï¼š<span>â˜…â˜†â˜†â˜†â˜†</span> (æ–°æ‰‹å‹å¥½)</p>
                    </div>
                    <button id="start-game-button" class="btn text-lg">é–‹å§‹éŠæˆ²</button>
                    <button id="load-game-button" class="btn btn-secondary text-lg mt-2 md:mt-0 md:ml-4 hidden">è®€å–å­˜æª”</button>
                </div>
            </div>
        </div>

        <div id="character-select-screen" class="hidden flex flex-col items-center justify-center flex-grow scene-background" style="background-image: url('https://images.unsplash.com/photo-1507842217343-583bb7270b66?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8bGlicmFyeXxlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=1200&q=80');">
             <div class="scene-content w-full flex flex-col items-center p-4">
                 <h2 class="text-3xl font-bold mb-8 text-center text-gray-100 chapter-title-style">é¸æ“‡ä½ çš„è§’è‰²</h2>
                 <div id="character-options" class="flex flex-col gap-6 w-full max-w-lg"></div>
                 <p class="text-center mt-8 text-gray-400">é¸æ“‡ä¸åŒçš„è§’è‰²å°‡é«”é©—ä¸åŒçš„æ•…äº‹ç·šç´¢å’Œè¦–è§’ã€‚</p>
            </div>
        </div>

        <div id="game-screen" class="hidden flex flex-col flex-grow scene-background" style="/* èƒŒæ™¯ç”± JS è¨­å®š */">
            <div class="scene-content flex-grow flex flex-col p-4 md:p-6">
                <div class="bg-black bg-opacity-70 p-4 md:p-6 rounded-lg shadow-lg flex-grow flex flex-col max-w-4xl mx-auto w-full">
                    <h2 id="chapter-title" class="text-2xl font-bold mb-4 text-white text-center chapter-title-style"></h2>
                    <div id="character-status" class="mb-4 p-3 bg-white bg-opacity-80 rounded-lg flex items-center shadow">
                        <img id="player-avatar-game" src="" alt="ç©å®¶é ­åƒ" class="w-12 h-12 rounded-full mr-4 border-2 border-blue-400 shadow-md">
                        <div class="flex-grow">
                            <p id="player-name-game" class="font-bold text-gray-800"></p>
                            <p id="current-objective" class="text-sm text-gray-600"></p>
                        </div>
                         <button id="notebook-button" class="btn btn-secondary ml-4">æŸ¥çœ‹ç­†è¨˜ <span title="Notebook">ğŸ“</span></button>
                         <button id="save-game-button" class="btn btn-secondary ml-2">å„²å­˜éŠæˆ² <span title="Save">ğŸ’¾</span></button>
                    </div>
                    <div id="story-display" class="flex-grow overflow-y-auto mb-4 p-4 bg-white bg-opacity-90 rounded-lg shadow-inner min-h-[300px] max-h-[55vh]"></div>
                    <div id="choices-display" class="mt-auto text-center"></div>
                </div>
            </div>
        </div>

        <div id="ending-screen" class="hidden flex flex-col items-center justify-center flex-grow scene-background" style="background-image: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8YWJzdHJhY3QlMjBkYXJrJTIwYmFja2dyb3VuZHxlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=1200&q=80');">
            <div class="scene-content text-center p-4">
                <div class="bg-white bg-opacity-90 p-8 md:p-10 rounded-lg shadow-xl max-w-lg mx-auto">
                    <h2 id="ending-title" class="text-4xl font-bold mb-6 text-gray-800"></h2>
                    <p id="ending-description" class="mb-8 text-gray-600 leading-relaxed"></p>
                    <button id="restart-button" class="btn text-lg">é‡æ–°é–‹å§‹ <span title="Restart">ğŸ”„</span></button>
                </div>
            </div>
        </div>

        <div id="notebook-modal" class="modal">
            <div class="modal-content">
                <span class="modal-close-button" onclick="closeNotebook()">&times;</span>
                <h3 class="text-xl font-bold mb-4 text-gray-800">æˆ‘çš„ç­†è¨˜ <span title="Notebook">ğŸ“</span></h3>
                <ul id="clue-list" class="list-disc list-inside text-gray-700 space-y-2">
                    <li>éŠæˆ²å°šæœªé–‹å§‹æˆ–æ²’æœ‰ç·šç´¢ã€‚</li>
                </ul>
            </div>
        </div>

        <div id="settings-modal" class="modal">
            <div class="modal-content">
                <span class="modal-close-button" onclick="closeSettings()">&times;</span>
                <h3 class="text-xl font-bold mb-6 text-gray-800 text-center">éŠæˆ²è¨­å®š âš™ï¸</h3>
                <div class="settings-controls-grid">
                    <div class="settings-group">
                         <label for="settings-volume-slider">éŸ³é‡:</label>
                         <div class="control-container">
                             <input type="range" id="settings-volume-slider" min="0" max="1" step="0.1" value="0.5">
                             <button id="settings-mute-button" class="btn btn-secondary btn-small">éœéŸ³</button>
                         </div>
                     </div>
                     <div class="settings-group speed-control">
                         <label for="settings-speed-display">é€Ÿåº¦:</label>
                         <div class="control-container">
                             <button id="settings-speed-down-button" class="btn btn-secondary btn-small">-</button>
                             <span id="settings-speed-display">x1.0</span>
                             <button id="settings-speed-up-button" class="btn btn-secondary btn-small">+</button>
                         </div>
                     </div>
                     <hr class="my-2 border-gray-300 col-span-full">
                     <div class="settings-group">
                         <label for="settings-tts-voice">èªéŸ³:</label>
                         <div class="control-container">
                             <select id="settings-tts-voice" name="tts-voice"></select>
                         </div>
                     </div>
                     <div class="settings-group">
                         <label for="settings-tts-rate">èªé€Ÿ:</label>
                         <div class="control-container">
                             <input type="range" id="settings-tts-rate" min="0.5" max="2" step="0.1" value="1">
                         </div>
                     </div>
                     <div class="settings-group">
                         <label for="settings-tts-pitch">éŸ³é«˜:</label>
                         <div class="control-container">
                             <input type="range" id="settings-tts-pitch" min="0" max="2" step="0.1" value="1">
                         </div>
                     </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- DOM å…ƒç´ ç²å– ---
        const gameContainer = document.getElementById('game-container');
        const startScreen = document.getElementById('start-screen');
        const characterSelectScreen = document.getElementById('character-select-screen');
        const gameScreen = document.getElementById('game-screen');
        const endingScreen = document.getElementById('ending-screen');
        const startGameButton = document.getElementById('start-game-button');
        const characterOptionsContainer = document.getElementById('character-options');
        const chapterTitle = document.getElementById('chapter-title');
        const storyDisplay = document.getElementById('story-display');
        const choicesDisplay = document.getElementById('choices-display');
        const endingTitle = document.getElementById('ending-title');
        const endingDescription = document.getElementById('ending-description');
        const restartButton = document.getElementById('restart-button');
        const playerAvatarGame = document.getElementById('player-avatar-game');
        const playerNameGame = document.getElementById('player-name-game');
        const currentObjective = document.getElementById('current-objective');
        const notebookButton = document.getElementById('notebook-button');
        const notebookModal = document.getElementById('notebook-modal');
        const clueList = document.getElementById('clue-list');
        const openSettingsButton = document.getElementById('open-settings-button');
        const settingsModal = document.getElementById('settings-modal');
        const settingsVolumeSlider = document.getElementById('settings-volume-slider');
        const settingsMuteButton = document.getElementById('settings-mute-button');
        const settingsSpeedDownButton = document.getElementById('settings-speed-down-button');
        const settingsSpeedDisplay = document.getElementById('settings-speed-display');
        const settingsSpeedUpButton = document.getElementById('settings-speed-up-button');
        const settingsTtsVoiceSelect = document.getElementById('settings-tts-voice');
        const settingsTtsRateSlider = document.getElementById('settings-tts-rate');
        const settingsTtsPitchSlider = document.getElementById('settings-tts-pitch');
        const loadGameButton = document.getElementById('load-game-button');
        const saveGameButton = document.getElementById('save-game-button');

        // --- éŠæˆ²ç‹€æ…‹è®Šæ•¸ ---
        let currentChapter = 0;
        let currentStoryNodeId = null;
        let chosenCharacter = null;
        let selectedCharacterIdTemp = null;
        let collectedClues = [];
        let gameState = {};
        let isMuted = false;
        let currentVolume = 0.5;
        let typewriterTimeout = null;
        let isAudioInitialized = false;
        let audioContextRequiresInteraction = true;
        const BASE_TYPEWRITER_SPEED = 30;
        let typewriterSpeed = BASE_TYPEWRITER_SPEED;
        const MAX_SPEED = 5;
        const MIN_SPEED = 80;
        const SPEED_STEP = 5;
        let availableVoices = [];
        let selectedVoice = null;
        let currentTtsRate = 1;
        let currentTtsPitch = 1;
        let currentUtterance = null;
        let lastSpokenText = "";
        let lastSpeakButton = null;
        let isSpeechPaused = false;
        let populateVoiceListAttempts = 0;
        let currentTimeOfDay = 'day'; // 'day' or 'night'
        const SAVE_GAME_KEY = 'mistyCampusSaveData';

        // --- éŸ³æ•ˆåˆæˆå™¨ ---
        let sfxPlayer = null;
        let synth = null;

        // --- é—œéµå­—åˆ—è¡¨ ---
        const keywords = ["ææ•™æˆ", "ç‹åŒå­¸", "é™³è­¦è¡›", "å¼µæ•™æˆ", "è¾¦å…¬å®¤", "å¯¦é©—å®¤", "åœ–æ›¸é¤¨", "åŒ–å­¸è—¥å“", "ä¾¿æ¢", "é‹¼ç­†", "å’–å•¡", "æ–‡ä»¶", "ç ”ç©¶é …ç›®", "æ•¸æ“š", "è©¦åŠ‘", "æ¯’ç‰©åŒ–å­¸", "æ¯’åŠ‘", "çœŸå…‡", "æ ¡åœ’", "ç‰©ç†ç³»", "åŒ–å­¸ç³»", "æŒ‡å°ç”Ÿ", "ä¿å…¨", "åŒäº‹", "ç«¶çˆ­å°æ‰‹", "æŒ‡å°ç”Ÿ", "ç ”ç©¶ç¶“è²»", "è«–æ–‡", "çˆ­åµ", "è­¦è¡›", "å·¡é‚", "ç¾å ´", "æ‰“é¬¥ç—•è·¡", "è—¥å“æ°£å‘³", "ç¢ç‰‡", "åˆä½œ", "çˆ­è­°", "ç“¶å­", "åˆºé¼»", "åŒ–é©—", "åœè»Šå ´", "å®¿èˆ", "ç·šç´¢", "æ¯’ç‰©", "ç¿»é–±", "æ‡·ç–‘", "å‹•æ©Ÿ", "æ ½è´“", "è‡´å‘½", "æ¬Šé™", "é€ å‡", "å¨è„…", "ç•¢æ¥­è³‡æ ¼", "å°è³ª", "å½è­‰", "åˆ¤æ–·", "æŒ‡èª", "çœŸç›¸", "æˆæœ", "å«Œç–‘", "æ¸…ç™½", "è­‰æ“š", "æ•²è©å‹’ç´¢", "æ‡¸æ¡ˆ", "æ‡²ç½°"];

        // --- éŠæˆ²è³‡æ–™ ---
        const characters = {
            profLi: {
                id: 'profLi',
                name: 'ææ•™æˆ (åŒ–å­¸ç³»)',
                // *** ä¿®æ”¹äº†é€™è£¡çš„ avatar é€£çµ ***
                avatar: 'https://t242642911.github.io/kevinboy/%E6%9D%8E%E6%95%99%E6%8E%88.png',
                description: 'è¢«å®³è€…<span class="keyword">å¼µæ•™æˆ</span>çš„<span class="keyword">åŒäº‹</span>ï¼Œä¹Ÿæ˜¯å­¸è¡“ä¸Šçš„<span class="keyword">ç«¶çˆ­å°æ‰‹</span>ã€‚å€‹æ€§æ²‰ç©©ï¼Œå­¸è¡“<span class="keyword">é‡å¿ƒ</span>å‹ƒå‹ƒï¼Œå–œå¥½å“èŒ—ğŸµã€‚è¡¨é¢å’Œå–„ï¼Œä½†æ“šèªªèˆ‡<span class="keyword">å¼µæ•™æˆ</span>åœ¨<span class="keyword">ç ”ç©¶ç¶“è²»</span>ä¸Šæœ‰éæ¿€çƒˆ<span class="keyword">çˆ­åŸ·</span>ã€‚ä»–æ˜¯å¦ç‚ºäº†<span class="keyword">ç ”ç©¶æˆæœ</span>è€Œä¸æ“‡æ‰‹æ®µï¼Ÿ',
                tags: ["æ²‰ç©©", "é‡å¿ƒå®¶", "åŒ–å­¸å°ˆå®¶", "å“èŒ—æ„›å¥½è€…"],
                startNode: 'chapter1_start_li'
            },
            studentWang: {
                id: 'studentWang',
                name: 'ç‹åŒå­¸ (ç‰©ç†ç³»)',
                // *** ä¿®æ”¹äº†é€™è£¡çš„ avatar é€£çµ ***
                avatar: 'https://t242642911.github.io/kevinboy/%E7%8E%8B%E5%90%8C%E5%AD%B8.png',
                description: '<span class="keyword">å¼µæ•™æˆ</span>æœ€çœ‹é‡çš„<span class="keyword">æŒ‡å°ç”Ÿ</span>ä¹‹ä¸€ã€‚å€‹æ€§è¡å‹•ç†±æƒ…ï¼Œç†±æ„›ç±ƒçƒğŸ€ã€‚è¿‘æœŸå› <span class="keyword">è«–æ–‡</span><span class="keyword">æ•¸æ“š</span>å•é¡Œèˆ‡æ•™æˆé—œä¿‚ç·Šå¼µã€‚æœ‰äººçœ‹åˆ°ä»–æ¡ˆç™¼å‰æ™šèˆ‡<span class="keyword">å¼µæ•™æˆ</span>å¤§è²<span class="keyword">çˆ­åµ</span>ã€‚ä»–æ˜¯å¦å› <span class="keyword">ç•¢æ¥­è³‡æ ¼</span>å—åˆ°<span class="keyword">å¨è„…</span>è€Œç—›ä¸‹æ®ºæ‰‹ï¼Ÿ',
                tags: ["è¡å‹•", "ç†±æƒ…", "ç‰©ç†ç³»å­¸ç”Ÿ", "ç±ƒçƒæ„›å¥½è€…"],
                startNode: 'chapter1_start_wang'
            },
            guardChen: {
                id: 'guardChen',
                name: 'é™³è­¦è¡› (æ ¡åœ’ä¿å…¨)',
                // *** ä¿®æ”¹äº†é€™è£¡çš„ avatar é€£çµ ***
                avatar: 'https://t242642911.github.io/kevinboy/%E8%AD%A6%E8%A1%9B.png',
                description: 'ç¬¬ä¸€å€‹ç™¼ç¾æ¡ˆ<span class="keyword">ç¾å ´</span>çš„<span class="keyword">è­¦è¡›</span>ã€‚åœ¨<span class="keyword">æ ¡åœ’</span>å·¥ä½œå¤šå¹´ï¼Œå€‹æ€§å¯¡è¨€ï¼Œå–œæ­¡ä¸‹æ£‹â™Ÿï¸ã€‚çœ‹ä¼¼å¹³å‡¡ï¼Œå»å°<span class="keyword">æ ¡åœ’</span>çš„æ¯å€‹è§’è½ç­è‹¥æŒ‡æŒï¼Œè§€å¯ŸåŠ›æ•éŠ³ã€‚ä»–æ˜¯å¦åœ¨<span class="keyword">å·¡é‚</span>æ™‚çœ‹åˆ°äº†ä»€éº¼é—œéµ<span class="keyword">ç·šç´¢</span>ï¼Œæˆ–è€…éš±è—è‘—ä¸ç‚ºäººçŸ¥çš„ç§˜å¯†ï¼Ÿ',
                tags: ["å¯¡è¨€", "è§€å¯ŸåŠ›æ•éŠ³", "è€å“¡å·¥", "ä¸‹æ£‹æ„›å¥½è€…"],
                startNode: 'chapter1_start_chen'
            }
        };
        const sceneBackgrounds = {
            start: 'https://images.unsplash.com/photo-1562774053-701939374585?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8dW5pdmVyc2l0eSUyMGNhbXB1c3xlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=1200&q=80',
            characterSelect: 'https://images.unsplash.com/photo-1507842217343-583bb7270b66?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8bGlicmFyeXxlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=1200&q=80',
            office: 'https://images.unsplash.com/photo-1485125611436-c6fea81a3599?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTB8fG1lc3N5JTIwZGVza3xlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=1200&q=80',
            lab: 'https://images.unsplash.com/photo-1576086213369-97a306d36557?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8Y2hlbWlzdHJ5JTIwbGFifGVufDB8fDB8fHww&auto=format&fit=crop&w=1200&q=80',
            library: 'https://images.unsplash.com/photo-1521587760476-6c12a4b040da?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8bGlicmFyeSUyMGJvb2tzaGVsdmVzfGVufDB8fDB8fHww&auto=format&fit=crop&w=1200&q=80',
            ending: 'https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8YWJzdHJhY3QlMjBkYXJrJTIwYmFja2dyb3VuZHxlbnwwfHwwfHx8MA%3D%3D&auto=format&fit=crop&w=1200&q=80'
        };
        const story = {
             chapter1_intro: { type: 'narration', text: (name) => `ç¬¬ä¸€ç« ï¼šä¸å¹³éœçš„æ¸…æ™¨ ğŸŒ…\n\nä½  (${name}) å’Œå¾€å¸¸ä¸€æ¨£ä¾†åˆ°å­¸æ ¡ï¼Œå»è¢«ä¸€é™£é¨·å‹•å¸å¼•ã€‚æ“šèªªï¼Œå¾·é«˜æœ›é‡çš„<span class="keyword">ç‰©ç†ç³»</span>æ•™æˆï¼Œ<span class="keyword">å¼µæ•™æˆ</span>ï¼Œè¢«ç™¼ç¾æ­»åœ¨äº†ä»–çš„<span class="keyword">è¾¦å…¬å®¤</span>è£¡... <span title="Shocked">ğŸ˜±</span>`, next: (id) => characters[id].startNode, background: sceneBackgrounds.office, objective: "èª¿æŸ¥å¼µæ•™æˆçš„æ­»å› " },
            chapter1_start_li: { type: 'dialogue', character: 'ææ•™æˆ', text: "ï¼ˆå…§å¿ƒï¼‰<span class=\"keyword\">å¼µæ•™æˆ</span>æ­»äº†ï¼Ÿé€™çœŸæ˜¯...å¤ªçªç„¶äº†ã€‚é›–ç„¶æˆ‘å€‘æ˜¯<span class=\"keyword\">ç«¶çˆ­å°æ‰‹</span>ï¼Œä½†ä»–ç•¢ç«Ÿæ˜¯å€‹å€¼å¾—å°Šæ•¬çš„å­¸è€…ã€‚æˆ‘å¾—å»çœ‹çœ‹æƒ…æ³ã€‚ğŸ¤”", next: 'chapter1_office_observe' },
            chapter1_start_wang: { type: 'dialogue', character: 'ç‹åŒå­¸', text: "ï¼ˆå…§å¿ƒï¼‰è€å¸«...æ­»äº†ï¼Ÿæ€éº¼æœƒé€™æ¨£ï¼æ˜¨å¤©æˆ‘é‚„å› ç‚º<span class=\"keyword\">è«–æ–‡</span>çš„äº‹è·Ÿä»–<span class=\"keyword\">çˆ­åµ</span>...è­¦å¯Ÿä¸æœƒ<span class=\"keyword\">æ‡·ç–‘</span>æˆ‘å§ï¼Ÿä¸è¡Œï¼Œæˆ‘è¦å†·éœã€‚ğŸ˜°", next: 'chapter1_office_observe' },
            chapter1_start_chen: { type: 'dialogue', character: 'é™³è­¦è¡›', text: "å”‰ï¼ŒçœŸå€’æ¥£ï¼Œ<span class=\"keyword\">å·¡é‚</span>çš„æ™‚å€™å°±ç™¼ç¾<span class=\"keyword\">å¼µæ•™æˆ</span><span class=\"keyword\">è¾¦å…¬å®¤</span>é–€æ²’é–ï¼Œé€²å»ä¸€çœ‹...äººå°±å€’åœ¨é‚£äº†ã€‚å ±è­¦å¾Œï¼Œç¾åœ¨é€™è£¡è¢«å°é–äº†ã€‚ğŸ‘®â€â™‚ï¸", next: 'chapter1_office_observe' },
            chapter1_office_observe: { type: 'narration', text: "ä½ ä¾†åˆ°<span class=\"keyword\">å¼µæ•™æˆ</span>çš„<span class=\"keyword\">è¾¦å…¬å®¤</span>é–€å£ï¼Œè­¦æ–¹æ­£åœ¨<span class=\"keyword\">ç¾å ´</span>å‹˜æŸ¥ã€‚è¾¦å…¬å®¤å…§ä¸€ç‰‡ç‹¼è—‰ï¼Œä¼¼ä¹æœ‰<span class=\"keyword\">æ‰“é¬¥ç—•è·¡</span>ã€‚ç©ºæ°£ä¸­ç€°æ¼«è‘—ä¸€è‚¡å¥‡æ€ªçš„<span class=\"keyword\">åŒ–å­¸è—¥å“</span>æ°£å‘³ã€‚ğŸ‘ƒ", choices: [ { text: "ä»”ç´°è§€å¯Ÿ<span class=\"keyword\">è¾¦å…¬å®¤</span>å…§éƒ¨ <span title='Eyes'>ğŸ‘€</span>", next: 'chapter1_office_detail', sfx: 'click' }, { text: "è©¢å•æ—é‚Šçš„<span class=\"keyword\">é™³è­¦è¡›</span>ï¼ˆå¦‚æœä¸æ˜¯é™³è­¦è¡›ï¼‰", next: 'chapter1_ask_guard', condition: (id) => id !== 'guardChen', sfx: 'click' }, { text: "æ‰¾æ©Ÿæœƒå•å•å…¶ä»–åœ¨å ´çš„äººï¼ˆ<span class=\"keyword\">ææ•™æˆ</span>/<span class=\"keyword\">ç‹åŒå­¸</span>ï¼‰", next: 'chapter1_ask_others', condition: (id) => id === 'guardChen', sfx: 'click' }, { text: "å…ˆé›¢é–‹<span class=\"keyword\">ç¾å ´</span>ï¼Œå»åˆ¥è™•æ‰¾<span class=\"keyword\">ç·šç´¢</span> <span title='Walk'>ğŸš¶</span>", next: 'chapter1_leave_office', sfx: 'click' } ] },
            chapter1_office_detail: { type: 'narration', text: "ä½ æ³¨æ„åˆ°åœ°ä¸Šæœ‰ä¸€å¼µæ’•ç¢çš„<span class=\"keyword\">ä¾¿æ¢</span>ğŸ“„ï¼Œé‚„æœ‰ä¸€æ”¯æ‘”å£çš„<span class=\"keyword\">é‹¼ç­†</span>âœ’ï¸ã€‚æ¡Œä¸Šæ”¾è‘—ä¸€æ¯å†·æ‰çš„<span class=\"keyword\">å’–å•¡</span>â˜•ï¸ï¼Œæ¯å£å…§ç·£ä¼¼ä¹æœ‰äº›<span class=\"keyword\">ä¸å°‹å¸¸çš„æ®˜ç•™ç‰©</span>ã€‚æ—é‚Šæ•£è½è‘—ä¸€äº›<span class=\"keyword\">æ–‡ä»¶</span>ğŸ“‘ã€‚", action: () => { addClue("è¾¦å…¬å®¤æœ‰æ‰“é¬¥ç—•è·¡ï¼Œç©ºæ°£ä¸­æœ‰åŒ–å­¸è—¥å“å‘³ã€‚"); addClue("å’–å•¡æ¯å…§ç·£æœ‰ä¸å°‹å¸¸æ®˜ç•™ç‰©ã€‚"); }, choices: [ { text: "å˜—è©¦æ‹¼æ¹Š<span class=\"keyword\">ä¾¿æ¢</span> <span title='Puzzle'>ğŸ§©</span>", next: 'chapter1_note_puzzle', sfx: 'puzzle' }, { text: "æª¢æŸ¥æ•£è½çš„<span class=\"keyword\">æ–‡ä»¶</span>", next: 'chapter1_check_files', sfx: 'click' }, { text: "å…ˆä¸ç®¡æ®˜ç•™ç‰©ï¼Œç¹¼çºŒè§€å¯Ÿå…¶ä»–åœ°æ–¹", next: 'chapter1_after_observe', sfx: 'click'} ] },
            chapter1_note_puzzle: { type: 'narration', text: "ä½ å°å¿ƒç¿¼ç¿¼åœ°æ’¿èµ·<span class=\"keyword\">ç¢ç‰‡</span>ï¼Œä¼¼ä¹å¯ä»¥æ‹¼å‡ºã€...å¯¦é©—...<span class=\"keyword\">æ•¸æ“š</span>...å°å¿ƒ<span class=\"keyword\">æ</span>...ã€çš„å­—æ¨£ã€‚", action: () => { addClue("æ’•ç¢çš„ä¾¿æ¢æåŠã€å¯¦é©—æ•¸æ“šã€å’Œã€å°å¿ƒæã€ã€‚"); updateGameState('foundNote', true); }, next: 'chapter1_after_observe' },
            chapter1_check_files: { type: 'narration', text: "<span class=\"keyword\">æ–‡ä»¶</span>å¤§å¤šæ˜¯é—œæ–¼ä¸€é …æ–°çš„ç‰©ç†<span class=\"keyword\">ç ”ç©¶é …ç›®</span>ï¼Œå…¶ä¸­ä¸€ä»½æåˆ°äº†èˆ‡<span class=\"keyword\">åŒ–å­¸ç³»</span><span class=\"keyword\">åˆä½œ</span>çš„å¯èƒ½æ€§ï¼Œä½†ä¼¼ä¹æœ‰äº›<span class=\"keyword\">çˆ­è­°</span>ã€‚", action: () => addClue("å¼µæ•™æˆçš„ç ”ç©¶é …ç›®å¯èƒ½èˆ‡åŒ–å­¸ç³»æœ‰åˆä½œçˆ­è­°ã€‚"), next: 'chapter1_after_observe' },
            chapter1_ask_guard: { type: 'dialogue', character: 'é™³è­¦è¡›', text: "å”‰ï¼Œæˆ‘æ—©ä¸Š<span class=\"keyword\">å·¡é‚</span>ç™¼ç¾çš„ã€‚é–€æ²’é–ï¼Œé€²å»å°±çœ‹åˆ°<span class=\"keyword\">å¼µæ•™æˆ</span>å€’åœ¨åœ°ä¸Šï¼Œæ—é‚Šé‚„æœ‰å€‹æ‰“ç¿»çš„<span class=\"keyword\">åŒ–å­¸å“</span><span class=\"keyword\">ç“¶å­</span>...å‘³é“å¾ˆ<span class=\"keyword\">åˆºé¼»</span>ã€‚æˆ‘é¦¬ä¸Šå°±å ±è­¦äº†ã€‚", action: () => addClue("é™³è­¦è¡›èªªç™¼ç¾æ™‚é–€æ²’é–ï¼Œæ—é‚Šæœ‰æ‰“ç¿»çš„åŒ–å­¸å“ã€‚"), choices: [ { text: "è¿½å•<span class=\"keyword\">åŒ–å­¸å“</span>æ˜¯ä»€éº¼", next: 'chapter1_ask_guard_chem', sfx: 'click' }, { text: "è©¢å•æ˜¯å¦æœ‰å¯ç–‘äººå£«å‡ºæ²’", next: 'chapter1_ask_guard_suspect', sfx: 'click' } ] },
            chapter1_ask_guard_chem: { type: 'dialogue', character: 'é™³è­¦è¡›', text: "æˆ‘å“ªæ‡‚é‚£äº›å•Šï¼Œèèµ·ä¾†æœ‰é»åƒ...æ¸…æ½”åŠ‘ï¼Ÿä½†åˆä¸å¤ªä¸€æ¨£ã€‚è­¦å¯Ÿå·²ç¶“æ‹¿å»<span class=\"keyword\">åŒ–é©—</span>äº†ã€‚", next: 'chapter1_after_observe' },
            chapter1_ask_guard_suspect: { type: 'dialogue', character: 'é™³è­¦è¡›', text: "æ˜¨æ™šä¸‹ç­å¾Œå°±æ²’çœ‹åˆ°ä»€éº¼ç‰¹åˆ¥çš„äººäº†...ä¸éï¼Œå¥½åƒçœ‹åˆ°<span class=\"keyword\">ææ•™æˆ</span>çš„è»Šæ¯”è¼ƒæ™šæ‰é›¢é–‹<span class=\"keyword\">åœè»Šå ´</span>ã€‚ğŸš— é‚„æœ‰...å·¡é‚åˆ°é€™é™„è¿‘æ™‚ï¼Œå¥½åƒçœ‹åˆ°å€‹äººå½±åŒ†åŒ†é›¢é–‹<span class=\"keyword\">è¾¦å…¬å®¤</span>æ–¹å‘...å¤©è‰²æš—ï¼Œæ²’çœ‹æ¸…æ˜¯èª°ï¼Œä½†æ„Ÿè¦ºæœ‰é»åƒ...å”‰ï¼Œä¹Ÿè¨±æ˜¯æˆ‘çœ¼èŠ±ã€‚", action: () => { addClue("é™³è­¦è¡›çœ‹åˆ°ææ•™æˆæ™šé›¢é–‹ï¼Œä¸”æ¨¡ç³Šçœ‹åˆ°äººå½±é›¢é–‹è¾¦å…¬å®¤é™„è¿‘ã€‚"); updateGameState('guardSawLiLate', true); updateGameState('guardSawFigure', true); }, next: 'chapter1_after_observe' },
            chapter1_ask_others: { type: 'narration', text: "ä½ çœ‹åˆ°<span class=\"keyword\">ææ•™æˆ</span>å’Œ<span class=\"keyword\">ç‹åŒå­¸</span>ä¹Ÿåœ¨é™„è¿‘ï¼Œè‡‰è‰²éƒ½ä¸å¤ªå¥½ã€‚", choices: [ { text: "è©¢å•<span class=\"keyword\">ææ•™æˆ</span>", next: 'chapter1_ask_li_by_guard', sfx: 'click' }, { text: "è©¢å•<span class=\"keyword\">ç‹åŒå­¸</span>", next: 'chapter1_ask_wang_by_guard', sfx: 'click' } ] },
            chapter1_ask_li_by_guard: { type: 'dialogue', character: 'ææ•™æˆ', text: "ï¼ˆè­¦è¡›å…ˆç”Ÿï¼‰çœŸæ˜¯å¤ªä¸å¹¸äº†ã€‚æˆ‘å’Œ<span class=\"keyword\">å¼µæ•™æˆ</span>é›–ç„¶æœ‰äº›å­¸è¡“ä¸Šçš„åˆ†æ­§ï¼Œä½†çµ•ä¸è‡³æ–¼...å”‰ã€‚æˆ‘æ˜¨æ™šè™•ç†å¯¦é©—åˆ°æ¯”è¼ƒæ™šï¼Œé›¢é–‹æ™‚æ²’æ³¨æ„åˆ°ä»€éº¼ç•°å¸¸ã€‚", next: 'chapter1_after_observe' },
            chapter1_ask_wang_by_guard: { type: 'dialogue', character: 'ç‹åŒå­¸', text: "ï¼ˆè­¦è¡›å¤§å“¥ï¼‰æˆ‘...æˆ‘ä¸çŸ¥é“...æˆ‘æ˜¨æ™šæ˜¯å’Œè€å¸«æœ‰äº›<span class=\"keyword\">çˆ­åŸ·</span>ï¼Œä½†æˆ‘çœŸçš„æ²’åšä»€éº¼ï¼æˆ‘å¾Œä¾†å°±æ°£æ²–æ²–å›<span class=\"keyword\">å®¿èˆ</span>äº†ï¼", action: () => updateGameState('wangAdmitsArgue', true), next: 'chapter1_after_observe' },
            chapter1_leave_office: { type: 'narration', text: "ä½ æ±ºå®šæš«æ™‚é›¢é–‹<span class=\"keyword\">è¾¦å…¬å®¤</span>ï¼Œä¹Ÿè¨±å¯ä»¥å¾å…¶ä»–åœ°æ–¹æ‰¾åˆ°<span class=\"keyword\">ç·šç´¢</span>ã€‚<span class=\"keyword\">æ ¡åœ’</span>è£¡è­°è«–ç´›ç´›ã€‚", choices: [ { text: "å‰å¾€åŒ–å­¸<span class=\"keyword\">å¯¦é©—å®¤</span>çœ‹çœ‹ <span title='Lab'>ğŸ§ª</span>", next: 'chapter1_goto_lab', background: sceneBackgrounds.lab, sfx: 'travel' }, { text: "å»<span class=\"keyword\">åœ–æ›¸é¤¨</span>æŸ¥è³‡æ–™ <span title='Library'>ğŸ“š</span>", next: 'chapter1_goto_library', background: sceneBackgrounds.library, sfx: 'travel' } ] },
            chapter1_after_observe: { type: 'narration', text: "<span class=\"keyword\">ç¾å ´</span>èƒ½çœ‹åˆ°çš„<span class=\"keyword\">ç·šç´¢</span>ä¼¼ä¹æœ‰é™ï¼Œä½ æ€è€ƒè‘—ä¸‹ä¸€æ­¥è©²æ€éº¼åšã€‚ğŸ¤”", choices: [ { text: "å†æ¬¡ä»”ç´°è§€å¯Ÿ<span class=\"keyword\">è¾¦å…¬å®¤</span> <span title='Eyes'>ğŸ‘€</span>", next: 'chapter1_office_detail', condition: () => !hasClue("å’–å•¡æ¯å…§ç·£æœ‰ä¸å°‹å¸¸æ®˜ç•™ç‰©ã€‚"), sfx: 'click' }, { text: "è©¢å•å…¶ä»–äººï¼ˆå¦‚æœé‚„æ²’å•ï¼‰", next: 'chapter1_ask_guard', condition: (id) => id !== 'guardChen' && !hasClue("é™³è­¦è¡›çœ‹åˆ°ææ•™æˆæ™šé›¢é–‹"), sfx: 'click' }, { text: "è©¢å•å…¶ä»–äººï¼ˆå¦‚æœé‚„æ²’å•ï¼‰", next: 'chapter1_ask_others', condition: (id) => id === 'guardChen' && !gameState.wangAdmitsArgue && !gameState.guardSawLiLate, sfx: 'click' }, { text: "é›¢é–‹<span class=\"keyword\">è¾¦å…¬å®¤</span>ï¼Œå»åˆ¥è™• <span title='Walk'>ğŸš¶</span>", next: 'chapter1_leave_office', sfx: 'click' } ] },
            chapter1_goto_lab: { type: 'narration', text: "åŒ–å­¸<span class=\"keyword\">å¯¦é©—å®¤</span>ç€°æ¼«è‘—å„ç¨®<span class=\"keyword\">è—¥å“</span>çš„å‘³é“ã€‚ä½ æ³¨æ„åˆ°ä¸€å€‹æ¨™ç¤ºè‘—ç‰¹æ®Šç¬¦è™Ÿçš„<span class=\"keyword\">è©¦åŠ‘</span>æ«ƒä¼¼ä¹ä¸å¤ªå°å‹ï¼Œå¥½åƒå°‘äº†ä¸€ç“¶ï¼Ÿ", action: () => addClue("åŒ–å­¸å¯¦é©—å®¤çš„ç‰¹æ®Šè©¦åŠ‘æ«ƒå¯èƒ½å°‘äº†ä¸€ç“¶è©¦åŠ‘ã€‚"), next: 'chapter1_end_choice' },
            chapter1_goto_library: { type: 'narration', text: "<span class=\"keyword\">åœ–æ›¸é¤¨</span>å¾ˆå®‰éœã€‚ä½ åœ¨ç‰©ç†å­¸å€çš„æ›¸æ¶ä¸Šç™¼ç¾ä¸€æœ¬é—œæ–¼ã€<span class=\"keyword\">æ¯’ç‰©</span>åŒ–å­¸ã€çš„æ›¸æœ‰è¢«<span class=\"keyword\">ç¿»é–±</span>éçš„ç—•è·¡ï¼Œæ›¸é é–“ä¼¼ä¹å¤¾è‘—ä¸€å¼µæ¨¡ç³Šçš„<span class=\"keyword\">å¯¦é©—å®¤</span>å€Ÿç”¨å–®ã€‚", action: () => {addClue("åœ–æ›¸é¤¨è£¡ä¸€æœ¬ã€æ¯’ç‰©åŒ–å­¸ã€çš„æ›¸è¢«ç¿»é–±éã€‚"); addClue("æ¯’ç‰©åŒ–å­¸æ›¸ä¸­å¤¾æœ‰æ¨¡ç³Šçš„å¯¦é©—å®¤å€Ÿç”¨å–®ã€‚"); updateGameState('foundBorrowSlip', true);}, next: 'chapter1_end_choice' },
            chapter1_end_choice: { type: 'narration', text: "ç¬¬ä¸€å¤©çš„èª¿æŸ¥æš«å‘Šä¸€æ®µè½ï¼Œä½ æ•´ç†äº†ä¸€ä¸‹æ€ç·’ï¼Œè¦ºå¾—æœ‰äº›å¯ç–‘ä¹‹è™•ã€‚", choices: [ { text: "æ„Ÿè¦º<span class=\"keyword\">ææ•™æˆ</span>å¾ˆ<span class=\"keyword\">å¯ç–‘</span>", next: 'end_chapter1', action: () => updateGameState('suspect', 'profLi'), sfx: 'decision' }, { text: "æ„Ÿè¦º<span class=\"keyword\">ç‹åŒå­¸</span>å¾ˆ<span class=\"keyword\">å¯ç–‘</span>", next: 'end_chapter1', action: () => updateGameState('suspect', 'studentWang'), sfx: 'decision' }, { text: "æ„Ÿè¦º<span class=\"keyword\">é™³è­¦è¡›</span>çš„è­‰è©æœ‰äº›å¥‡æ€ª", next: 'end_chapter1', action: () => updateGameState('suspect', 'guardChen'), sfx: 'decision' }, { text: "ç›®å‰<span class=\"keyword\">ç·šç´¢</span>é‚„ä¸æ˜æœ—", next: 'end_chapter1', action: () => updateGameState('suspect', 'unknown'), sfx: 'decision' } ] },
            end_chapter1: {
                type: 'narration',
                text: "å¤œå¹•é™è‡¨ ğŸŒƒï¼Œ<span class=\"keyword\">æ ¡åœ’</span>æš«æ™‚æ¢å¾©äº†å¹³éœï¼Œä½†ä½ çŸ¥é“ï¼Œ<span class=\"keyword\">çœŸç›¸</span>é‚„é æœªæ­é–‹...ï¼ˆç¬¬ä¸€ç« çµæŸï¼‰",
                action: () => {
                    currentChapter = 2;
                    currentTimeOfDay = 'night';
                    console.log("æ™‚é–“æ¨é€²åˆ°å¤œæ™š");
                },
                next: 'chapter2_intro',
                background: sceneBackgrounds.start
            },
            chapter2_intro: {
                type: 'narration',
                text: (name) => `ç¬¬äºŒç« ï¼šæ·±å…¥è¿·éœ§ ğŸŒ«ï¸\n\n<ins>å¤œè‰²</ins>ä¸­ï¼Œè­¦æ–¹ä»åœ¨èª¿æŸ¥ï¼Œä½†é€²å±•ç·©æ…¢ã€‚ä½  (${name}) æ±ºå®šæ ¹æ“šæ˜¨å¤©çš„ç™¼ç¾ï¼Œåœ¨å¤œè‰²ä¸­é€²è¡Œæ›´æ·±å…¥çš„è¿½æŸ¥ã€‚`, // ä¿®æ”¹æ–‡æœ¬
                next: 'chapter2_start',
                background: sceneBackgrounds.office,
                objective: "æ‰¾å‡ºé—œéµè­‰æ“šï¼Œé–å®šçœŸå…‡"
            },
            // ... (ç¬¬äºŒç« åŠä¹‹å¾Œçš„åŠ‡æƒ…ç¯€é»ä¿æŒä¸è®Š) ...
            chapter2_start: { type: 'narration', text: "ä½ å›æƒ³èµ·æ˜¨å¤©æ”¶é›†åˆ°çš„<span class=\"keyword\">ç·šç´¢</span>å’Œ<span class=\"keyword\">æ‡·ç–‘</span>å°è±¡ã€‚", choices: [                { text: "é‡æ–°å¯©è¦–æ’•ç¢çš„<span class=\"keyword\">ä¾¿æ¢</span> ('å°å¿ƒæ')", next: 'chapter2_revisit_note', condition: () => gameState.foundNote, sfx: 'click' },                { text: "èª¿æŸ¥<span class=\"keyword\">åŒ–å­¸å“</span>èˆ‡<span class=\"keyword\">å’–å•¡</span>æ®˜ç•™ç‰©", next: 'chapter2_investigate_chem_coffee', condition: () => hasClue("åŒ–å­¸å¯¦é©—å®¤çš„ç‰¹æ®Šè©¦åŠ‘æ«ƒå¯èƒ½å°‘äº†ä¸€ç“¶è©¦åŠ‘") || hasClue("å’–å•¡æ¯å…§ç·£æœ‰ä¸å°‹å¸¸æ®˜ç•™ç‰©"), sfx: 'click'},                { text: "è¿½æŸ¥<span class=\"keyword\">ç‹åŒå­¸</span>çš„<span class=\"keyword\">çˆ­åµ</span>åŸå› ", next: 'chapter2_investigate_wang', condition: () => gameState.wangAdmitsArgue || (chosenCharacter && chosenCharacter.id === 'studentWang'), sfx: 'click' },                { text: "èª¿æŸ¥<span class=\"keyword\">åœ–æ›¸é¤¨</span>çš„å€Ÿç”¨å–®", next: 'chapter2_investigate_slip', condition: () => gameState.foundBorrowSlip, sfx: 'click'},                { text: "å†æ¬¡èˆ‡å«Œç–‘äºº<span class=\"keyword\">å°è³ª</span> ğŸ—£ï¸", next: 'chapter2_confront', sfx: 'click' } ] },
            chapter2_revisit_note: { type: 'narration', text: "ã€å°å¿ƒæ...ã€é€™å¥è©±ä¸€ç›´ç¸ˆç¹åœ¨ä½ å¿ƒé ­ã€‚<span class=\"keyword\">ææ•™æˆ</span>ç¢ºå¯¦æœ‰<span class=\"keyword\">å‹•æ©Ÿ</span>ï¼Œä½†é€™æ˜¯å¦å¤ªéæ˜é¡¯ï¼Ÿä¹Ÿè¨±æ˜¯æ•…æ„ç•™ä¸‹ä¾†<span class=\"keyword\">æ ½è´“</span>ä»–äººçš„ï¼Ÿ", action: () => addClue("æ€è€ƒï¼šä¾¿æ¢å¯èƒ½æ˜¯æ ½è´“ã€‚"), next: 'chapter2_confront' },
            chapter2_investigate_chem_coffee: { type: 'narration', text: "ä½ è¨­æ³•äº†è§£åˆ°ï¼Œ<span class=\"keyword\">å’–å•¡</span>æ¯çš„æ®˜ç•™ç‰©èˆ‡<span class=\"keyword\">å¯¦é©—å®¤</span>å¤±è¹¤çš„<span class=\"keyword\">è©¦åŠ‘</span>æˆåˆ†å»åˆï¼Œæ˜¯ä¸€ç¨®ç½•è¦‹ä½†<span class=\"keyword\">è‡´å‘½</span>çš„<span class=\"keyword\">æ¯’åŠ‘</span> <span title='Skull'>â˜ ï¸</span>ã€‚é€™ç¨®<span class=\"keyword\">è©¦åŠ‘</span>ç”±<span class=\"keyword\">åŒ–å­¸ç³»</span>çš„<span class=\"keyword\">ææ•™æˆ</span>è² è²¬ç®¡ç†ã€‚", action: () => { addClue("ç¢ºèªå’–å•¡æ®˜ç•™ç‰©èˆ‡å¯¦é©—å®¤å¤±è¹¤æ¯’åŠ‘å»åˆã€‚"); addClue("è©²æ¯’åŠ‘ç”±ææ•™æˆç®¡ç†ã€‚"); updateGameState('chemLinkedToLi', true); updateGameState('poisonInCoffee', true); }, next: 'chapter2_confront' },
            chapter2_investigate_wang: { type: 'narration', text: "ä½ æ‰“è½åˆ°ï¼Œ<span class=\"keyword\">ç‹åŒå­¸</span>èˆ‡<span class=\"keyword\">å¼µæ•™æˆ</span>çš„<span class=\"keyword\">çˆ­åµ</span>æ˜¯å› ç‚º<span class=\"keyword\">ç ”ç©¶</span><span class=\"keyword\">æ•¸æ“š</span>è¢«è³ªç–‘<span class=\"keyword\">é€ å‡</span>ï¼Œ<span class=\"keyword\">å¼µæ•™æˆ</span>å¨è„…è¦å–æ¶ˆä»–çš„<span class=\"keyword\">ç•¢æ¥­è³‡æ ¼</span>ã€‚é€™å°ä»–ä¾†èªªç„¡ç–‘æ˜¯å·¨å¤§çš„æ‰“æ“Šã€‚", action: () => { addClue("ç‹åŒå­¸å› æ•¸æ“šé€ å‡è¢«å¨è„…å–æ¶ˆç•¢æ¥­è³‡æ ¼ï¼Œæœ‰å¼·çƒˆæ®ºäººå‹•æ©Ÿã€‚"); updateGameState('wangMotiveConfirmed', true); }, next: 'chapter2_confront' },
            chapter2_investigate_slip: { type: 'narration', text: "è²»äº†äº›åŠŸå¤«ï¼Œä½ å¼„æ¸…æ¥šäº†é‚£å¼µæ¨¡ç³Šçš„å€Ÿç”¨å–®...ä¸Šé¢çš„åå­—ä¼¼ä¹æ˜¯... <span class=\"keyword\">ç‹åŒå­¸</span>ï¼Ÿå€Ÿç”¨æ—¥æœŸå°±åœ¨æ¡ˆç™¼å‰ä¸€å¤©ã€‚ä½†ä»–å€Ÿç”¨çš„ä¼¼ä¹æ˜¯å¸¸è¦<span class=\"keyword\">å¯¦é©—å®¤</span>ï¼Œè€Œéå­˜æ”¾ç‰¹æ®Š<span class=\"keyword\">è©¦åŠ‘</span>çš„åœ°æ–¹ã€‚", action: () => { addClue("åœ–æ›¸é¤¨å€Ÿç”¨å–®é¡¯ç¤ºç‹åŒå­¸æ¡ˆç™¼å‰å€Ÿç”¨éå¸¸è¦å¯¦é©—å®¤ã€‚"); updateGameState('wangBorrowedLab', true); }, next: 'chapter2_confront'},
            chapter2_confront: { type: 'narration', text: "ä½ æ±ºå®šç›´æ¥æ‰¾ä½ <span class=\"keyword\">æ‡·ç–‘</span>çš„äººè«‡è«‡ã€‚", choices: [ { text: () => `èˆ‡<span class="keyword">ææ•™æˆ</span><span class=\"keyword\">å°è³ª</span>`, next: 'chapter2_confront_li', condition: () => gameState.suspect === 'profLi' || (chosenCharacter && chosenCharacter.id !== 'profLi'), sfx: 'confront' }, { text: () => `èˆ‡<span class="keyword">ç‹åŒå­¸</span><span class=\"keyword\">å°è³ª</span>`, next: 'chapter2_confront_wang', condition: () => gameState.suspect === 'studentWang' || (chosenCharacter && chosenCharacter.id !== 'studentWang'), sfx: 'confront' }, { text: () => `èˆ‡<span class="keyword">é™³è­¦è¡›</span><span class=\"keyword\">å°è³ª</span>`, next: 'chapter2_confront_guard', condition: () => gameState.suspect === 'guardChen' || (chosenCharacter && chosenCharacter.id !== 'guardChen'), sfx: 'confront' }, { text: "å†æ€è€ƒä¸€ä¸‹ ğŸ¤”", next: 'chapter2_final_decision', sfx: 'click'} ] },
            chapter2_confront_li: { type: 'dialogue', character: 'ææ•™æˆ', text: "ä½ <span class=\"keyword\">æ‡·ç–‘</span>æˆ‘ï¼Ÿ<span class=\"keyword\">ä¾¿æ¢</span>ï¼Ÿé‚£ä¸€å®šæ˜¯<span class=\"keyword\">æ ½è´“</span>ï¼<span class=\"keyword\">åŒ–å­¸å“</span>ï¼Ÿ<span class=\"keyword\">å¯¦é©—å®¤</span>ç®¡ç†æ··äº‚ï¼Œèª°éƒ½æœ‰å¯èƒ½æ‹¿åˆ°ï¼è‡³æ–¼<span class=\"keyword\">å’–å•¡</span>ï¼Ÿ<span class=\"keyword\">å¼µæ•™æˆ</span>è‡ªå·±æ³¡çš„å§ï¼Œæˆ‘æ€éº¼æœƒçŸ¥é“è£¡é¢æœ‰ä»€éº¼ï¼åˆ¥èƒ¡äº‚çŒœæ¸¬ï¼", next: 'chapter2_final_decision' },
            chapter2_confront_wang: { type: 'dialogue', character: 'ç‹åŒå­¸', text: "æ˜¯ï¼Œæˆ‘æ¨è€å¸«<span class=\"keyword\">å¨è„…</span>æˆ‘ï¼ä½†æˆ‘ç•¶æ™‚æ°£æ²–æ²–åœ°èµ°äº† <span title='Angry'>ğŸ˜ </span>ï¼Œæˆ‘æ€éº¼å¯èƒ½...æˆ‘æ²’æœ‰æ®ºäººï¼çœŸçš„ï¼å€Ÿç”¨<span class=\"keyword\">å¯¦é©—å®¤</span>ï¼Ÿé‚£æ˜¯ç‚ºäº†è£œåšä¹‹å‰çš„å¯¦é©—ï¼è·Ÿé€™äº‹æ²’é—œä¿‚ï¼", action: () => updateGameState('wangDenies', true), next: 'chapter2_final_decision' },
            chapter2_confront_guard: { type: 'dialogue', character: 'é™³è­¦è¡›', text: "æˆ‘ï¼Ÿæˆ‘åªæ˜¯å€‹<span class=\"keyword\">è­¦è¡›</span>å•Šã€‚æˆ‘åªæ˜¯ç¬¬ä¸€å€‹ç™¼ç¾çš„...çœ‹åˆ°äººå½±ï¼Ÿå”‰ï¼Œå¯èƒ½æ˜¯æˆ‘è€çœ¼æ˜èŠ±çœ‹éŒ¯äº†ï¼Œ<span class=\"keyword\">ç¾å ´</span>é‚£éº¼äº‚ï¼Œæˆ‘ä¹Ÿå¾ˆç·Šå¼µã€‚æˆ‘å¯ä¸æƒ³æƒ¹éº»ç…©ã€‚", action: () => { addClue("é™³è­¦è¡›å°ç›®æ“Šäººå½±çš„èªªæ³•å«ç³Šå…¶è¾­ï¼Œä¼¼ä¹æƒ³æ’‡æ¸…é—œä¿‚ã€‚"); updateGameState('guardEvasive', true); }, next: 'chapter2_final_decision' },
            chapter2_final_decision: { type: 'narration', text: "æ‰€æœ‰çš„<span class=\"keyword\">ç·šç´¢</span>ä¼¼ä¹éƒ½æŒ‡å‘äº†æŸå€‹äººï¼Œä½†ä¹Ÿå­˜åœ¨çŸ›ç›¾ã€‚ç¾åœ¨ï¼Œæ˜¯ä½ åšå‡ºæœ€çµ‚<span class=\"keyword\">åˆ¤æ–·</span>çš„æ™‚å€™äº†ã€‚", choices: [ { text: "<span class=\"keyword\">æŒ‡èª</span><span class=\"keyword\">çœŸå…‡</span>æ˜¯ <span class=\"keyword\">ææ•™æˆ</span>", next: 'ending_accuse_li', sfx: 'decision_final' }, { text: "<span class=\"keyword\">æŒ‡èª</span><span class=\"keyword\">çœŸå…‡</span>æ˜¯ <span class=\"keyword\">ç‹åŒå­¸</span>", next: 'ending_accuse_wang', sfx: 'decision_final' }, { text: "<span class=\"keyword\">æŒ‡èª</span><span class=\"keyword\">çœŸå…‡</span>æ˜¯ <span class=\"keyword\">é™³è­¦è¡›</span>", next: 'ending_accuse_guard', sfx: 'decision_final' }, { text: "<span class=\"keyword\">ç·šç´¢</span>ä¸è¶³ï¼Œç„¡æ³•ç¢ºå®š", next: 'ending_unsolved', sfx: 'decision_final' } ] },
            ending_accuse_li: { type: 'ending', title: "çœŸç›¸å¤§ç™½ <span title='Trophy'>ğŸ†</span>", description: "ä½ æˆåŠŸ<span class=\"keyword\">æŒ‡èª</span>äº†<span class=\"keyword\">ææ•™æˆ</span>ã€‚è­¦æ–¹æ·±å…¥èª¿æŸ¥å¾Œç™¼ç¾ï¼Œ<span class=\"keyword\">ææ•™æˆ</span>ç‚ºäº†ç«Šå–<span class=\"keyword\">å¼µæ•™æˆ</span>çš„<span class=\"keyword\">ç ”ç©¶</span><span class=\"keyword\">æˆæœ</span>ä¸¦æƒé™¤<span class=\"keyword\">ç«¶çˆ­å°æ‰‹</span>ï¼Œåˆ©ç”¨ç®¡ç†<span class=\"keyword\">è©¦åŠ‘</span>çš„<span class=\"keyword\">æ¬Šé™</span>ç²å–<span class=\"keyword\">æ¯’åŠ‘</span>ï¼Œå¾ˆå¯èƒ½é å…ˆå°‡å…¶ä¸‹åœ¨<span class=\"keyword\">å¼µæ•™æˆ</span>å¸¸å–çš„<span class=\"keyword\">å’–å•¡</span>ä¸­ã€‚æ’•ç¢çš„<span class=\"keyword\">ä¾¿æ¢</span>æ˜¯ä»–æ•…æ„ç•™ä¸‹ï¼Œè©¦åœ–å°‡<span class=\"keyword\">å«Œç–‘</span>å¼•å‘è‡ªå·±å†è¾¯è§£ï¼Œæ··æ·†è¦–è½ã€‚", outcome: 'success', background: sceneBackgrounds.ending },
            ending_accuse_wang: { type: 'ending', title: "éŒ¯å¤±çœŸå…‡ <span title='Sad'>ğŸ˜¥</span>", description: "ä½ <span class=\"keyword\">æŒ‡èª</span>äº†<span class=\"keyword\">ç‹åŒå­¸</span>ã€‚é›–ç„¶ä»–ç¢ºå¯¦æœ‰å¼·çƒˆ<span class=\"keyword\">å‹•æ©Ÿ</span>ä¸”èˆ‡æ•™æˆ<span class=\"keyword\">çˆ­åµ</span>ï¼Œç”šè‡³æ¡ˆç™¼å‰å€Ÿç”¨äº†<span class=\"keyword\">å¯¦é©—å®¤</span>ï¼Œä½†è­¦æ–¹æœ€çµ‚ç¢ºèª<span class=\"keyword\">å’–å•¡</span>ä¸­çš„<span class=\"keyword\">æ¯’åŠ‘</span>ä¾†æºæŒ‡å‘<span class=\"keyword\">ææ•™æˆ</span>ã€‚<span class=\"keyword\">çœŸå…‡</span><span class=\"keyword\">ææ•™æˆ</span>å»å› ç‚ºä½ çš„èª¤åˆ¤è€Œé€é™æ³•å¤–ã€‚", outcome: 'fail_wang', background: sceneBackgrounds.ending },
            ending_accuse_guard: { type: 'ending', title: "åˆ¤æ–·å¤±èª¤ <span title='Facepalm'>ğŸ¤¦</span>", description: "ä½ <span class=\"keyword\">æŒ‡èª</span>äº†<span class=\"keyword\">é™³è­¦è¡›</span>ã€‚é›–ç„¶ä»–çš„è­‰è©å‰å¾Œæœ‰äº›æ¨¡ç³Šï¼Œä½†ä»–ä¸¦æ²’æœ‰æ¥è§¸<span class=\"keyword\">æ¯’åŠ‘</span>çš„æ©Ÿæœƒå’Œæ®ºäººçš„<span class=\"keyword\">å‹•æ©Ÿ</span>ã€‚è­¦æ–¹æ’é™¤äº†ä»–çš„<span class=\"keyword\">å«Œç–‘</span>ï¼Œ<span class=\"keyword\">çœŸå…‡</span><span class=\"keyword\">ææ•™æˆ</span>å¾—ä»¥é€ƒè„«ã€‚", outcome: 'fail_guard', background: sceneBackgrounds.ending },
            ending_unsolved: { type: 'ending', title: "æ‡¸æ¡ˆæœªæ±º <span title='Question'>â“</span>", description: "ç”±æ–¼é—œéµ<span class=\"keyword\">ç·šç´¢</span>ä¸è¶³æˆ–è¢«èª¤å°ï¼Œä½ æœªèƒ½æ‰¾å‡º<span class=\"keyword\">çœŸå…‡</span>ã€‚<span class=\"keyword\">å¼µæ•™æˆ</span>çš„æ­»æˆäº†ä¸€æ¨<span class=\"keyword\">æ‡¸æ¡ˆ</span>ï¼Œ<span class=\"keyword\">çœŸå…‡</span>éš±è—åœ¨è¿·éœ§ä¹‹ä¸­ï¼Œæœªèƒ½å¾—åˆ°æ‡‰æœ‰çš„<span class=\"keyword\">æ‡²ç½°</span>ã€‚", outcome: 'unsolved', background: sceneBackgrounds.ending }
        };

        // --- å‡½æ•¸ ---

        // æ ¹æ“šæ™‚é–“æ›´æ–°è¦–è¦ºæ•ˆæœçš„å‡½æ•¸
        function updateVisualsBasedOnTime() {
            const gameScreenElement = document.getElementById('game-screen');
            if (!gameScreenElement) return;

            const existingOverlay = gameScreenElement.querySelector('.time-overlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }

            if (currentTimeOfDay === 'night') {
                const overlay = document.createElement('div');
                overlay.className = 'time-overlay';
                overlay.style.cssText = `
                    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                    background-color: rgba(0, 0, 15, 0.35); /* ç¨å¾®åè—çš„æš—è‰² */
                    z-index: 1; pointer-events: none;
                    transition: background-color 0.8s ease-in-out;
                `;
                gameScreenElement.appendChild(overlay);
                 console.log("æ‡‰ç”¨å¤œæ™šé®ç½©");
            } else {
                 console.log("ç›®å‰æ˜¯ç™½å¤©ï¼Œç§»é™¤é®ç½©");
            }
        }


        function showScreen(screenId) {
            startScreen.classList.add('hidden');
            characterSelectScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
            endingScreen.classList.add('hidden');

            const screenToShow = document.getElementById(screenId);
            if (screenToShow) {
                screenToShow.classList.remove('hidden');

                let bgKey = screenId.replace('-screen', '');
                let backgroundUrl = sceneBackgrounds[bgKey];

                if (screenId === 'game-screen' && currentStoryNodeId && story[currentStoryNodeId] && story[currentStoryNodeId].background) {
                    backgroundUrl = story[currentStoryNodeId].background;
                }

                if (backgroundUrl) {
                    const tempDiv = document.createElement('div');
                    tempDiv.style.cssText = `background-image: url('${backgroundUrl}'); background-size: cover; background-position: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; transition: opacity 0.5s ease-in-out; z-index: -1;`;
                    document.body.appendChild(tempDiv);
                    const img = new Image();
                    img.onload = () => {
                        screenToShow.style.backgroundImage = `url('${backgroundUrl}')`;
                        screenToShow.style.backgroundSize = 'cover';
                        screenToShow.style.backgroundPosition = 'center';
                        const oldTemp = document.querySelector('.temp-bg');
                        if(oldTemp) oldTemp.remove();
                        setTimeout(() => tempDiv.style.opacity = '1', 50);
                        tempDiv.classList.add('temp-bg');
                        setTimeout(() => { if (tempDiv.parentElement) tempDiv.remove(); }, 600);
                    };
                    img.onerror = () => {
                        console.error(`ç„¡æ³•è¼‰å…¥èƒŒæ™¯åœ–ç‰‡: ${backgroundUrl}`);
                        if (tempDiv.parentElement) tempDiv.remove();
                    }
                    img.src = backgroundUrl;
                }

                 if (screenId === 'game-screen') {
                     updateVisualsBasedOnTime();
                 } else {
                      const gameScreenElement = document.getElementById('game-screen');
                      const existingOverlay = gameScreenElement?.querySelector('.time-overlay');
                      if (existingOverlay) existingOverlay.remove();
                 }

            } else {
                console.error("ç•«é¢æœªæ‰¾åˆ°:", screenId);
            }
            syncAudioControls();
            updateSpeedDisplay();
        }

        function populateCharacterSelection() {
            characterOptionsContainer.innerHTML = '';
            selectedCharacterIdTemp = null;
            currentTimeOfDay = 'day'; // é‡ç½®æ™‚é–“
            for (const charId in characters) {
                const char = characters[charId];
                const card = document.createElement('div');
                card.className = 'character-card';
                card.dataset.charId = charId;
                let tagsHTML = '';
                if (char.tags && char.tags.length > 0) {
                    tagsHTML = char.tags.map(tag => `<span class="keyword-tag-box">${highlightKeywords(tag, false)}</span>`).join('');
                }
                card.innerHTML = `
                    <div class="character-image-container">
                        <img src="${char.avatar}" alt="${char.name} é ­åƒ" onerror="this.onerror=null; this.src='https://placehold.co/160x200/cccccc/ffffff?text=Image+Not+Found';">
                    </div>
                    <div class="character-info-container">
                        <h3>${highlightKeywords(char.name)}</h3>
                        <p class="character-description">${highlightKeywords(char.description)}</p>
                        <div class="character-tags">${tagsHTML}</div>
                        <button class="btn btn-select-char">é¸æ“‡æ­¤è§’è‰²</button>
                    </div>`;
                const selectButton = card.querySelector('.btn-select-char');
                if(selectButton) {
                    selectButton.onclick = (event) => {
                        event.stopPropagation();
                        highlightCharacter(charId);
                        selectCharacter(charId);
                    };
                }
                 card.onclick = () => highlightCharacter(charId);
                characterOptionsContainer.appendChild(card);
            }
        }

        function highlightCharacter(charId) {
            playSFX('click');
            selectedCharacterIdTemp = charId;
            const allCards = characterOptionsContainer.querySelectorAll('.character-card');
            allCards.forEach(card => card.classList.remove('selected'));
            const selectedCard = characterOptionsContainer.querySelector(`.character-card[data-char-id="${charId}"]`);
            if (selectedCard) selectedCard.classList.add('selected');
        }

        function selectCharacter(charId) {
            if (!charId) return;
            playSFX('confirm');
            chosenCharacter = characters[charId];
            collectedClues = [];
            gameState = {};
            currentChapter = 1;
            currentTimeOfDay = 'day'; // å¾ç™½å¤©é–‹å§‹
            updateNotebook();
            playerAvatarGame.src = chosenCharacter.avatar;
            playerAvatarGame.onerror = () => { playerAvatarGame.src = 'https://placehold.co/100x100/cccccc/ffffff?text=?'; };
            playerNameGame.innerHTML = highlightKeywords(chosenCharacter.name);
            loadStoryNode('chapter1_intro');
        }

        function loadStoryNode(nodeId) {
             clearTimeout(typewriterTimeout);
             if ('speechSynthesis' in window) {
                 speechSynthesis.cancel();
                 isSpeechPaused = false; lastSpokenText = ""; lastSpeakButton = null;
             }
             document.querySelectorAll('.speak-button.speaking, .speak-button.paused').forEach(btn => {
                 btn.classList.remove('speaking', 'paused'); btn.innerHTML = 'ğŸ”Š';
             });
            const resolvedNodeId = typeof nodeId === 'function' ? nodeId(chosenCharacter.id) : nodeId;
            const node = story[resolvedNodeId];
            if (!node) { console.error("æ•…äº‹ç¯€é»æœªæ‰¾åˆ°:", resolvedNodeId); loadStoryNode('ending_unsolved'); return; }
            currentStoryNodeId = resolvedNodeId;
            showScreen('game-screen'); // æœƒæ›´æ–°è¦–è¦º
            if (resolvedNodeId.includes('intro')) {
                const nodeText = getTextFromNode(node, false);
                chapterTitle.innerHTML = highlightKeywords(nodeText.split('\n')[0]);
                currentObjective.textContent = `ç›®æ¨™: ${node.objective || 'æ¨é€²åŠ‡æƒ…'}`;
            } else if (node.objective) { currentObjective.textContent = `ç›®æ¨™: ${node.objective}`; }
             chapterTitle.classList.add('chapter-title-style');
            if (node.action) {
                node.action(); // Action å¯èƒ½æ”¹è®Š currentTimeOfDay
                updateVisualsBasedOnTime(); // ç¢ºä¿ Action åŸ·è¡Œå¾Œè¦–è¦ºåŒæ­¥
            }
            if (node.type === 'narration' || node.type === 'dialogue') {
                displayMessage(node);
            } else if (node.type === 'ending') { displayEnding(node); return; }
            storyDisplay.scrollTop = storyDisplay.scrollHeight;
        }

        // ... (highlightKeywords, getTextFromNode å‡½æ•¸ä¸è®Š) ...
        function highlightKeywords(text, isChoice = false) { if (!text) return ''; let highlightedText = text; const keywordClass = isChoice ? 'choice-keyword' : 'keyword'; const regex = new RegExp(`\\b(${keywords.join('|')})\\b`, 'gi'); highlightedText = highlightedText.replace(regex, `<span class="${keywordClass}">$1</span>`); return highlightedText; }
        function getTextFromNode(node, applyHighlight = true, isChoice = false) { let rawText = ''; if (typeof node.text === 'function') { rawText = node.text(chosenCharacter ? chosenCharacter.name : ''); } else { rawText = node.text || ''; } return applyHighlight ? highlightKeywords(rawText, isChoice) : rawText; }


        function displayMessage(node) {
            const messageHTML = getTextFromNode(node, true, false);
            const messageElement = document.createElement('div');
            messageElement.className = 'dialogue-box fade-in';
            let characterName = "æ—ç™½";
            const nameElement = document.createElement('div');
            nameElement.className = 'character-name';
            let rawTextForSpeech = getTextFromNode(node, false);
            if (node.type === 'dialogue') {
                characterName = node.character;
                const highlightedCharName = highlightKeywords(characterName, false);
                if (chosenCharacter && characterName === chosenCharacter.name) { messageElement.classList.add('player'); } else { messageElement.classList.add('npc'); }
                nameElement.innerHTML = highlightedCharName + ":"; messageElement.appendChild(nameElement);
                rawTextForSpeech = rawTextForSpeech.replace(/^ï¼ˆå…§å¿ƒï¼‰/, '').replace(/^ï¼ˆ.+?ï¼‰/, '').trim();
            } else { messageElement.classList.add('italic'); }
            const plainText = rawTextForSpeech.replace(/<[^>]*>/g, '');
            const emojiRegex = /[\u{1F300}-\u{1F5FF}\u{1F600}-\u{1F64F}\u{1F680}-\u{1F6FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F900}-\u{1F9FF}\u{1FA70}-\u{1FAFF}]/gu;
            let textToSpeak = plainText.replace(emojiRegex, '').replace(/\s+/g, ' ').trim();
            const textSpan = document.createElement('span'); messageElement.appendChild(textSpan);
            if ('speechSynthesis' in window && textToSpeak) {
                const speakButton = document.createElement('button'); speakButton.className = 'speak-button'; speakButton.innerHTML = 'ğŸ”Š'; speakButton.title = 'æ’­æ”¾è²éŸ³'; speakButton.dataset.textToSpeak = textToSpeak;
                speakButton.onclick = (e) => {
                    e.stopPropagation(); const text = e.currentTarget.dataset.textToSpeak; const synth = window.speechSynthesis;
                    if (synth.speaking) {
                        if (synth.paused && currentUtterance && currentUtterance.text === text) { console.log("ç¹¼çºŒæœ—è®€"); synth.resume(); e.currentTarget.classList.remove('paused'); e.currentTarget.classList.add('speaking'); e.currentTarget.innerHTML = 'ğŸ”Š'; isSpeechPaused = false; }
                        else if (currentUtterance && currentUtterance.text === text) { console.log("æš«åœæœ—è®€"); synth.pause(); e.currentTarget.classList.add('paused'); e.currentTarget.classList.remove('speaking'); e.currentTarget.innerHTML = 'â¸ï¸'; isSpeechPaused = true; }
                        else { console.log("åœæ­¢èˆŠçš„ï¼Œé–‹å§‹æ–°çš„æœ—è®€"); document.querySelectorAll('.speak-button.speaking, .speak-button.paused').forEach(btn => { if (btn !== e.currentTarget) { btn.classList.remove('speaking', 'paused'); btn.innerHTML = 'ğŸ”Š'; } }); speakText(text, e.currentTarget); e.currentTarget.classList.remove('paused'); e.currentTarget.classList.add('speaking'); e.currentTarget.innerHTML = 'ğŸ”Š'; isSpeechPaused = false; }
                    } else { console.log("é–‹å§‹æœ—è®€"); document.querySelectorAll('.speak-button.speaking, .speak-button.paused').forEach(btn => { if (btn !== e.currentTarget) { btn.classList.remove('speaking', 'paused'); btn.innerHTML = 'ğŸ”Š'; } }); speakText(text, e.currentTarget); e.currentTarget.classList.remove('paused'); e.currentTarget.classList.add('speaking'); e.currentTarget.innerHTML = 'ğŸ”Š'; isSpeechPaused = false; }
                }; messageElement.appendChild(speakButton);
            }
            storyDisplay.appendChild(messageElement);
            let charIndex = 0; let visibleHTML = '';
            function typeWriterAdvanced() {
                if (charIndex < messageHTML.length) {
                    const char = messageHTML[charIndex]; let shouldDelay = true;
                    if (char === '<') {
                        const tagMatch = messageHTML.substring(charIndex).match(/^<[^>]+>/);
                        if (tagMatch) { visibleHTML += tagMatch[0]; charIndex += tagMatch[0].length; shouldDelay = false; }
                        else { visibleHTML += char; charIndex++; }
                    } else { visibleHTML += char; charIndex++; }
                    textSpan.innerHTML = visibleHTML;
                    if (shouldDelay) { typewriterTimeout = setTimeout(typeWriterAdvanced, typewriterSpeed); }
                    else { typeWriterAdvanced(); }
                    storyDisplay.scrollTop = storyDisplay.scrollHeight;
                } else { displayChoices(node); storyDisplay.scrollTop = storyDisplay.scrollHeight; }
            }
            choicesDisplay.innerHTML = ''; disableChoices(); typeWriterAdvanced();
        }

        function displayChoices(node) {
            choicesDisplay.innerHTML = '';
            if (node.choices && node.choices.length > 0) {
                let hasVisibleChoice = false;
                node.choices.forEach(choice => {
                    let conditionMet = true; if (choice.condition) { conditionMet = choice.condition(chosenCharacter ? chosenCharacter.id : null, gameState); }
                    if (conditionMet) {
                        hasVisibleChoice = true; const button = document.createElement('button'); button.className = 'btn block w-full md:w-auto md:inline-block my-1 fade-in'; button.style.opacity = '0';
                        const buttonText = typeof choice.text === 'function' ? choice.text() : choice.text; button.innerHTML = highlightKeywords(buttonText, true);
                        button.onclick = () => {
                            if ('speechSynthesis' in window) { speechSynthesis.cancel(); isSpeechPaused = false; } playSFX(choice.sfx || 'click');
                            if (choice.action) { choice.action(); updateVisualsBasedOnTime(); } disableChoices(); loadStoryNode(choice.next);
                        }; choicesDisplay.appendChild(button);
                    }
                });
                 if (hasVisibleChoice) { setTimeout(() => { const buttons = choicesDisplay.querySelectorAll('.btn'); buttons.forEach(btn => btn.style.opacity = '1'); }, 50); }
            } else if (node.next && node.type !== 'ending') {
                const continueButton = document.createElement('button'); continueButton.className = 'btn block w-full md:w-auto md:inline-block my-1 fade-in'; continueButton.style.opacity = '0'; continueButton.textContent = "ç¹¼çºŒ...";
                continueButton.onclick = () => { if ('speechSynthesis' in window) { speechSynthesis.cancel(); isSpeechPaused = false; } playSFX('click'); disableChoices(); loadStoryNode(node.next); }; choicesDisplay.appendChild(continueButton);
                 setTimeout(() => continueButton.style.opacity = '1', 50);
            }
        }

        function disableChoices() { const buttons = choicesDisplay.querySelectorAll('button'); buttons.forEach(button => { button.disabled = true; button.classList.add('btn-disabled'); }); }
        function displayEnding(node) { playSFX('ending'); endingTitle.innerHTML = highlightKeywords(node.title, false); endingDescription.innerHTML = highlightKeywords(node.description, false); showScreen('ending-screen'); }
        function addClue(clueText) { const plainClueText = clueText.replace(/<[^>]*>/g, ''); const plainCollectedClues = collectedClues.map(c => c.replace(/<[^>]*>/g, '')); if (!plainCollectedClues.includes(plainClueText)) { collectedClues.push(clueText); updateNotebook(); playSFX('discover'); } }
        function hasClue(clueSubstring) { const plainClues = collectedClues.map(clue => clue.replace(/<[^>]*>/g, '')); return plainClues.some(clue => clue.includes(clueSubstring)); }
        function updateGameState(key, value) { gameState[key] = value; }
        function updateNotebook() { clueList.innerHTML = ''; if (collectedClues.length === 0) { clueList.innerHTML = '<li>ç›®å‰æ²’æœ‰ç·šç´¢ã€‚</li>'; } else { collectedClues.forEach(clue => { const li = document.createElement('li'); li.innerHTML = highlightKeywords(clue, false); clueList.appendChild(li); }); } }

        // **ä¿®æ”¹ï¼šModal é–‹é—œä½¿ç”¨ classList**
        function openNotebook() { playSFX('ui'); notebookModal.classList.add('active'); }
        function closeNotebook() { playSFX('ui_close'); notebookModal.classList.remove('active'); }
        function openSettings() { playSFX('ui'); settingsModal.classList.add('active'); syncAudioControls(); }
        function closeSettings() { playSFX('ui_close'); settingsModal.classList.remove('active'); }

        // --- éŸ³æ•ˆè™•ç† (ä¸è®Š) ---
        async function initializeAudio() { console.log("[Audio] initializeAudio function entered."); if (isAudioInitialized && Tone.context && Tone.context.state === 'running') { console.log("[Audio] Already initialized and running."); return true; } if (typeof Tone === 'undefined') { console.error("[Audio] Tone.js object is undefined!"); isAudioInitialized = false; return false; } if (typeof speechSynthesis === 'undefined') { console.warn("[Audio] Speech Synthesis not supported by this browser."); } if (Tone.context && Tone.context.state !== 'running') { console.log("[Audio] AudioContext exists but not running, attempting to resume..."); try { await Tone.context.resume(); console.log("[Audio] AudioContext resumed successfully."); audioContextRequiresInteraction = false; isAudioInitialized = true; setVolume(currentVolume); if ('speechSynthesis' in window) speechSynthesis.cancel(); Tone.Destination.mute = isMuted; return true; } catch (resumeError) { console.error("[Audio] Failed to resume existing AudioContext:", resumeError); } } console.log("[Audio] Attempting Tone.start()..."); try { await Tone.start(); console.log("[Audio] Tone.start() successful. State:", Tone.context.state); audioContextRequiresInteraction = false; isAudioInitialized = true; console.log("[Audio] Context started, initialization flag set."); ensureAudioObjects(); setVolume(currentVolume); if ('speechSynthesis' in window) speechSynthesis.cancel(); Tone.Destination.mute = isMuted; return true; } catch (startError) { console.error("[Audio] Failed to start Tone.js AudioContext via Tone.start():", startError); console.warn("[Audio] Browser might restrict autoplay. Requires user interaction."); isAudioInitialized = false; audioContextRequiresInteraction = true; return false; } }
        function ensureAudioObjects() { if (!synth && isAudioInitialized && Tone.context.state === 'running') { try { console.log("[Audio] Creating Synth on demand..."); synth = new Tone.Synth().toDestination(); console.log("[Audio] Synth created."); } catch (e) { console.error("[Audio] Error creating Synth:", e); return false; } } if (Tone.Transport && Tone.Transport.state !== 'started' && isAudioInitialized) { try { Tone.Transport.start(); console.log("[Audio] Tone.Transport started on demand."); } catch (e) { console.error("[Audio] Error starting Transport:", e); } } return !!synth; }
        function playSFX(type) { if (isMuted || !isAudioInitialized) { return; } if (!ensureAudioObjects()) { console.error("Failed to ensure audio objects for SFX. Cannot play."); return; } if (!synth) { console.error("Cannot play SFX: Synth object is missing after ensureAudioObjects."); return; } try { if (!Tone.Destination.mute) { Tone.Destination.volume.value = Tone.gainToDb(currentVolume); } const now = Tone.now(); switch (type) { case 'click': synth.triggerAttackRelease("C4", "8n", now); break; case 'confirm': synth.triggerAttackRelease("E4", "8n", now); break; case 'discover': synth.triggerAttackRelease("G4", "4n", now); break; case 'puzzle': synth.triggerAttackRelease("A4", "8n", now + 0.1); synth.triggerAttackRelease("C5", "8n", now + 0.2); break; case 'travel': synth.triggerAttackRelease("F3", "4n", now); break; case 'confront': synth.triggerAttackRelease("A3", "4n", now); break; case 'decision': synth.triggerAttackRelease("D4", "4n", now); break; case 'decision_final': synth.triggerAttackRelease("G3", "2n", now); break; case 'ending': synth.triggerAttackRelease("C5", "1n", now); break; case 'ui': synth.triggerAttackRelease("C5", "16n", now); break; case 'ui_close': synth.triggerAttackRelease("A4", "16n", now); break; default: synth.triggerAttackRelease("C4", "8n", now); } } catch (e) { console.error("æ’­æ”¾ SFX æ™‚å‡ºéŒ¯:", type, e); } }

        // --- æ–‡å­—è½‰èªéŸ³å‡½æ•¸ (ä¸è®Š) ---
        function speakText(textToSpeak, buttonElement = null) { if (!('speechSynthesis' in window)) { console.warn("æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åˆæˆã€‚"); return; } if (!textToSpeak) { console.warn("æ²’æœ‰æ–‡å­—å¯ä»¥æœ—è®€ã€‚"); return; } if (!isAudioInitialized || audioContextRequiresInteraction) { console.warn("éŸ³è¨Šå°šæœªå®Œå…¨åˆå§‹åŒ–ï¼Œç„¡æ³•æœ—è®€ã€‚"); return; } if (isMuted) { console.log("ç›®å‰ç‚ºéœéŸ³ç‹€æ…‹ï¼Œä¸æœ—è®€ã€‚"); return; } console.log("æº–å‚™æœ—è®€:", textToSpeak); speechSynthesis.cancel(); currentUtterance = new SpeechSynthesisUtterance(textToSpeak); currentUtterance.lang = selectedVoice ? selectedVoice.lang : 'zh-TW'; currentUtterance.voice = selectedVoice; currentUtterance.rate = currentTtsRate; currentUtterance.pitch = currentTtsPitch; lastSpokenText = textToSpeak; lastSpeakButton = buttonElement; isSpeechPaused = false; const handleEnd = () => { console.log("æœ—è®€çµæŸ"); if (lastSpeakButton) { lastSpeakButton.classList.remove('speaking', 'paused'); lastSpeakButton.innerHTML = 'ğŸ”Š'; } currentUtterance = null; lastSpokenText = ""; lastSpeakButton = null; }; const handleError = (event) => { console.error("æœ—è®€éŒ¯èª¤:", event.error); if (lastSpeakButton) { lastSpeakButton.classList.remove('speaking', 'paused'); lastSpeakButton.innerHTML = 'ğŸ”Š'; } currentUtterance = null; lastSpokenText = ""; lastSpeakButton = null; }; currentUtterance.onend = handleEnd; currentUtterance.onerror = handleError; speechSynthesis.speak(currentUtterance); }
        function populateVoiceList(attempt = 1) { if (!('speechSynthesis' in window)) return; availableVoices = speechSynthesis.getVoices(); if (availableVoices.length === 0 && attempt <= 5) { console.log(`èªéŸ³åˆ—è¡¨ç‚ºç©ºï¼Œç¬¬ ${attempt} æ¬¡å˜—è©¦é‡æ–°ç²å–...`); setTimeout(() => populateVoiceList(attempt + 1), 100 * attempt); return; } console.log("Available voices:", availableVoices); populateVoiceListAttempts = 0; settingsTtsVoiceSelect.innerHTML = ''; const currentSelectedName = selectedVoice ? selectedVoice.name : null; let foundSelected = false; const chineseVoices = availableVoices.filter(voice => voice.lang.startsWith('zh')); if (chineseVoices.length > 0) { chineseVoices.forEach((voice, index) => { const option = document.createElement('option'); let displayName = voice.name.replace(/Microsoft |Google | \(Online\)| \(Local\)| Taiwan| Chinese \(Taiwan\)| Chinese \(Traditional, Taiwan\)| Chinese/g, '').trim(); if (!displayName) displayName = `èªéŸ³ ${index + 1}`; option.textContent = `${displayName} (${voice.lang})`; option.setAttribute('data-lang', voice.lang); option.setAttribute('data-name', voice.name); if (currentSelectedName === voice.name) { option.selected = true; selectedVoice = voice; foundSelected = true; } else if (!currentSelectedName && !foundSelected && voice.lang === 'zh-TW') { option.selected = true; selectedVoice = voice; foundSelected = true; } settingsTtsVoiceSelect.appendChild(option); }); if (!settingsTtsVoiceSelect.querySelector('option[selected]') && settingsTtsVoiceSelect.options.length > 0) { settingsTtsVoiceSelect.selectedIndex = 0; const firstVoiceName = settingsTtsVoiceSelect.options[0].getAttribute('data-name'); selectedVoice = availableVoices.find(v => v.name === firstVoiceName); console.log("Defaulting to first available voice:", selectedVoice); } } else { const option = document.createElement('option'); option.textContent = 'ç„¡å¯ç”¨ä¸­æ–‡èªéŸ³'; option.disabled = true; settingsTtsVoiceSelect.appendChild(option); selectedVoice = null; } syncVoiceSelection(); }
        function syncVoiceSelection() { if (!selectedVoice) { return; } let found = false; for (let i = 0; i < settingsTtsVoiceSelect.options.length; i++) { if (settingsTtsVoiceSelect.options[i].getAttribute('data-name') === selectedVoice.name) { settingsTtsVoiceSelect.selectedIndex = i; found = true; break; } } if (!found && settingsTtsVoiceSelect.options.length > 0 && !settingsTtsVoiceSelect.options[0].disabled) { settingsTtsVoiceSelect.selectedIndex = 0; const firstVoiceName = settingsTtsVoiceSelect.options[0].getAttribute('data-name'); selectedVoice = availableVoices.find(v => v.name === firstVoiceName); console.warn("Previously selected voice not found, defaulting to first available voice."); } else if (!found && settingsTtsVoiceSelect.options.length === 0) { selectedVoice = null; } }
        function syncRateSelection() { settingsTtsRateSlider.value = currentTtsRate; } function syncPitchSelection() { settingsTtsPitchSlider.value = currentTtsPitch; }

        // --- å…¶ä»–æ§åˆ¶å‡½æ•¸ (ä¸è®Š) ---
        function toggleMute() { isMuted = !isMuted; if (isAudioInitialized && Tone.Destination) { Tone.Destination.mute = isMuted; } updateMuteButtons(); if (isMuted && 'speechSynthesis' in window) { speechSynthesis.cancel(); isSpeechPaused = false; document.querySelectorAll('.speak-button.speaking, .speak-button.paused').forEach(btn => { btn.classList.remove('speaking', 'paused'); btn.innerHTML = 'ğŸ”Š'; }); } }
        function updateMuteButtons() { settingsMuteButton.textContent = isMuted ? "å–æ¶ˆéœéŸ³" : "éœéŸ³"; }
        function setVolume(value) { const newVolume = parseFloat(value); currentVolume = newVolume; if (isAudioInitialized && Tone.Destination) { if (!isMuted) { Tone.Destination.volume.value = (newVolume === 0) ? -Infinity : Tone.gainToDb(newVolume); } } settingsVolumeSlider.value = newVolume; }
        function syncAudioControls() { settingsVolumeSlider.value = currentVolume; updateMuteButtons(); if (isAudioInitialized && Tone.Destination) { Tone.Destination.mute = isMuted; if (!isMuted) { setVolume(currentVolume); } } syncVoiceSelection(); syncRateSelection(); syncPitchSelection(); }
        function updateSpeedDisplay() { const speedMultiplier = (BASE_TYPEWRITER_SPEED / typewriterSpeed).toFixed(1); settingsSpeedDisplay.textContent = `x${speedMultiplier}`; }
        function increaseSpeed() { typewriterSpeed = Math.max(MAX_SPEED, typewriterSpeed - SPEED_STEP); console.log("æ‰“å­—é€Ÿåº¦åŠ å¿«:", typewriterSpeed); updateSpeedDisplay(); playSFX('click'); }
        function decreaseSpeed() { typewriterSpeed = Math.min(MIN_SPEED, typewriterSpeed + SPEED_STEP); console.log("æ‰“å­—é€Ÿåº¦æ¸›æ…¢:", typewriterSpeed); updateSpeedDisplay(); playSFX('click'); }

        // --- å­˜æª”/è®€æª”å‡½æ•¸ (åŒ…å«æ—¥å¤œ) ---
        function saveGame() { if (!chosenCharacter || !currentStoryNodeId) { alert("å°šæœªé–‹å§‹éŠæˆ²æˆ–è™•æ–¼ç„¡æ³•å„²å­˜çš„ç‹€æ…‹ã€‚"); playSFX('ui_close'); return; } const voiceNameToSave = selectedVoice ? selectedVoice.name : null; const saveData = { chosenCharacterId: chosenCharacter.id, currentChapter: currentChapter, currentStoryNodeId: currentStoryNodeId, collectedClues: collectedClues, gameState: gameState, currentTimeOfDay: currentTimeOfDay, currentVolume: currentVolume, isMuted: isMuted, typewriterSpeed: typewriterSpeed, selectedVoiceName: voiceNameToSave, currentTtsRate: currentTtsRate, currentTtsPitch: currentTtsPitch, currentObjectiveText: currentObjective.textContent, storyDisplayHTML: storyDisplay.innerHTML }; try { localStorage.setItem(SAVE_GAME_KEY, JSON.stringify(saveData)); console.log("éŠæˆ²å·²å„²å­˜:", saveData); alert("éŠæˆ²é€²åº¦å·²å„²å­˜ï¼ğŸ’¾"); playSFX('confirm'); } catch (error) { console.error("å„²å­˜éŠæˆ²å¤±æ•—:", error); alert("å„²å­˜éŠæˆ²å¤±æ•—ï¼Œå¯èƒ½æ˜¯å„²å­˜ç©ºé–“å·²æ»¿ã€‚"); playSFX('ui_close'); } }
        async function loadGame() { const savedDataString = localStorage.getItem(SAVE_GAME_KEY); if (!savedDataString) { alert("æ‰¾ä¸åˆ°å­˜æª”è¨˜éŒ„ã€‚"); playSFX('ui_close'); return; } try { const savedData = JSON.parse(savedDataString); console.log("è®€å–å­˜æª”:", savedData); chosenCharacter = characters[savedData.chosenCharacterId]; currentChapter = savedData.currentChapter ?? 1; currentStoryNodeId = savedData.currentStoryNodeId; collectedClues = savedData.collectedClues || []; gameState = savedData.gameState || {}; currentTimeOfDay = savedData.currentTimeOfDay || 'day'; if (!chosenCharacter || !currentStoryNodeId) { throw new Error("å­˜æª”è³‡æ–™ç¼ºå°‘å¿…è¦çš„è§’è‰²æˆ–ç¯€é» IDã€‚"); } currentVolume = savedData.currentVolume ?? 0.5; isMuted = savedData.isMuted ?? false; typewriterSpeed = savedData.typewriterSpeed ?? BASE_TYPEWRITER_SPEED; currentTtsRate = savedData.currentTtsRate ?? 1; currentTtsPitch = savedData.currentTtsPitch ?? 1; const savedVoiceName = savedData.selectedVoiceName; if (savedVoiceName) { selectedVoice = availableVoices.find(v => v.name === savedVoiceName); if (!selectedVoice) { console.warn(`è®€æª”æ™‚æ‰¾ä¸åˆ°èªéŸ³: ${savedVoiceName}ï¼Œå°‡åœ¨åˆ—è¡¨æ›´æ–°å¾Œå˜—è©¦åŒæ­¥ã€‚`); } else { console.log("è®€æª”æ™‚æˆåŠŸæ‰¾åˆ°èªéŸ³:", selectedVoice.name); } } else { selectedVoice = null; } playerAvatarGame.src = chosenCharacter.avatar; playerAvatarGame.onerror = () => { playerAvatarGame.src = 'https://placehold.co/100x100/cccccc/ffffff?text=?'; }; playerNameGame.innerHTML = highlightKeywords(chosenCharacter.name); currentObjective.textContent = savedData.currentObjectiveText || 'ç›®æ¨™: æ¨é€²åŠ‡æƒ…'; updateNotebook(); syncAudioControls(); updateSpeedDisplay(); if (!isAudioInitialized) { console.log("è®€æª”æ™‚éŸ³è¨Šæœªåˆå§‹åŒ–ï¼Œå˜—è©¦å•Ÿå‹•..."); const audioReady = await initializeAudio(); if (!audioReady) { console.warn("è®€æª”å¾Œå˜—è©¦åˆå§‹åŒ–éŸ³è¨Šå¤±æ•—ã€‚éŸ³æ•ˆ/èªéŸ³å¯èƒ½ç„¡æ³•é‹ä½œã€‚"); alert("éŸ³è¨Šåˆå§‹åŒ–å¤±æ•—ï¼ŒéŸ³æ•ˆå’ŒèªéŸ³æœ—è®€å¯èƒ½ç„¡æ³•ä½¿ç”¨ã€‚è«‹å˜—è©¦é‡æ–°æ•´ç†é é¢æˆ–æª¢æŸ¥ç€è¦½å™¨è¨­å®šã€‚"); } else { console.log("è®€æª”å¾ŒæˆåŠŸåˆå§‹åŒ–éŸ³è¨Šã€‚"); setVolume(currentVolume); if (Tone.Destination) Tone.Destination.mute = isMuted; } } else { console.log("è®€æª”æ™‚éŸ³è¨Šå·²åˆå§‹åŒ–ï¼Œæ‡‰ç”¨è¨­å®š..."); setVolume(currentVolume); if (Tone.Destination) Tone.Destination.mute = isMuted; } if (savedData.storyDisplayHTML) { storyDisplay.innerHTML = savedData.storyDisplayHTML; storyDisplay.scrollTop = storyDisplay.scrollHeight; } else { storyDisplay.innerHTML = ''; } const node = story[currentStoryNodeId]; if (node) { showScreen('game-screen'); choicesDisplay.innerHTML = ''; displayChoices(node); } else { throw new Error(`è®€æª”å¤±æ•—ï¼šæ‰¾ä¸åˆ°å­˜æª”çš„æ•…äº‹ç¯€é» ID: ${currentStoryNodeId}`); } playSFX('confirm'); alert("éŠæˆ²é€²åº¦å·²è¼‰å…¥ï¼"); } catch (error) { console.error("è®€å–éŠæˆ²å¤±æ•—:", error); alert(`è®€å–éŠæˆ²å¤±æ•—ï¼š${error.message}\nå­˜æª”å¯èƒ½å·²æå£æˆ–èˆ‡ç•¶å‰ç‰ˆæœ¬ä¸ç¬¦ï¼Œå°‡è¢«æ¸…é™¤ã€‚`); localStorage.removeItem(SAVE_GAME_KEY); loadGameButton.classList.add('hidden'); showScreen('start-screen'); playSFX('ui_close'); } }

        // --- äº‹ä»¶ç›£è½å™¨ ---
        startGameButton.addEventListener('click', async () => { console.log("é–‹å§‹éŠæˆ²æŒ‰éˆ•è¢«é»æ“Šã€‚"); if (typeof Tone === 'undefined' || typeof speechSynthesis === 'undefined') { console.error("éŒ¯èª¤ï¼šTone.js æˆ– SpeechSynthesis æœªèƒ½åœ¨æŒ‰éˆ•é»æ“Šæ™‚è¼‰å…¥ï¼"); alert("ç„¡æ³•åˆå§‹åŒ–éŸ³è¨Šç³»çµ±ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç€è¦½å™¨è¨­å®šã€‚"); return; } populateCharacterSelection(); showScreen('character-select-screen'); const audioReady = await initializeAudio(); if (audioReady) { console.log("[Audio] Context started successfully via button click."); playSFX('confirm'); populateVoiceList(); if ('speechSynthesis' in window && speechSynthesis.onvoiceschanged !== undefined) { speechSynthesis.onvoiceschanged = populateVoiceList; } } else { console.warn("[Audio] Context failed to start via button click. Audio/TTS may not work."); alert("éŸ³è¨Šåˆå§‹åŒ–å¤±æ•—ï¼ŒéŸ³æ•ˆå’ŒèªéŸ³æœ—è®€å¯èƒ½ç„¡æ³•ä½¿ç”¨ã€‚è«‹å˜—è©¦é‡æ–°æ•´ç†é é¢æˆ–æª¢æŸ¥ç€è¦½å™¨è¨­å®šã€‚"); } });
        restartButton.addEventListener('click', () => { playSFX('click'); if (localStorage.getItem(SAVE_GAME_KEY)) { if (confirm("é‡æ–°é–‹å§‹å°‡æœƒæ¸…é™¤ä¹‹å‰çš„å­˜æª”ï¼Œç¢ºå®šå—ï¼Ÿ")) { localStorage.removeItem(SAVE_GAME_KEY); loadGameButton.classList.add('hidden'); console.log("å­˜æª”å·²æ¸…é™¤ã€‚"); } else { return; } } showScreen('start-screen'); currentChapter = 0; currentStoryNodeId = null; chosenCharacter = null; collectedClues = []; gameState = {}; currentTimeOfDay = 'day'; selectedCharacterIdTemp = null; storyDisplay.innerHTML = ''; choicesDisplay.innerHTML = ''; updateNotebook(); typewriterSpeed = BASE_TYPEWRITER_SPEED; updateSpeedDisplay(); if ('speechSynthesis' in window) { speechSynthesis.cancel(); isSpeechPaused = false; } });
        notebookButton.addEventListener('click', openNotebook);
        openSettingsButton.addEventListener('click', openSettings);
        saveGameButton.addEventListener('click', saveGame);
        loadGameButton.addEventListener('click', loadGame);
        settingsVolumeSlider.addEventListener('input', (event) => setVolume(event.target.value));
        settingsMuteButton.addEventListener('click', toggleMute);
        settingsSpeedUpButton.addEventListener('click', increaseSpeed);
        settingsSpeedDownButton.addEventListener('click', decreaseSpeed);
        settingsTtsVoiceSelect.addEventListener('change', (event) => { const selectedOption = event.target.options[event.target.selectedIndex]; if (selectedOption && !selectedOption.disabled) { const voiceName = selectedOption.getAttribute('data-name'); selectedVoice = availableVoices.find(voice => voice.name === voiceName); console.log("é¸æ“‡çš„èªéŸ³:", selectedVoice ? selectedVoice.name : 'None'); syncVoiceSelection(); if ((speechSynthesis.speaking || speechSynthesis.paused) && currentUtterance && lastSpokenText && lastSpeakButton) { console.log("èªéŸ³è®Šæ›´ï¼Œé‡æ–°æœ—è®€..."); speakText(lastSpokenText, lastSpeakButton); lastSpeakButton.classList.remove('paused'); lastSpeakButton.classList.add('speaking'); lastSpeakButton.innerHTML = 'ğŸ”Š'; } } });
        settingsTtsRateSlider.addEventListener('input', (event) => { currentTtsRate = parseFloat(event.target.value); console.log("èªé€Ÿèª¿æ•´ç‚º:", currentTtsRate); syncRateSelection(); if ((speechSynthesis.speaking || speechSynthesis.paused) && currentUtterance && lastSpokenText && lastSpeakButton) { console.log("èªé€Ÿè®Šæ›´ï¼Œé‡æ–°æœ—è®€..."); speakText(lastSpokenText, lastSpeakButton); lastSpeakButton.classList.remove('paused'); lastSpeakButton.classList.add('speaking'); lastSpeakButton.innerHTML = 'ğŸ”Š'; } });
        settingsTtsPitchSlider.addEventListener('input', (event) => { currentTtsPitch = parseFloat(event.target.value); console.log("éŸ³é«˜èª¿æ•´ç‚º:", currentTtsPitch); syncPitchSelection(); if ((speechSynthesis.speaking || speechSynthesis.paused) && currentUtterance && lastSpokenText && lastSpeakButton) { console.log("éŸ³é«˜è®Šæ›´ï¼Œé‡æ–°æœ—è®€..."); speakText(lastSpokenText, lastSpeakButton); lastSpeakButton.classList.remove('paused'); lastSpeakButton.classList.add('speaking'); lastSpeakButton.innerHTML = 'ğŸ”Š'; } });

        // --- åˆå§‹è¨­å®šå’Œè¼‰å…¥ ---
        showScreen('start-screen');
        if (localStorage.getItem(SAVE_GAME_KEY)) { loadGameButton.classList.remove('hidden'); } else { loadGameButton.classList.add('hidden'); }
        syncAudioControls(); updateSpeedDisplay();
        populateVoiceList();
        if ('speechSynthesis' in window && speechSynthesis.onvoiceschanged !== undefined) { speechSynthesis.onvoiceschanged = populateVoiceList; }

        // **ä¿®æ”¹ï¼šModal èƒŒæ™¯é»æ“Šé—œé–‰**
        window.onclick = function(event) {
             if (event.target == notebookModal) closeNotebook();
             if (event.target == settingsModal) closeSettings();
        }

    </script>
</body>
</html>