<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è’¼é¾å¯†å‡½ - æ­¦ä¿ æ–‡å­—éŠæˆ²</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* æ­¦ä¿ é¢¨æ ¼çš„è‰²å½©å’Œå­—é«”è®Šæ•¸ */
        :root {
            --bg-color: #f4f1e9; /* æ³›é»ƒå®£ç´™è‰² */
            --card-bg: #3e3129;  /* æ·±æ£•è‰² */
            --text-primary: #f0e6d8; /* å¡ç‰‡äº®è‰² - ç±³ç™½ */
            --text-secondary: #c8bfae;/* å¡ç‰‡æ¬¡è¦æ–‡å­— - ç°è¤ */
            --text-dark: #2c2017;   /* é é¢æ·±è‰²æ–‡å­— - è¿‘é»‘ */
            --accent-red: #a83c32;   /* æš—ç´…è‰² */
            --accent-red-dark: #8f2a20;
            --accent-gold: #b88b28;  /* å¤éŠ…é‡‘ */
            --accent-gold-dark: #a0741a;
            --accent-gray: #6a7077; /* ç°è‰² */
            --accent-gray-dark: #4e5358;

            --keyword-blue: var(--accent-gold); /* é—œéµå­—ç”¨é‡‘è‰² */
            --keyword-red: #c85e5e; /* é¸é …é—œéµå­—ç”¨ç´…è‰² */
            --tag-border: #7a6a5a;  /* æ¨™ç±¤é‚Šæ¡† - è¤è‰² */
            --tag-text: #b8a898;   /* æ¨™ç±¤æ–‡å­— - æ·ºè¤ */
            --shadow-color-light: rgba(44, 32, 23, 0.08); /* é™°å½± - æ£•è‰²èª¿ */
            --shadow-color-medium: rgba(44, 32, 23, 0.12);
        }
        html, body { height: 100%; margin: 0; padding: 0; }
        body {
            font-family: 'Noto Sans TC', sans-serif; /* ä¸»è¦å­—é«” */
            overscroll-behavior: none;
            background-color: var(--bg-color);
            font-size: 16px;
            color: var(--text-dark);
        }
        #game-container { min-height: 100vh; display: flex; flex-direction: column; }

        /* é—œéµå­—é«˜äº® */
        .keyword { color: var(--keyword-blue); font-weight: bold; }
        .choice-keyword { color: var(--keyword-red); font-weight: bold; }

        /* æ¨™é¡Œæ¨£å¼ */
        .game-title-gradient {
            font-family: 'Noto Serif TC', serif;
            background: linear-gradient(to right, var(--accent-red), var(--accent-red-dark));
            -webkit-background-clip: text; background-clip: text; color: transparent;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.1));
        }
        .chapter-title-style {
            font-family: 'Noto Serif TC', serif;
            color: #e0dacd; /* æ¨™é¡Œäº®è‰² */
            text-shadow: 1px 1px 3px rgba(0,0,0,0.6);
            font-size: 1.85rem;
        }

        /* å°è©±æ¡†æ¨£å¼ - å¾®èª¿é¡è‰² */
        .dialogue-box {
            border: 1px solid #dcd3c0; padding: 1.1rem; margin-bottom: 1.1rem;
            border-radius: 8px; /* ç¨å¾®æ–¹æ­£ä¸€é» */
            background-color: rgba(255, 255, 255, 0.95); /* å¾®èª¿é€æ˜åº¦ */
            box-shadow: 0 6px 18px var(--shadow-color-light);
            line-height: 1.8; font-size: 1.08rem;
            animation: fadeIn 0.5s ease-out;
            position: relative;
            padding-right: 3rem; /* ä¿æŒçµ¦æ’­æ”¾æŒ‰éˆ•çš„ç©ºé–“ */
        }
        .dialogue-box.player { border-left: 5px solid var(--accent-gold); background-color: rgba(245, 241, 232, 0.97); } /* ç©å®¶ç”¨é‡‘è‰²é‚Šæ¡† */
        .dialogue-box.npc { border-left: 5px solid var(--accent-gray); background-color: rgba(239, 239, 237, 0.97); } /* NPC ç”¨ç°è‰²é‚Šæ¡† */
        .character-name { font-weight: 700; margin-bottom: 0.6rem; font-size: 1.15rem; }
        .dialogue-box.player .character-name { color: var(--accent-gold-dark); }
        .dialogue-box.npc .character-name { color: #5c4e43; } /* NPC åå­—é¡è‰² */

        /* æ’­æ”¾æŒ‰éˆ•æ¨£å¼ - å¾®èª¿é¡è‰² */
        .speak-button {
            position: absolute; top: 0.75rem; right: 0.75rem; background: none;
            border: none; font-size: 1.5rem; cursor: pointer; color: var(--accent-gray);
            transition: color 0.2s ease, transform 0.2s ease; padding: 0.25rem; line-height: 1;
        }
        .speak-button:hover { color: var(--accent-red); transform: scale(1.1); }
        .speak-button:active { transform: scale(0.95); }
        .speak-button.speaking { color: var(--accent-red); animation: pulse 1.5s infinite ease-in-out; }
        .speak-button.paused { color: #fbbf24; } /* æš«åœç”¨äº®é»ƒè‰² */

        /* æŒ‰éˆ•æ¨£å¼ - ä½¿ç”¨æ­¦ä¿ é¢¨é…è‰² */
        .btn { display: inline-block; padding: 0.8rem 1.6rem; margin: 0.5rem; border-radius: 6px; background-image: linear-gradient(to right, var(--accent-red), var(--accent-red-dark)); color: white; text-align: center; cursor: pointer; transition: all 0.3s ease; font-weight: bold; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06); border: none; font-size: 1rem; }
        .btn:hover { background-image: linear-gradient(to right, var(--accent-red-dark), #7a1f16); box-shadow: 0 7px 14px rgba(0, 0, 0, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08); transform: translateY(-3px); }
        .btn:active { transform: translateY(-1px); box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
        .btn-secondary { background-image: linear-gradient(to right, var(--accent-gray), var(--accent-gray-dark)); }
        .btn-secondary:hover { background-image: linear-gradient(to right, var(--accent-gray-dark), #3a3e42); }
        .btn-gold { background-image: linear-gradient(to right, var(--accent-gold), var(--accent-gold-dark)); }
        .btn-gold:hover { background-image: linear-gradient(to right, var(--accent-gold-dark), #8b6309); }
        .btn-disabled { background-image: none; background-color: #c8bfae; color: #6f6458; cursor: not-allowed; box-shadow: none; transform: none; }
        .btn-small { padding: 5px 10px; font-size: 0.875rem; margin: 0; }
        .btn-select-char { width: 100%; margin-top: auto; padding: 0.7rem 1rem; font-size: 0.95rem;}

        /* é–‹å§‹ç•«é¢è³‡è¨Šæ–‡å­— */
        .start-info-text { font-size: 1.15rem; color: #e0d6c7; margin-bottom: 0.6rem; } /* æ–‡å­—é¡è‰²èª¿æ•´ */
        .start-info-text span { font-weight: bold; color: #f5f1e8; } /* å¼·èª¿æ–‡å­—é¡è‰² */

        /* è§’è‰²å¡ç‰‡æ¨£å¼ - ä½¿ç”¨æ­¦ä¿ é¢¨é…è‰² */
        #character-options { display: flex; flex-direction: column; gap: 1.75rem; width: 100%; max-width: 650px; margin: 0 auto; padding-bottom: 3rem; }
        .character-card {
            background-color: var(--card-bg); border-radius: 8px; padding: 0; margin: 0;
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.12), 0 4px 8px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border 0.3s ease;
            cursor: pointer; border: 2px solid transparent; display: flex; overflow: hidden; align-items: stretch;
        }
        .character-card:hover { transform: scale(1.03); box-shadow: 0 18px 35px rgba(0, 0, 0, 0.15), 0 7px 12px rgba(0, 0, 0, 0.1); }
        .character-card.selected { border-color: var(--accent-gold); box-shadow: 0 15px 30px rgba(184, 139, 40, 0.2), 0 5px 10px rgba(184, 139, 40, 0.15); } /* é¸ä¸­é‚Šæ¡†ç”¨é‡‘è‰² */
        .character-image-container { flex-shrink: 0; width: 160px; }
        .character-image-container img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .character-info-container { flex-grow: 1; padding: 1.5rem 1.75rem; display: flex; flex-direction: column; color: var(--text-secondary); }
        .character-info-container h3 { font-family: 'Noto Serif TC', serif; font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.8rem; text-align: left; }
        .character-description { font-size: 1rem; line-height: 1.7; color: var(--text-secondary); font-weight: 400; margin-bottom: 1.2rem; text-align: left; flex-grow: 1; }
        .character-tags { display: flex; flex-wrap: wrap; gap: 0.7rem; margin-bottom: 1.5rem; justify-content: flex-start; }
        /* æ¨™ç±¤æ¨£å¼ */
        .keyword-tag-box {
            background-color: rgba(255, 255, 255, 0.08); color: var(--tag-text);
            padding: 6px 14px; border: 1px solid var(--tag-border); border-radius: 4px;
            font-size: 0.85rem; font-weight: 500; white-space: nowrap;
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }
        .keyword-tag-box:hover { background-color: rgba(255, 255, 255, 0.15); color: #e0d6c7; border-color: #a89888; }

        /* Modal å½ˆå‡ºè¦–çª—æ¨£å¼ - å¾®èª¿é¡è‰²å’ŒèƒŒæ™¯ */
        .modal {
            visibility: hidden; opacity: 0; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%; overflow: auto;
            background-color: rgba(44, 32, 23, 0.7); /* æ·±æ£•è‰²åŠé€æ˜èƒŒæ™¯ */
            transition: opacity 0.3s ease-out, visibility 0.3s ease-out;
        }
        .modal.active { visibility: visible; opacity: 1; }
        .modal-content {
            background-color: #fdfaf3; /* æ¯”èƒŒæ™¯ç¨äº®çš„ç´™è‰² */
            padding: 25px; border: 1px solid #dcd3c0; /* æ·»åŠ ç´°é‚Šæ¡† */
            border-radius: 8px; position: relative;
            box-shadow: 0 10px 40px rgba(44, 32, 23, 0.25);
            width: 90%;
            transform: translateY(-20px); opacity: 0;
            transition: opacity 0.3s ease-out 0.1s, transform 0.3s ease-out 0.1s;
        }
        .modal.active .modal-content { transform: translateY(0); opacity: 1; }

        /* ç­†è¨˜æœ¬ Modal - èª¿æ•´æ¨™é¡Œå’Œæ–‡å­—é¡è‰² */
        #notebook-modal .modal-content { margin: 10% auto; max-width: 600px; }
        #notebook-modal h3 { color: var(--text-dark); } /* æ·±è‰²æ¨™é¡Œ */
        #clue-list li { margin-bottom: 0.75rem; font-size: 1.05rem; color: #5c4e43; } /* ç·šç´¢æ–‡å­—é¡è‰² */

        /* è¨­å®š Modal - èª¿æ•´æ¨™é¡Œå’Œæ§åˆ¶é …é¡è‰² */
        #settings-modal .modal-content { position: absolute; top: 4rem; right: 1rem; margin: 0; max-width: 350px; width: auto; }
        #settings-modal h3 { color: var(--text-dark); }
        .settings-controls-grid { display: grid; gap: 0.75rem; }
        .settings-group label { color: #5c4e43; /* æ¨™ç±¤æ–‡å­—é¡è‰² */ width: 50px; text-align: right; flex-shrink: 0;}
        /* Range slider thumb color */
        .settings-group input[type="range"]::-webkit-slider-thumb { background: var(--accent-red); }
        .settings-group input[type="range"]::-moz-range-thumb { background: var(--accent-red); }
        /* Select dropdown arrow color (using SVG) */
        .settings-group select {
             border: 1px solid #c8bfae;
             background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%235c4e43%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
        }
        .settings-group span#settings-speed-display { color: #2c2017; background-color: #e0d6c7; } /* é€Ÿåº¦é¡¯ç¤º */
        .modal-close-button { color: #a89888; } /* é—œé–‰æŒ‰éˆ•é¡è‰² */
        .modal-close-button:hover, .modal-close-button:focus { color: var(--text-dark); }

        /* å ´æ™¯èƒŒæ™¯ - é®ç½©é¡è‰²èª¿æ•´ */
        .scene-background { background-size: cover; background-position: center; min-height: 100vh; transition: background-image 1s ease-in-out; position: relative; display: flex; flex-direction: column; width: 100%; }
        .scene-background::before { content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(44, 32, 23, 0.2); z-index: 1; } /* æ£•è‰²èª¿é®ç½© */
        .scene-content { position: relative; z-index: 2; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }

        /* è¨­å®šæŒ‰éˆ•æ¨£å¼ - é¡è‰²èª¿æ•´ */
        .settings-button-container { position: absolute; top: 1rem; right: 1rem; z-index: 60; }
        .settings-button { background-color: rgba(245, 241, 232, 0.8); /* æŒ‰éˆ•èƒŒæ™¯ */ border: 1px solid rgba(112, 90, 70, 0.3); /* æ·ºæ£•è‰²é‚Šæ¡† */ border-radius: 50%; padding: 0.6rem; cursor: pointer; box-shadow: 0 2px 5px rgba(44, 32, 23, 0.15); transition: background-color 0.2s ease, transform 0.2s ease; display: flex; align-items: center; justify-content: center; }
        .settings-button:hover { background-color: rgba(245, 241, 232, 0.95); transform: scale(1.1); }
        .settings-icon { font-size: 1.3rem; color: #5c4e43; /* åœ–æ¨™é¡è‰² */ line-height: 1; }

        /* å‹•ç•« (ä¿æŒä¸è®Š) */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        #story-display > .dialogue-box, #choices-display > .btn { opacity: 0; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆèª¿æ•´ (ä¿æŒçµæ§‹ï¼Œæ•¸å€¼å¯èƒ½éœ€å¾®èª¿) */
        @media (max-width: 768px) {
            body { font-size: 15px; }
             .modal-content { width: 90%; padding: 20px; }
             #notebook-modal .modal-content { margin: 15% auto; max-width: 90%;}
             #settings-modal .modal-content { top: 3.5rem; right: 0.5rem; max-width: calc(100% - 1rem); width: auto; }
             #character-options { max-width: 95%; gap: 1rem; padding-bottom: 1rem; }
             .character-card { flex-direction: column; }
             .character-image-container { width: 100%; height: 180px; }
             .character-info-container { padding: 1rem; }
             .character-description { font-size: 0.9rem; }
             .dialogue-box { font-size: 1rem; padding-right: 2.5rem; }
             .speak-button { font-size: 1.3rem; top: 0.5rem; right: 0.5rem; }
             .btn { padding: 0.6rem 1.2rem; font-size: 0.95rem;}
             .settings-button-container { top: 0.5rem; right: 0.5rem; }
             .settings-button { padding: 0.5rem; }
             .settings-icon { font-size: 1.1rem; }
             .settings-group label { width: 40px; font-size: 0.8rem;}
             .settings-group input[type="range"] { min-width: 80px; }
             .settings-group select { min-width: 120px; font-size: 0.8rem;}
             .settings-group .btn-small { font-size: 0.75rem;}
             .settings-group span#settings-speed-display { font-size: 0.75rem; min-width: 35px;}

        }
        @media (max-width: 480px) {
             body { font-size: 14px; }
             .character-image-container { height: 150px; }
             .character-info-container h3 { font-size: 1.2rem;}
             .character-description { font-size: 0.85rem; }
             .keyword-tag-box { font-size: 0.75rem; padding: 4px 10px;}
             .btn-select-char { font-size: 0.9rem;}
             .dialogue-box { font-size: 0.95rem; }
             .btn { padding: 0.5rem 1rem; font-size: 0.9rem; }
             #settings-modal .modal-content { max-width: calc(100% - 1rem); }
             .settings-group label { width: 35px; }
             .settings-group .control-container { gap: 0.25rem; }
             .settings-group select { min-width: 100px; }
        }

         /* ç”¨æ–¼æ—¥å¤œè®ŠåŒ–çš„é®ç½© */
        .time-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(20, 20, 40, 0.35); /* æ·±è—ç´«è‰²èª¿å¤œæ™š */
            z-index: 1; pointer-events: none;
            transition: background-color 0.8s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800"> <div id="game-container" class="container mx-auto p-0 md:p-4 max-w-none md:max-w-4xl min-h-screen flex flex-col">

        <div class="settings-button-container">
            <button id="open-settings-button" class="settings-button" title="éŠæˆ²è¨­å®š">
                <span class="settings-icon">âš™ï¸</span>
            </button>
        </div>

        <div id="start-screen" class="flex flex-col items-center justify-center flex-grow scene-background" style=""> <div class="scene-content text-center p-4">
                <div class="bg-black bg-opacity-75 p-8 md:p-10 rounded-lg shadow-xl text-white max-w-xl mx-auto">
                    <h1 class="text-5xl font-bold mb-6 game-title-gradient">è’¼é¾å¯†å‡½</h1>
                    <p class="mb-3 text-lg leading-relaxed"><span class="keyword">é’åŸæ´¾</span>å¸«é–€çªé­è®Šæ•…ï¼Œå¸«çˆ¶è‡¨çµ‚å‰æ‰˜ä»˜ä¸€å°<span class="keyword">å¯†å‡½</span>ï¼ŒæŒ‡æ˜éœ€é€å¾€<span class="keyword">è’¼é¾å±±</span><span class="keyword">å¤å…ˆç”Ÿ</span>è™•ã€‚</p>
                    <p class="mb-6 text-lg leading-relaxed">æ“šèæ­¤<span class="keyword">å¯†å‡½</span>é—œä¿‚é‡å¤§ï¼Œ<span class="keyword">æ±Ÿæ¹–</span>å„è·¯äººé¦¬çš†å¯èƒ½å‡ºæ‰‹<span class="keyword">æˆªæ®º</span>ã€‚ä½ ï¼Œèƒ½å¦çªç ´é‡åœï¼Œå®Œæˆå¸«çˆ¶éºå‘½ï¼Ÿ<span title="Sword">ğŸ—¡ï¸</span></p>
                    <div class="text-gray-300 mb-8 space-y-2">
                        <p class="start-info-text">å»ºè­°éŠç©äººæ•¸ï¼š<span>1</span> äºº</p>
                        <p class="start-info-text">é è¨ˆç¸½æ™‚é•·ï¼šç´„ <span>15-25</span> åˆ†é˜</p>
                        <p class="start-info-text">é›£åº¦ï¼š<span>â˜…â˜…â˜†â˜†â˜†</span> (å…¥é–€)</p>
                    </div>
                    <button id="start-game-button" class="btn text-lg btn-gold">è¸å…¥æ±Ÿæ¹–</button>
                    <button id="load-game-button" class="btn btn-secondary text-lg mt-2 md:mt-0 md:ml-4 hidden">è®€å–é€²åº¦</button>
                </div>
            </div>
        </div>

        <div id="character-select-screen" class="hidden flex flex-col items-center justify-center flex-grow scene-background" style=""> <div class="scene-content w-full flex flex-col items-center p-4">
                 <h2 class="text-3xl font-bold mb-8 text-center text-gray-100 chapter-title-style">é¸æ“‡ä½ çš„èº«ä»½</h2>
                 <div id="character-options" class="flex flex-col gap-6 w-full max-w-lg">
                     </div>
                 <p class="text-center mt-8 text-gray-300">ä¸åŒèº«ä»½å°‡å½±éŸ¿ä½ çš„åˆå§‹<span class="keyword">ç·šç´¢</span>å’Œæ‡‰å°æ–¹å¼ã€‚</p>
             </div>
        </div>

        <div id="game-screen" class="hidden flex flex-col flex-grow scene-background" style=""> <div class="scene-content flex-grow flex flex-col p-4 md:p-6">
                <div class="bg-black bg-opacity-75 p-4 md:p-6 rounded-lg shadow-lg flex-grow flex flex-col max-w-4xl mx-auto w-full">
                    <h2 id="chapter-title" class="text-2xl font-bold mb-4 text-white text-center chapter-title-style"></h2>
                    <div id="character-status" class="mb-4 p-3 bg-white bg-opacity-90 rounded-lg flex items-center shadow">
                        <img id="player-avatar-game" src="" alt="ç©å®¶é ­åƒ" class="w-12 h-12 rounded-full mr-4 border-2 border-amber-600 shadow-md">
                        <div class="flex-grow">
                            <p id="player-name-game" class="font-bold text-gray-800"></p>
                            <p id="current-objective" class="text-sm text-gray-600"></p>
                        </div>
                         <button id="notebook-button" class="btn btn-secondary ml-4">æ±Ÿæ¹–ç­†è¨˜ <span title="Scroll">ğŸ“œ</span></button>
                         <button id="save-game-button" class="btn btn-secondary ml-2">å„²å­˜é€²åº¦ <span title="Save">ğŸ’¾</span></button>
                    </div>
                    <div id="story-display" class="flex-grow overflow-y-auto mb-4 p-4 bg-white bg-opacity-95 rounded-lg shadow-inner min-h-[300px] max-h-[55vh]"></div>
                    <div id="choices-display" class="mt-auto text-center"></div>
                </div>
            </div>
        </div>

        <div id="ending-screen" class="hidden flex flex-col items-center justify-center flex-grow scene-background" style=""> <div class="scene-content text-center p-4">
                <div class="bg-fdfaf3 bg-opacity-95 p-8 md:p-10 rounded-lg shadow-xl max-w-lg mx-auto border border-amber-700">
                    <h2 id="ending-title" class="text-4xl font-bold mb-6 text-amber-800"></h2>
                    <p id="ending-description" class="mb-8 text-gray-700 leading-relaxed"></p>
                    <button id="restart-button" class="btn text-lg btn-gold">é‡å…¥æ±Ÿæ¹– <span title="Restart">ğŸ”„</span></button>
                </div>
            </div>
        </div>

        <div id="notebook-modal" class="modal">
            <div class="modal-content">
                <span class="modal-close-button" onclick="closeNotebook()">&times;</span>
                <h3 class="text-xl font-bold mb-4 text-gray-800">æ±Ÿæ¹–ç­†è¨˜ <span title="Scroll">ğŸ“œ</span></h3>
                <ul id="clue-list" class="list-disc list-inside text-gray-700 space-y-2">
                    <li>å°šæœªç²å¾—ä»»ä½•<span class="keyword">ç·šç´¢</span>ã€‚</li>
                </ul>
            </div>
        </div>

        <div id="settings-modal" class="modal">
            <div class="modal-content">
                <span class="modal-close-button" onclick="closeSettings()">&times;</span>
                <h3 class="text-xl font-bold mb-6 text-gray-800 text-center">éŠæˆ²è¨­å®š âš™ï¸</h3>
                <div class="settings-controls-grid">
                    <div class="settings-group">
                         <label for="settings-volume-slider">éŸ³é‡:</label>
                         <div class="control-container">
                             <input type="range" id="settings-volume-slider" min="0" max="1" step="0.1" value="0.5">
                             <button id="settings-mute-button" class="btn btn-secondary btn-small">éœéŸ³</button>
                         </div>
                    </div>
                    <div class="settings-group speed-control">
                         <label for="settings-speed-display">é€Ÿåº¦:</label>
                         <div class="control-container">
                             <button id="settings-speed-down-button" class="btn btn-secondary btn-small">-</button>
                             <span id="settings-speed-display">x1.0</span>
                             <button id="settings-speed-up-button" class="btn btn-secondary btn-small">+</button>
                         </div>
                    </div>
                    <hr class="my-2 border-gray-300 col-span-full">
                    <div class="settings-group">
                         <label for="settings-tts-voice">èªéŸ³:</label>
                         <div class="control-container">
                             <select id="settings-tts-voice" name="tts-voice"></select>
                         </div>
                    </div>
                    <div class="settings-group">
                         <label for="settings-tts-rate">èªé€Ÿ:</label>
                         <div class="control-container">
                             <input type="range" id="settings-tts-rate" min="0.5" max="2" step="0.1" value="1">
                         </div>
                    </div>
                    <div class="settings-group">
                         <label for="settings-tts-pitch">éŸ³é«˜:</label>
                         <div class="control-container">
                             <input type="range" id="settings-tts-pitch" min="0" max="2" step="0.1" value="1">
                         </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- DOM å…ƒç´ ç²å– ---
        const gameContainer = document.getElementById('game-container');
        const startScreen = document.getElementById('start-screen');
        const characterSelectScreen = document.getElementById('character-select-screen');
        const gameScreen = document.getElementById('game-screen');
        const endingScreen = document.getElementById('ending-screen');
        const startGameButton = document.getElementById('start-game-button');
        const characterOptionsContainer = document.getElementById('character-options');
        const chapterTitle = document.getElementById('chapter-title');
        const storyDisplay = document.getElementById('story-display');
        const choicesDisplay = document.getElementById('choices-display');
        const endingTitle = document.getElementById('ending-title');
        const endingDescription = document.getElementById('ending-description');
        const restartButton = document.getElementById('restart-button');
        const playerAvatarGame = document.getElementById('player-avatar-game');
        const playerNameGame = document.getElementById('player-name-game');
        const currentObjective = document.getElementById('current-objective');
        const notebookButton = document.getElementById('notebook-button');
        const notebookModal = document.getElementById('notebook-modal');
        const clueList = document.getElementById('clue-list');
        const openSettingsButton = document.getElementById('open-settings-button');
        const settingsModal = document.getElementById('settings-modal');
        const settingsVolumeSlider = document.getElementById('settings-volume-slider');
        const settingsMuteButton = document.getElementById('settings-mute-button');
        const settingsSpeedDownButton = document.getElementById('settings-speed-down-button');
        const settingsSpeedDisplay = document.getElementById('settings-speed-display');
        const settingsSpeedUpButton = document.getElementById('settings-speed-up-button');
        const settingsTtsVoiceSelect = document.getElementById('settings-tts-voice');
        const settingsTtsRateSlider = document.getElementById('settings-tts-rate');
        const settingsTtsPitchSlider = document.getElementById('settings-tts-pitch');
        const loadGameButton = document.getElementById('load-game-button');
        const saveGameButton = document.getElementById('save-game-button');

        // --- éŠæˆ²ç‹€æ…‹è®Šæ•¸ ---
        let currentChapter = 0;
        let currentStoryNodeId = null;
        let chosenCharacter = null;
        let selectedCharacterIdTemp = null;
        let collectedClues = [];
        let gameState = {};
        let isMuted = false;
        let currentVolume = 0.5;
        let typewriterTimeout = null;
        let isAudioInitialized = false;
        let audioContextRequiresInteraction = true;
        const BASE_TYPEWRITER_SPEED = 35;
        let typewriterSpeed = BASE_TYPEWRITER_SPEED;
        const MAX_SPEED = 5;
        const MIN_SPEED = 90;
        const SPEED_STEP = 5;
        let availableVoices = [];
        let selectedVoice = null;
        let currentTtsRate = 1;
        let currentTtsPitch = 1;
        let currentUtterance = null;
        let lastSpokenText = "";
        let lastSpeakButton = null;
        let isSpeechPaused = false;
        let populateVoiceListAttempts = 0;
        let currentTimeOfDay = 'day';
        const SAVE_GAME_KEY = 'wuxiaAdventureSaveData';

        // --- éŸ³æ•ˆåˆæˆå™¨ ---
        let sfxPlayer = null;
        let synth = null;

        // --- æ­¦ä¿ é—œéµå­—åˆ—è¡¨ ---
        const keywords = ["é›²é£›", "è¶™å®¢", "å»–æŒæ«ƒ", "é»‘è¡£åŠå®¢", "å¤å…ˆç”Ÿ", "é’åŸæ´¾", "å¯†å‡½", "è’¼é¾å±±", "é¾è›‡é®", "æ±Ÿæ¹–", "å…§åŠ›", "è¼•åŠŸ", "åŠæ³•", "åˆ€æ³•", "ä»¤ç‰Œ", "å®¢æ£§", "æˆªæ®º", "è¿½è¹¤", "ç§˜å¯¶", "ç·šç´¢", "é»‘é¢¨å¯¨", "å®˜åºœ", "å¸«çˆ¶", "éºå‘½", "ç›¤çº", "é«˜æ‰‹", "åŸ‹ä¼", "æ‰“æ¢", "æ®ºæ°£"];

        // --- æ­¦ä¿ è§’è‰²è³‡æ–™ (é ­åƒå·²æ›´æ–°ç‚ºä½ æä¾›çš„é€£çµ) ---
        const characters = {
             discipleYun: {
                 id: 'discipleYun', name: 'é›²é£› (é’åŸæ´¾å¼Ÿå­)',
                 // *** æ›´æ–°ç‚ºä½ æä¾›çš„ GitHub Pages é€£çµ ***
                 avatar: 'https://t242642911.github.io/kevinboy/ON4I7KVzoYS7AZ_sPkg0j.png',
                 description: 'ä½ æ˜¯<span class="keyword">é’åŸæ´¾</span>æ–°å…¥é–€çš„å¼Ÿå­ï¼Œæ€§æ ¼è€¿ç›´ï¼Œ<span class="keyword">åŠæ³•</span>åˆæˆã€‚è¿‘æ—¥<span class="keyword">å¸«çˆ¶</span>æ…˜é­æ©«ç¦ï¼Œè‡¨çµ‚å‰æ‰˜ä»˜ä¸€å°<span class="keyword">å¯†å‡½</span>èˆ‡ä¸€æš<span class="keyword">ä»¤ç‰Œ</span>ï¼Œå‘½ä½ å‹™å¿…é€è‡³<span class="keyword">è’¼é¾å±±</span><span class="keyword">å¤å…ˆç”Ÿ</span>æ‰‹ä¸­ã€‚ä½ æ‡·æ£<span class="keyword">å¾©ä»‡</span>ä¹‹å¿µèˆ‡å¸«é–€<span class="keyword">éºå‘½</span>ï¼Œè¸å…¥<span class="keyword">æ±Ÿæ¹–</span>ã€‚',
                 tags: ["æ­£ç›´", "åŠæ³•æ–°ç§€", "å¸«é–€éºå‘½", "é’åŸæ´¾"],
                 startNode: 'chapter1_start_yunfei'
             },
             wandererZhao: {
                 id: 'wandererZhao', name: 'è¶™å®¢ (æ±Ÿæ¹–éŠä¿ )',
                 // *** æ›´æ–°ç‚ºä½ æä¾›çš„ GitHub Pages é€£çµ ***
                 avatar: 'https://t242642911.github.io/kevinboy/XI43p3GUcIHgbgrXXKpy7.png',
                 description: 'ä½ æ˜¯ä¸€åç¨è¡Œ<span class="keyword">æ±Ÿæ¹–</span>çš„éŠä¿ ï¼Œ<span class="keyword">åˆ€æ³•</span>å‡Œå²ï¼Œ<span class="keyword">è¼•åŠŸ</span>ä¸ä¿—ã€‚ä½ ç¿’æ…£äº†è‡ªç”±è‡ªåœ¨ï¼Œä¸å—é–€æ´¾æ‹˜æŸï¼Œåªæ†‘å–œå¥½è¡Œäº‹ã€‚è½èè¿‘æ—¥<span class="keyword">é¾è›‡é®</span>é™„è¿‘ä¼¼æœ‰<span class="keyword">ç§˜å¯¶</span>ç¾ä¸–çš„æ¶ˆæ¯ï¼Œç‰¹ä¾†æ­¤åœ°ä¸€æ¢ç©¶ç«Ÿã€‚',
                 tags: ["éŠä¿ ", "åˆ€æ³•å‡Œå²", "è¼•åŠŸä¸ä¿—", "ä¸ç¾ˆ"],
                 startNode: 'chapter1_start_zhao'
             }
        };

        // --- æ­¦ä¿ å ´æ™¯èƒŒæ™¯ (å·²æ›´æ–°ç‚ºä½ æä¾›çš„é€£çµ) ---
        const sceneBackgrounds = {
             start: 'https://t242642911.github.io/kevinboy/%E5%9C%96%E4%B8%80.png',
             characterSelect: 'https://t242642911.github.io/kevinboy/%E5%9C%96%E4%BA%8C.png',
             townStreet: 'https://t242642911.github.io/kevinboy/%E5%9C%96%E4%B8%89.png',
             inn: 'https://t242642911.github.io/kevinboy/%E5%9C%96%E5%9B%9B.png',
             forestPath: 'https://t242642911.github.io/kevinboy/%E6%9E%97%E9%96%93%E5%B0%8F%E8%B7%AF%E5%B1%B1%E8%B7%AF%20(forestPath).png',
             mountainPass: 'placeholder/wuxia_mountain_pass_bg.jpg', // é€™å€‹é‚„æ²’æä¾›ï¼Œä¿ç•™ placeholder æˆ–ä½¿ç”¨å…¶ä»–åœ–
             ending: 'https://t242642911.github.io/kevinboy/%E7%B5%90%E5%B1%80%E7%95%AB%E9%9D%A2%E8%83%8C%E6%99%AF.png'
        };

        // --- æ­¦ä¿ æ•…äº‹åŠ‡æƒ… ---
        // [æ­¤è™•çœç•¥èˆ‡ä¸Šä¸€å›ç­”ç›¸åŒçš„ story ç‰©ä»¶ä»£ç¢¼ï¼Œä»¥ä¿æŒå›æ‡‰ç°¡æ½”]
        // [è«‹ç¢ºä¿ä½¿ç”¨ä¸Šä¸€å›ç­”ä¸­çš„ story ç‰©ä»¶]
         const story = {
            chapter1_intro: { type: 'narration', title: 'åºç« ï¼šé¾è›‡ä¹‹åœ°', text: (name) => `åºç« ï¼šé¾è›‡ä¹‹åœ° ğŸ\n\n<span class="keyword">æ±Ÿæ¹–</span>é¢¨æ³¢æƒ¡ï¼Œäººé–“è¡Œè·¯é›£ã€‚ç„¡è«–ä½ æ˜¯èº«è² <span class="keyword">éºå‘½</span>çš„<span class="keyword">é’åŸæ´¾</span>å¼Ÿå­ ${name}ï¼Œé‚„æ˜¯è¿½å°‹<span class="keyword">ç§˜å¯¶</span>çš„<span class="keyword">æ±Ÿæ¹–</span><span class="keyword">éŠä¿ </span> ${name}ï¼Œä½ çš„é“è·¯éƒ½æŒ‡å‘äº†é€™å€‹ä¸‰æ•™ä¹æµæ··é›œä¹‹åœ° â€”â€” <span class="keyword">é¾è›‡é®</span>ã€‚é®å£çš„ã€Œè¿é¢¨<span class="keyword">å®¢æ£§</span>ã€æ˜¯å”¯ä¸€çš„è½è…³é»ã€‚`, next: (id) => characters[id].startNode, background: sceneBackgrounds.townStreet, objective: "é€²å…¥è¿é¢¨å®¢æ£§" },
            chapter1_start_yunfei: { type: 'dialogue', character: 'é›²é£›', text: "ï¼ˆå…§å¿ƒï¼‰é€™<span class=\"keyword\">é¾è›‡é®</span>æœç„¶åä¸è™›å‚³ï¼Œä¾†å¾€ä¹‹äººçœ¼ç¥é–ƒçˆï¼Œé ˆè™•è™•å°å¿ƒã€‚<span class=\"keyword\">å¯†å‡½</span>ä¹‹äº‹çµ•ä¸å¯æ´©éœ²ã€‚å…ˆé€²<span class=\"keyword\">å®¢æ£§</span>æ­‡è…³ï¼Œé †ä¾¿<span class=\"keyword\">æ‰“æ¢</span>ä¸€ä¸‹å‰å¾€<span class=\"keyword\">è’¼é¾å±±</span>çš„è·¯ã€‚", background: sceneBackgrounds.inn, next: 'chapter1_inn_common' },
            chapter1_start_zhao: { type: 'dialogue', character: 'è¶™å®¢', text: "å‘µï¼Œ<span class=\"keyword\">é¾è›‡é®</span>ï¼Œåå­—å€’æŒºå½¢è±¡ã€‚å¸Œæœ›èƒ½åœ¨æ­¤è™•æ‰¾åˆ°äº›é—œæ–¼<span class=\"keyword\">ç§˜å¯¶</span>çš„<span class=\"keyword\">ç·šç´¢</span>ã€‚å…ˆå»é‚£ã€Œè¿é¢¨<span class=\"keyword\">å®¢æ£§</span>ã€å–æ¯é…’ï¼Œè½è½é¢¨è²ã€‚", background: sceneBackgrounds.inn, next: 'chapter1_inn_common' },
            chapter1_inn_common: { type: 'narration', title: 'ç¬¬ä¸€ç« ï¼šè¿é¢¨å®¢æ£§', text: "ä½ èµ°é€²è¿é¢¨<span class=\"keyword\">å®¢æ£§</span>ï¼Œå¤§å ‚è£¡é —ç‚ºç†±é¬§ã€‚å¹¾æ¡Œ<span class=\"keyword\">æ±Ÿæ¹–</span>äººå£«æ­£åœ¨æ¨æ¯æ›ç›ï¼Œè§’è½è£¡åè‘—ä¸€å€‹ç¨è‡ªé£²é…’çš„<span class=\"keyword\">é»‘è¡£åŠå®¢</span>ï¼Œæ«ƒæª¯å¾Œ<span class=\"keyword\">å»–æŒæ«ƒ</span>æ­£æ’¥è‘—ç®—ç›¤ã€‚", objective: "æ‰“æ¢æ¶ˆæ¯æˆ–å°‹æ‰¾ç·šç´¢", choices: [ { text: "æ‰¾å€‹ä½å­åä¸‹ï¼Œè§€å¯Ÿå››å‘¨ <span title='Eyes'>ğŸ‘€</span>", next: 'chapter1_observe_inn', sfx: 'ui' }, { text: "å‘<span class=\"keyword\">å»–æŒæ«ƒ</span>è¦é–“å®¢æˆ¿ <span title='Talk'>ğŸ—£ï¸</span>", next: 'chapter1_talk_liao_room', sfx: 'ui' }, { text: "ç•™æ„é‚£<span class=\"keyword\">é»‘è¡£åŠå®¢</span> <span title='Thinking'>ğŸ¤”</span>", next: 'chapter1_observe_swordsman', sfx: 'ui' } ] },
            chapter1_observe_inn: { type: 'narration', text: "ä½ æ‰¾äº†å€‹ä¸é¡¯çœ¼çš„è§’è½åä¸‹ï¼Œé»äº†äº›ç²—èŒ¶æ·¡é£¯ã€‚é„°æ¡Œçš„è«‡è©±å¤§å¤šæ˜¯äº›<span class=\"keyword\">æ±Ÿæ¹–</span>ç‘£äº‹ï¼Œä½†ä½ éš±ç´„è½åˆ°æœ‰äººæèµ·ã€Œ<span class=\"keyword\">è’¼é¾å±±</span>æœ€è¿‘ä¸å¤ªå¹³ã€ã€ã€Œå¥½åƒæœ‰<span class=\"keyword\">å®˜åºœ</span>çš„äººåœ¨é™„è¿‘æ´»å‹•ã€ã€‚", action: () => { addClue("è’¼é¾å±±é™„è¿‘æœ€è¿‘ä¸å¤ªå¹³ï¼Œå¯èƒ½æœ‰å®˜åºœæ´»å‹•ã€‚"); }, next: 'chapter1_inn_common_post_observe' },
            chapter1_talk_liao_room: { type: 'dialogue', character: 'å»–æŒæ«ƒ', text: "å®¢å®˜ä¸€ä½ï¼Ÿä½åº—é‚„æ˜¯æ‰“å°–ï¼Ÿå°åº—è¦çŸ©ï¼Œ<span class=\"keyword\">ç›¤çº</span>å…ˆä»˜ã€‚çœ‹å®¢å®˜é¢ç”Ÿå¾—å¾ˆå‘ã€‚", choices: [ { text: "ä»˜éŒ¢ä½åº—ï¼Œé †ä¾¿<span class=\"keyword\">æ‰“æ¢</span><span class=\"keyword\">è’¼é¾å±±</span>çš„è·¯", next: 'chapter1_ask_liao_canglong', condition: (id) => id === 'discipleYun', sfx: 'confirm' }, { text: "ä»˜éŒ¢ä½åº—ï¼Œ<span class=\"keyword\">æ‰“æ¢</span>æœ€è¿‘é®ä¸Šçš„å‚³è", next: 'chapter1_ask_liao_rumor', condition: (id) => id === 'wandererZhao', sfx: 'confirm' }, { text: "åªè¦ä¸€é–“æˆ¿ï¼Œä¸å¤šå•", next: 'chapter1_get_room', sfx: 'confirm'} ] },
            chapter1_observe_swordsman: { type: 'narration', text: "é‚£<span class=\"keyword\">é»‘è¡£åŠå®¢</span>ç¨è‡ªååœ¨è§’è½ï¼Œé¢å‰åªæœ‰ä¸€å£ºé…’ï¼Œçœ¼ç¥éŠ³åˆ©å¦‚é·¹ï¼Œè…°é–“çš„åŠé˜å¤æ¨¸ç„¡è¯ï¼Œå»éš±éš±é€å‡ºä¸€è‚¡<span class=\"keyword\">æ®ºæ°£</span>ã€‚ä»–ä¼¼ä¹ä¹Ÿåœ¨ç•™æ„è‘—<span class=\"keyword\">å®¢æ£§</span>ä¸­çš„æ¯ä¸€å€‹äººã€‚", action: () => { addClue("å®¢æ£§è§’è½æœ‰å€‹å¯ç–‘çš„é»‘è¡£åŠå®¢ï¼Œé€è‘—æ®ºæ°£ã€‚"); updateGameState('noticedSwordsman', true); }, next: 'chapter1_inn_common_post_observe' },
            chapter1_ask_liao_canglong: { type: 'dialogue', character: 'å»–æŒæ«ƒ', text: "<span class=\"keyword\">è’¼é¾å±±</span>ï¼Ÿé‚£åœ°æ–¹ååƒ»å¾—å¾ˆï¼Œå±±è·¯éšªå³»ï¼Œè½èªªæœ€è¿‘é‚„æœ‰çŒ›ç¸å’Œ...ä¸æ˜èº«ä»½çš„äººå‡ºæ²’ã€‚å®¢å®˜è‹¥è¦å»ï¼Œå¯å¾—åƒè¬å°å¿ƒã€‚å¾é®æ±é ­å‡ºå»ï¼Œæ²¿è‘—æ²³èµ°ï¼Œçœ‹åˆ°ä¸‰æ£µå¤§æŸ³æ¨¹å·¦æ‹ä¾¿æ˜¯ä¸Šå±±çš„è·¯ã€‚", action: () => { addClue("å¾—çŸ¥å‰å¾€è’¼é¾å±±çš„è·¯ï¼ŒæŒæ«ƒæé†’è·¯ä¸Šå±éšªã€‚"); updateGameState('knowsPath', true); }, next: 'chapter1_get_room' },
            chapter1_ask_liao_rumor: { type: 'dialogue', character: 'å»–æŒæ«ƒ', text: "é®ä¸Šçš„å‚³èï¼Ÿå‘µå‘µï¼Œ<span class=\"keyword\">æ±Ÿæ¹–</span>å‚³èå¤šå¦‚ç‰›æ¯›ã€‚ä¸éæœ€è¿‘å€’æ˜¯è½èªªï¼Œæœ‰äººåœ¨<span class=\"keyword\">è’¼é¾å±±</span>é™„è¿‘è¦‹éå¥‡ç•°éœå…‰ï¼Œç–‘æœ‰<span class=\"keyword\">ç§˜å¯¶</span>ç¾ä¸–...æ˜¯çœŸæ˜¯å‡å°±ä¸çŸ¥é“äº†ã€‚ä¸å°‘<span class=\"keyword\">é«˜æ‰‹</span>éƒ½å¾€é‚£é‚Šå»äº†ã€‚", action: () => { addClue("æŒæ«ƒè­‰å¯¦è’¼é¾å±±é™„è¿‘å¯èƒ½æœ‰ç§˜å¯¶ç¾ä¸–çš„å‚³èã€‚"); updateGameState('heardTreasureRumor', true); }, next: 'chapter1_get_room' },
            chapter1_get_room: { type: 'narration', text: "ä½ ä»˜äº†<span class=\"keyword\">ç›¤çº</span>ï¼Œæ‹¿åˆ°äº†æˆ¿é–“é‘°åŒ™ã€‚å¤©è‰²å·²æ™šï¼Œä½ æ±ºå®šå…ˆä¼‘æ¯ä¸€æ™šï¼Œæ˜æ—¥å†åšæ‰“ç®—ã€‚", next: 'chapter1_night_event_check' },
            chapter1_inn_common_post_observe: { type: 'narration', text: "ä½ ç¹¼çºŒç•™åœ¨<span class=\"keyword\">å®¢æ£§</span>å¤§å ‚ã€‚", choices: [ { text: "å‘<span class=\"keyword\">å»–æŒæ«ƒ</span>è¦é–“å®¢æˆ¿", next: 'chapter1_talk_liao_room', sfx: 'ui' }, { text: "ç•™æ„é‚£<span class=\"keyword\">é»‘è¡£åŠå®¢</span>", next: 'chapter1_observe_swordsman', condition: () => !gameState.noticedSwordsman, sfx: 'ui' }, { text: "èµ·èº«é›¢é–‹<span class=\"keyword\">å®¢æ£§</span>ï¼Œåœ¨é®ä¸Šé€›é€› (æš«æœªé–‹æ”¾)", next: 'chapter1_inn_common_post_observe', sfx: 'ui_close'} ] },
            chapter1_night_event_check: { type: 'narration', text: "å¤œæ·±äººéœï¼Œä½ å›åˆ°æˆ¿é–“æº–å‚™ä¼‘æ¯ã€‚", action: () => { currentTimeOfDay = 'night'; updateVisualsBasedOnTime(); }, next: () => { if (gameState.noticedSwordsman && Math.random() < 0.7) return 'chapter1_night_swordsman_encounter'; else return 'chapter1_end_day1'; } },
            chapter1_night_swordsman_encounter: { type: 'narration', title: "ç¬¬ä¸€ç« ï¼šæ·±å¤œé­…å½±", text: "å°±åœ¨ä½ å°‡è¦å…¥ç¡æ™‚ï¼Œçª—å¤–å‚³ä¾†è¼•å¾®çš„ç ´ç©ºä¹‹è²ï¼ä½ çŒ›åœ°é©šé†’ï¼Œåªè¦‹ä¸€é“é»‘å½±å¦‚é¬¼é­…èˆ¬ç©¿çª—è€Œå…¥ï¼Œç›´æ’²ä½ æ‡·ä¸­è€Œä¾†ï¼æ­¤äººèº«æ³•æ¥µå¿«ï¼Œé¡¯ç„¶æ˜¯å€‹<span class=\"keyword\">è¼•åŠŸ</span><span class=\"keyword\">é«˜æ‰‹</span>ï¼Œç›®æ¨™ä¼¼ä¹æ˜¯ä½ èº«ä¸Šçš„æŸæ¨£æ±è¥¿ï¼", objective: "æ“Šé€€æˆ–èº²é¿å¤œè¥²è€…", background: sceneBackgrounds.inn, choices: [ { text: "æ‹”åŠï¼ˆæˆ–åˆ€ï¼‰è¿æ“Š <span title='Sword'>âš”ï¸</span>", next: 'chapter1_night_fight', sfx: 'action' }, { text: "æ–½å±•<span class=\"keyword\">è¼•åŠŸ</span>èº²é¿ <span title='Run'>ğŸ’¨</span>", next: 'chapter1_night_dodge', sfx: 'action' }, { text: "å¤§å–ç¤ºè­¦ï¼Œè™›å¼µè²å‹¢ <span title='Shout'>ğŸ—£ï¸</span>", next: 'chapter1_night_shout', sfx: 'action' } ] },
            chapter1_night_fight: { type: 'narration', text: () => { let outcomeText = ""; if (chosenCharacter.id === 'wandererZhao') { outcomeText = "ä½ åæ‡‰æ¥µå¿«ï¼Œé †æ‰‹æŠ„èµ·ä½©åˆ€ä¾¿æ˜¯ä¸€è¨˜æ©«æ–¬ï¼<span class=\"keyword\">é»‘è¡£åŠå®¢</span>ä¼¼ä¹æ²’æ–™åˆ°ä½ åæ‡‰å¦‚æ­¤è¿…é€Ÿï¼Œæ€¥å¿™å´èº«é¿é–‹ï¼Œæ”»å‹¢ç¨ç·©ã€‚"; updateGameState('swordsmanHesitated', true); } else { outcomeText = "ä½ å€‰ä¿ƒæ‹”åŠæŠµæ“‹ï¼Œåªè¦ºå°æ–¹<span class=\"keyword\">å…§åŠ›</span>æ·±åšï¼ŒåŠæ‹›ï¼ˆæˆ–æ‰‹æ³•ï¼‰ç‹ è¾£ï¼Œä½ å ªå ªæ“‹ä½å¹¾æ‹›ï¼Œä¾¿æ„Ÿåˆ°æ‰‹è‡‚ç™¼éº»ï¼Œéšªè±¡ç’°ç”Ÿï¼"; updateGameState('disadvantageFight', true); } return outcomeText; }, next: 'chapter1_night_after_action' },
            chapter1_night_dodge: { type: 'narration', text: () => { let outcomeText = ""; if (chosenCharacter.id === 'wandererZhao') outcomeText = "ä½ è…³ä¸‹ç™¼åŠ›ï¼Œ<span class=\"keyword\">è¼•åŠŸ</span>å±•é–‹ï¼Œéšªä¹‹åˆéšªåœ°é¿é–‹äº†å°æ–¹çš„æ’²æ“Šã€‚é‚£<span class=\"keyword\">é»‘è¡£åŠå®¢</span>ä¸€æ“Šä¸ä¸­ï¼Œä¼¼ä¹æœ‰äº›æ„å¤–ã€‚"; else outcomeText = "ä½ æ€¥å¿™å‘å¾Œç¿»æ»¾èº²é¿ï¼Œé›–ç„¶ç‹¼ç‹½ï¼Œä½†ä¹Ÿç®—é¿é–‹äº†å°æ–¹çš„ç¬¬ä¸€æ“Šã€‚é‚£<span class=\"keyword\">é»‘è¡£åŠå®¢</span>çš„èº«å½±åœ¨ä½ åŸä¾†çš„ä½ç½®åœé “äº†ä¸€ä¸‹ã€‚"; return outcomeText; }, action: () => { updateGameState('dodgedAttack', true); }, next: 'chapter1_night_after_action' },
            chapter1_night_shout: { type: 'narration', text: "ä½ çŒ›åœ°å¤§å–ä¸€è²ï¼šã€Œæœ‰<span class=\"keyword\">åˆºå®¢</span>ï¼ã€è²éŸ³åœ¨å¯‚éœçš„<span class=\"keyword\">å®¢æ£§</span>ä¸­è¿´ç›ªã€‚é‚£<span class=\"keyword\">é»‘è¡£åŠå®¢</span>å‹•ä½œä¸€æ»¯ï¼Œä¼¼ä¹æœ‰äº›é²ç–‘ï¼Œå¤§æ¦‚æ˜¯æ€•é©šå‹•<span class=\"keyword\">å®¢æ£§</span>ä¸­çš„å…¶ä»–<span class=\"keyword\">é«˜æ‰‹</span>æˆ–<span class=\"keyword\">å®˜åºœ</span>ã€‚", action: () => { updateGameState('shouted', true); }, next: 'chapter1_night_after_action' },
            chapter1_night_after_action: { type: 'narration', text: "é‚£<span class=\"keyword\">é»‘è¡£åŠå®¢</span>è¦‹ä¸€æ“Šä¸æˆï¼Œä¸å†æˆ€æˆ°ï¼Œèº«å½¢ä¸€æ™ƒï¼Œå†æ¬¡å¾çª—å£ç«„å‡ºï¼Œå¹¾å€‹èµ·è½ä¾¿æ¶ˆå¤±åœ¨å¤œè‰²ä¸­ã€‚", action: () => { addClue("æ·±å¤œé­åˆ°é»‘è¡£äººè¥²æ“Šï¼Œå°æ–¹è¼•åŠŸå¾ˆé«˜ï¼Œç›®æ¨™ä¸æ˜ã€‚"); updateGameState('encounteredSwordsman', true); }, next: 'chapter1_end_day1_after_encounter' },
            chapter1_end_day1_after_encounter:{ type: 'narration', text: "ä½ å¿ƒæœ‰é¤˜æ‚¸ï¼Œæª¢æŸ¥äº†ä¸€ä¸‹é–€çª—ï¼Œçœ‹ä¾†ä»Šæ™šæ˜¯ç„¡æ³•å®‰ç¡äº†ã€‚å¤©äº®å¾Œå¿…é ˆç›¡å¿«é›¢é–‹é€™å€‹æ˜¯éä¹‹åœ°ã€‚", action: () => { currentChapter = 2; currentTimeOfDay = 'day'; updateVisualsBasedOnTime();}, next: 'chapter2_start', background: sceneBackgrounds.inn },
            chapter1_end_day1: { type: 'narration', text: "ä¸€å¤œç„¡è©±ã€‚ç¬¬äºŒå¤©æ¸…æ™¨ï¼Œé™½å…‰é€éçª—æ«ºç‘é€²æˆ¿é–“ã€‚ä½ æ•´ç†å¥½è¡Œè£ï¼Œæº–å‚™ç¹¼çºŒä½ çš„<span class=\"keyword\">æ±Ÿæ¹–</span>ä¹‹è¡Œã€‚", action: () => { currentChapter = 2; currentTimeOfDay = 'day'; updateVisualsBasedOnTime(); }, next: 'chapter2_start', background: sceneBackgrounds.inn },
            chapter2_start: { type: 'narration', title: "ç¬¬äºŒç« ï¼šå‰è·¯è¿½è¹¤", text: (name) => `ç¬¬äºŒç« ï¼šå‰è·¯<span class=\"keyword\">è¿½è¹¤</span> ğŸ—ºï¸\n\nç¶“éåœ¨<span class=\"keyword\">é¾è›‡é®</span>ä¸€å¤œçš„åœç•™ï¼ˆæˆ–é©šé­‚ï¼‰ï¼Œä½  (${name}) æŒæ¡äº†ä¸€äº›<span class=\"keyword\">ç·šç´¢</span>ã€‚ç¾åœ¨ï¼Œæ˜¯æ™‚å€™æ±ºå®šä¸‹ä¸€æ­¥çš„è¡Œå‹•äº†ã€‚`, objective: "æ±ºå®šé›¢é–‹å®¢æ£§å¾Œçš„å»å‘", background: sceneBackgrounds.inn, choices: [ { text: "å‹•èº«å‰å¾€<span class=\"keyword\">è’¼é¾å±±</span>", next: 'chapter2_goto_canglong', condition: (id) => id === 'discipleYun' && gameState.knowsPath, sfx: 'travel' }, { text: "å°‹æ‰¾<span class=\"keyword\">ç§˜å¯¶</span><span class=\"keyword\">ç·šç´¢</span>ï¼Œå‰å¾€<span class=\"keyword\">è’¼é¾å±±</span>æ–¹å‘", next: 'chapter2_goto_canglong', condition: (id) => id === 'wandererZhao' && gameState.heardTreasureRumor, sfx: 'travel' }, { text: "<span class=\"keyword\">è¿½è¹¤</span>æ˜¨å¤œ<span class=\"keyword\">é»‘è¡£åŠå®¢</span>çš„è¹¤è·¡", next: 'chapter2_track_swordsman', condition: () => gameState.encounteredSwordsman, sfx: 'action' }, { text: "åœ¨<span class=\"keyword\">é¾è›‡é®</span>ç¹¼çºŒ<span class=\"keyword\">æ‰“æ¢</span>æ¶ˆæ¯ (æš«æœªé–‹æ”¾)", next: 'chapter2_start', sfx: 'ui_close' } ] },
            chapter2_goto_canglong: { type: 'narration', text: "ä½ é›¢é–‹<span class=\"keyword\">é¾è›‡é®</span>ï¼ŒæŒ‰ç…§<span class=\"keyword\">å»–æŒæ«ƒ</span>ï¼ˆæˆ–ä½ è‡ªå·±æ‰“è½åˆ°çš„ï¼‰æŒ‡å¼•çš„æ–¹å‘ï¼Œè¸ä¸Šäº†å‰å¾€<span class=\"keyword\">è’¼é¾å±±</span>çš„å±±è·¯ã€‚å±±è·¯é€æ¼¸å´å¶‡ï¼Œå…©æ—æ¨¹æœ¨æ„ˆç™¼èŒ‚å¯†ã€‚", background: sceneBackgrounds.forestPath, objective: "æ²¿å±±è·¯å‰å¾€è’¼é¾å±±", next: 'ending_success_delivery' },
            chapter2_track_swordsman: { type: 'narration', text: "ä½ ä»”ç´°æª¢æŸ¥äº†æ˜¨å¤œ<span class=\"keyword\">é»‘è¡£åŠå®¢</span>é›¢é–‹çš„æ–¹å‘ï¼Œç™¼ç¾äº†ä¸€äº›å¹¾ä¹é›£ä»¥å¯Ÿè¦ºçš„ç—•è·¡ã€‚ä½ æ±ºå®š<span class=\"keyword\">è¿½è¹¤</span>ä¸‹å»ï¼Œçœ‹çœ‹èƒ½å¦æŸ¥å‡ºä»–çš„ä¾†æ­·å’Œç›®çš„ã€‚", background: sceneBackgrounds.townStreet, objective: "è¿½è¹¤é»‘è¡£åŠå®¢", next: 'ending_fail_letter_stolen' },
            ending_success_delivery: { type: 'ending', title: "éºå‘½é”æˆ <span title='Check'>âœ”ï¸</span>", description: "æ­·ç¶“è‰±éšªï¼Œä½ æˆåŠŸå°‡<span class=\"keyword\">å¯†å‡½</span>é€åˆ°äº†<span class=\"keyword\">è’¼é¾å±±</span><span class=\"keyword\">å¤å…ˆç”Ÿ</span>çš„æ‰‹ä¸­ã€‚åŸä¾†<span class=\"keyword\">å¯†å‡½</span>ä¸­è¨˜è¼‰è‘—é—œä¹<span class=\"keyword\">æ­¦æ—</span>å®‰å±çš„é‡å¤§ç§˜å¯†ï¼Œä»¥åŠä½ <span class=\"keyword\">å¸«çˆ¶</span>è¢«<span class=\"keyword\">æˆªæ®º</span>çš„çœŸç›¸ã€‚åœ¨<span class=\"keyword\">å¤å…ˆç”Ÿ</span>çš„å¹«åŠ©ä¸‹ï¼Œä½ æœ€çµ‚æ‰‹åˆƒä»‡äººï¼Œå‘Šæ…°äº†å¸«çˆ¶çš„åœ¨å¤©ä¹‹éˆï¼Œä¸¦åœ¨<span class=\"keyword\">æ±Ÿæ¹–</span>ä¸Šç•™ä¸‹äº†ä½ çš„å‚³èªªã€‚", outcome: 'success', background: sceneBackgrounds.ending },
            ending_fail_letter_stolen: { type: 'ending', title: "åŠŸè™§ä¸€ç°£ <span title='Cross'>âŒ</span>", description: "ä¸å¹¸çš„æ˜¯ï¼Œåœ¨ä½ èˆ‡<span class=\"keyword\">é»‘è¡£åŠå®¢</span>ï¼ˆæˆ–å…¶ä»–æ•µäººï¼‰çš„äº¤é‹’ä¸­ï¼Œç”±æ–¼<span class=\"keyword\">å…§åŠ›</span>ä¸æ¿Ÿæˆ–ä¸€æ™‚å¤§æ„ï¼Œæ‡·ä¸­çš„<span class=\"keyword\">å¯†å‡½</span>ï¼ˆæˆ–æ˜¯ä½ å°‹æ‰¾çš„<span class=\"keyword\">ç§˜å¯¶</span>ç·šç´¢ï¼‰è¢«å¥ªèµ°ã€‚å¸«é–€<span class=\"keyword\">éºå‘½</span>æœªèƒ½å®Œæˆï¼Œ<span class=\"keyword\">å¯†å‡½</span>ä¸­çš„ç§˜å¯†è½å…¥æ­¹äººä¹‹æ‰‹ï¼Œ<span class=\"keyword\">æ±Ÿæ¹–</span>æˆ–è¨±å°‡å› æ­¤æ€èµ·æ›´å¤§çš„é¢¨æ³¢ã€‚ä½ åªèƒ½å¸¶è‘—éºæ†¾å’Œä¸ç”˜ï¼Œç¹¼çºŒæ¼‚æ³Šã€‚", outcome: 'fail', background: sceneBackgrounds.ending },
            ending_fail_killed: { type: 'ending', title: "å‘½å–ª<span class=\"keyword\">æ±Ÿæ¹–</span> <span title='Skull'>ğŸ’€</span>", description: "ä½ çš„<span class=\"keyword\">æ±Ÿæ¹–</span>ä¹‹è·¯çµ‚ç©¶å¤ªéå…‡éšªã€‚åœ¨ä¸€æ¬¡<span class=\"keyword\">æˆªæ®º</span>æˆ–<span class=\"keyword\">åŸ‹ä¼</span>ä¸­ï¼Œä½ çµ‚å› å¯¦åŠ›æ‡¸æ®Šï¼Œä¸å¹¸æ®å‘½ã€‚<span class=\"keyword\">å¯†å‡½</span>ï¼ˆæˆ–<span class=\"keyword\">ç§˜å¯¶</span>ï¼‰ä¸‹è½ä¸æ˜ï¼Œä½ çš„åå­—ä¹Ÿå¾ˆå¿«è¢«é€™é¢¨æ³¢è©­è­çš„<span class=\"keyword\">æ±Ÿæ¹–</span>æ‰€éºå¿˜ã€‚", outcome: 'dead', background: sceneBackgrounds.ending },
            ending_fail_generic: { type: 'ending', title: "è¿·é€”<span class=\"keyword\">æ±Ÿæ¹–</span> <span title='Question'>â“</span>", description: "ä¼¼ä¹ç™¼ç”Ÿäº†ä¸€äº›æ„æ–™ä¹‹å¤–çš„ç‹€æ³ï¼Œä½ çš„<span class=\"keyword\">æ±Ÿæ¹–</span>ä¹‹è·¯åœ¨æ­¤ä¸­æ–·ã€‚ä¹Ÿè¨±é‡ä¾†ä¸€æ¬¡ï¼Œæœƒæœ‰ä¸åŒçš„å‘½é‹ã€‚", outcome: 'error', background: sceneBackgrounds.ending }
        };
        // --- æ ¸å¿ƒå‡½æ•¸ ---
        function updateVisualsBasedOnTime() {
            const gameScreenElement = document.getElementById('game-screen');
            if (!gameScreenElement) return;
            const existingOverlay = gameScreenElement.querySelector('.time-overlay');
            if (existingOverlay) existingOverlay.remove();
            if (currentTimeOfDay === 'night') {
                const overlay = document.createElement('div');
                overlay.className = 'time-overlay';
                overlay.style.cssText = `position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(20, 20, 40, 0.35); z-index: 1; pointer-events: none; transition: background-color 0.8s ease-in-out;`;
                gameScreenElement.appendChild(overlay);
                console.log("æ‡‰ç”¨å¤œæ™šé®ç½©");
            } else {
                console.log("ç›®å‰æ˜¯ç™½å¤©ï¼Œç§»é™¤é®ç½©");
            }
        }

        function showScreen(screenId) {
             startScreen.classList.add('hidden');
             characterSelectScreen.classList.add('hidden');
             gameScreen.classList.add('hidden');
             endingScreen.classList.add('hidden');
             const screenToShow = document.getElementById(screenId);
             if (screenToShow) {
                 screenToShow.classList.remove('hidden');
                 let bgKey = screenId.replace('-screen', '');
                 if (screenId === 'start-screen') bgKey = 'start';
                 else if (screenId === 'character-select-screen') bgKey = 'characterSelect';
                 let backgroundUrl = sceneBackgrounds[bgKey];
                 if (screenId === 'game-screen' && currentStoryNodeId && story[currentStoryNodeId] && story[currentStoryNodeId].background) {
                     backgroundUrl = story[currentStoryNodeId].background;
                 } else if (screenId === 'ending-screen' && currentStoryNodeId && story[currentStoryNodeId] && story[currentStoryNodeId].background) {
                    backgroundUrl = story[currentStoryNodeId].background;
                 } else if (screenId === 'ending-screen'){
                    backgroundUrl = sceneBackgrounds['ending'];
                 }
                 if (backgroundUrl && (backgroundUrl.includes('.jpg') || backgroundUrl.includes('.png') || backgroundUrl.includes('.jpeg') || backgroundUrl.includes('.webp'))) {
                     const tempDiv = document.createElement('div');
                     tempDiv.style.cssText = `background-image: url('${backgroundUrl}'); background-size: cover; background-position: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; transition: opacity 0.5s ease-in-out; z-index: -1;`;
                     document.body.appendChild(tempDiv);
                     const img = new Image();
                     img.onload = () => {
                         screenToShow.style.backgroundImage = `url('${backgroundUrl}')`;
                         screenToShow.style.backgroundSize = 'cover';
                         screenToShow.style.backgroundPosition = 'center';
                         const oldTemp = document.querySelector('.temp-bg');
                         if(oldTemp) oldTemp.remove();
                         setTimeout(() => tempDiv.style.opacity = '1', 50);
                         tempDiv.classList.add('temp-bg');
                         setTimeout(() => { if (tempDiv.parentElement) tempDiv.remove(); }, 600);
                     };
                     img.onerror = () => {
                         console.error(`ç„¡æ³•è¼‰å…¥èƒŒæ™¯åœ–ç‰‡: ${backgroundUrl}. ä½¿ç”¨ placeholder.`);
                         screenToShow.style.backgroundImage = `url('https://placehold.co/1200x800/a89888/f5f1e8?text=Image+Error')`;
                         screenToShow.style.backgroundSize = 'cover';
                         screenToShow.style.backgroundPosition = 'center';
                         if (tempDiv.parentElement) tempDiv.remove();
                     }
                     img.src = backgroundUrl;
                 } else {
                    console.warn(`ç„¡æ•ˆæˆ–ç„¡èƒŒæ™¯åœ–ç‰‡ URL: ${backgroundUrl}. ä½¿ç”¨ placeholder.`);
                    screenToShow.style.backgroundImage = `url('https://placehold.co/1200x800/a89888/f5f1e8?text=Wuxia+Scene')`;
                    screenToShow.style.backgroundSize = 'cover';
                    screenToShow.style.backgroundPosition = 'center';
                 }
                if (screenId === 'game-screen') {
                     updateVisualsBasedOnTime();
                } else {
                     const gameScreenElement = document.getElementById('game-screen');
                     const existingOverlay = gameScreenElement?.querySelector('.time-overlay');
                     if (existingOverlay) existingOverlay.remove();
                }
             } else {
                 console.error("ç•«é¢æœªæ‰¾åˆ°:", screenId);
             }
             syncAudioControls();
             updateSpeedDisplay();
        }

        function populateCharacterSelection() {
             characterOptionsContainer.innerHTML = '';
             selectedCharacterIdTemp = null;
             currentTimeOfDay = 'day';
             for (const charId in characters) {
                 const char = characters[charId];
                 const card = document.createElement('div');
                 card.className = 'character-card';
                 card.dataset.charId = charId;
                 let tagsHTML = '';
                 if (char.tags && char.tags.length > 0) {
                     tagsHTML = char.tags.map(tag => `<span class="keyword-tag-box">${highlightKeywords(tag, false)}</span>`).join('');
                 }
                 let avatarSrc = char.avatar;
                 card.innerHTML = `
                     <div class="character-image-container">
                         <img src="${avatarSrc}" alt="${char.name} é ­åƒ" onerror="this.onerror=null; this.src='https://placehold.co/160x200/6a5f55/f0e6d8?text=åœ–ç‰‡è¼‰å…¥å¤±æ•—';">
                     </div>
                     <div class="character-info-container">
                         <h3>${highlightKeywords(char.name)}</h3>
                         <p class="character-description">${highlightKeywords(char.description)}</p>
                         <div class="character-tags">${tagsHTML}</div>
                         <button class="btn btn-select-char btn-gold">é¸æ“‡æ­¤äºº</button>
                     </div>`;
                 const selectButton = card.querySelector('.btn-select-char');
                 if(selectButton) {
                     selectButton.onclick = (event) => {
                         event.stopPropagation();
                         highlightCharacter(charId);
                         selectCharacter(charId);
                     };
                 }
                 card.onclick = () => highlightCharacter(charId);
                 characterOptionsContainer.appendChild(card);
             }
        }

        function highlightCharacter(charId) {
            playSFX('click');
            selectedCharacterIdTemp = charId;
            const allCards = characterOptionsContainer.querySelectorAll('.character-card');
            allCards.forEach(card => card.classList.remove('selected'));
            const selectedCard = characterOptionsContainer.querySelector(`.character-card[data-char-id="${charId}"]`);
            if (selectedCard) selectedCard.classList.add('selected');
        }

        function selectCharacter(charId) {
            if (!charId) return;
            playSFX('confirm');
            chosenCharacter = characters[charId];
            collectedClues = [];
            gameState = {};
            currentChapter = 1;
            currentTimeOfDay = 'day';
            updateNotebook();
            let avatarSrc = chosenCharacter.avatar;
            playerAvatarGame.src = avatarSrc;
            playerAvatarGame.onerror = () => { playerAvatarGame.src = 'https://placehold.co/100x100/cccccc/ffffff?text=?'; };
            playerNameGame.innerHTML = highlightKeywords(chosenCharacter.name);
            loadStoryNode('chapter1_intro');
        }

        function loadStoryNode(nodeId) {
             clearTimeout(typewriterTimeout);
             if ('speechSynthesis' in window) {
                 speechSynthesis.cancel();
                 isSpeechPaused = false; lastSpokenText = ""; lastSpeakButton = null;
             }
             document.querySelectorAll('.speak-button.speaking, .speak-button.paused').forEach(btn => {
                 btn.classList.remove('speaking', 'paused'); btn.innerHTML = 'ğŸ”Š';
             });
             const resolvedNodeId = typeof nodeId === 'function' ? nodeId(chosenCharacter.id) : nodeId;
             const node = story[resolvedNodeId];
             if (!node) {
                 console.error("æ•…äº‹ç¯€é»æœªæ‰¾åˆ°:", resolvedNodeId);
                 loadStoryNode('ending_fail_generic');
                 return;
             }
             currentStoryNodeId = resolvedNodeId;
             showScreen('game-screen');
             if (node.title) {
                 chapterTitle.innerHTML = highlightKeywords(node.title);
             } else if (resolvedNodeId.includes('intro')) {
                 const nodeTextContent = getTextFromNode(node, false);
                 const titleMatch = nodeTextContent.match(/^(.+?)\n/);
                 if (titleMatch) chapterTitle.innerHTML = highlightKeywords(titleMatch[1]);
             }
             if(node.objective) currentObjective.textContent = `ç›®æ¨™: ${node.objective}`;
             else if (resolvedNodeId.includes('intro')) currentObjective.textContent = `ç›®æ¨™: æ¨é€²åŠ‡æƒ…`;
             chapterTitle.classList.add('chapter-title-style');
             if (node.action) node.action();
             if (node.type === 'narration' || node.type === 'dialogue') displayMessage(node);
             else if (node.type === 'ending') { displayEnding(node); return; }
             else displayChoices(node);
        }

        function highlightKeywords(text, isChoice = false) {
            if (!text) return '';
            let highlightedText = text;
            const keywordClass = isChoice ? 'choice-keyword' : 'keyword';
            const regex = new RegExp(`(${keywords.join('|')})`, 'g');
            highlightedText = highlightedText.replace(regex, `<span class="${keywordClass}">$1</span>`);
            return highlightedText;
        }

        function getTextFromNode(node, applyHighlight = true, isChoice = false) {
            let rawText = '';
            if (typeof node.text === 'function') rawText = node.text(chosenCharacter ? chosenCharacter.name : '');
            else rawText = node.text || '';
            return applyHighlight ? highlightKeywords(rawText, isChoice) : rawText;
        }

        function displayMessage(node) {
            const messageHTML = getTextFromNode(node, true, false);
            const messageElement = document.createElement('div');
            messageElement.className = 'dialogue-box fade-in';
            let characterName = "æ—ç™½";
            const nameElement = document.createElement('div');
            nameElement.className = 'character-name';
            let rawTextForSpeech = getTextFromNode(node, false);
            if (node.type === 'dialogue') {
                characterName = node.character;
                const highlightedCharName = highlightKeywords(characterName, false);
                if (chosenCharacter && characterName === chosenCharacter.name) messageElement.classList.add('player');
                else messageElement.classList.add('npc');
                nameElement.innerHTML = highlightedCharName + ":";
                messageElement.appendChild(nameElement);
                rawTextForSpeech = rawTextForSpeech.replace(/^ï¼ˆ.*?ï¼‰/, '').trim();
            } else {
                messageElement.classList.add('italic', 'npc');
                nameElement.innerHTML = characterName + ":";
                messageElement.appendChild(nameElement);
            }
            const plainText = rawTextForSpeech.replace(/<[^>]*>/g, '');
             const emojiRegex = /[\u{1F300}-\u{1F5FF}\u{1F600}-\u{1F64F}\u{1F680}-\u{1F6FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F900}-\u{1F9FF}\u{1FA70}-\u{1FAFF}]/gu;
             let textToSpeak = plainText.replace(emojiRegex, '').replace(/\s+/g, ' ').trim();
            const textSpan = document.createElement('span');
            messageElement.appendChild(textSpan);
            if ('speechSynthesis' in window && textToSpeak) {
                const speakButton = document.createElement('button');
                speakButton.className = 'speak-button'; speakButton.innerHTML = 'ğŸ”Š';
                speakButton.title = 'æ’­æ”¾è²éŸ³'; speakButton.dataset.textToSpeak = textToSpeak;
                speakButton.onclick = (e) => {
                     e.stopPropagation();
                     const text = e.currentTarget.dataset.textToSpeak;
                     const synth = window.speechSynthesis;
                     if (synth.speaking) {
                         if (synth.paused && currentUtterance && currentUtterance.text === text) { console.log("ç¹¼çºŒæœ—è®€"); synth.resume(); e.currentTarget.classList.remove('paused'); e.currentTarget.classList.add('speaking'); e.currentTarget.innerHTML = 'ğŸ”Š'; isSpeechPaused = false; }
                         else if (currentUtterance && currentUtterance.text === text) { console.log("æš«åœæœ—è®€"); synth.pause(); e.currentTarget.classList.add('paused'); e.currentTarget.classList.remove('speaking'); e.currentTarget.innerHTML = 'â¸ï¸'; isSpeechPaused = true; }
                         else { console.log("åœæ­¢èˆŠçš„ï¼Œé–‹å§‹æ–°çš„æœ—è®€"); document.querySelectorAll('.speak-button.speaking, .speak-button.paused').forEach(btn => { if (btn !== e.currentTarget) { btn.classList.remove('speaking', 'paused'); btn.innerHTML = 'ğŸ”Š'; } }); speakText(text, e.currentTarget); e.currentTarget.classList.remove('paused'); e.currentTarget.classList.add('speaking'); e.currentTarget.innerHTML = 'ğŸ”Š'; isSpeechPaused = false; }
                     } else { console.log("é–‹å§‹æœ—è®€"); document.querySelectorAll('.speak-button.speaking, .speak-button.paused').forEach(btn => { if (btn !== e.currentTarget) { btn.classList.remove('speaking', 'paused'); btn.innerHTML = 'ğŸ”Š'; } }); speakText(text, e.currentTarget); e.currentTarget.classList.remove('paused'); e.currentTarget.classList.add('speaking'); e.currentTarget.innerHTML = 'ğŸ”Š'; isSpeechPaused = false; }
                 };
                messageElement.appendChild(speakButton);
            }
            storyDisplay.appendChild(messageElement);
            let charIndex = 0; let visibleHTML = '';
            function typeWriterAdvanced() {
                if (charIndex < messageHTML.length) {
                    const char = messageHTML[charIndex]; let shouldDelay = true;
                    if (char === '<') { const tagMatch = messageHTML.substring(charIndex).match(/^<[^>]+>/); if (tagMatch) { visibleHTML += tagMatch[0]; charIndex += tagMatch[0].length; shouldDelay = false; } else { visibleHTML += char; charIndex++; } }
                    else { visibleHTML += char; charIndex++; }
                    textSpan.innerHTML = visibleHTML;
                    if (shouldDelay) typewriterTimeout = setTimeout(typeWriterAdvanced, typewriterSpeed);
                    else typeWriterAdvanced();
                    storyDisplay.scrollTop = storyDisplay.scrollHeight;
                } else { displayChoices(node); storyDisplay.scrollTop = storyDisplay.scrollHeight; }
            }
            choicesDisplay.innerHTML = ''; disableChoices(); typeWriterAdvanced();
        }

        function displayChoices(node) {
             choicesDisplay.innerHTML = '';
             if (node.choices && node.choices.length > 0) {
                 let hasVisibleChoice = false;
                 node.choices.forEach(choice => {
                     let conditionMet = true; if (choice.condition) conditionMet = choice.condition(chosenCharacter ? chosenCharacter.id : null, gameState);
                     if (conditionMet) {
                         hasVisibleChoice = true; const button = document.createElement('button'); button.className = 'btn block w-full md:w-auto md:inline-block my-1 fade-in'; button.style.opacity = '0';
                         const buttonText = typeof choice.text === 'function' ? choice.text() : choice.text; button.innerHTML = highlightKeywords(buttonText, true);
                         button.onclick = () => { if ('speechSynthesis' in window) { speechSynthesis.cancel(); isSpeechPaused = false; } playSFX(choice.sfx || 'click'); if (choice.action) choice.action(); disableChoices(); loadStoryNode(choice.next); };
                         choicesDisplay.appendChild(button);
                     }
                 });
                 if (hasVisibleChoice) setTimeout(() => { choicesDisplay.querySelectorAll('.btn').forEach(btn => btn.style.opacity = '1'); }, 50);
             } else if (node.next && node.type !== 'ending') {
                 const continueButton = document.createElement('button'); continueButton.className = 'btn block w-full md:w-auto md:inline-block my-1 fade-in btn-gold'; continueButton.style.opacity = '0'; continueButton.textContent = "ç¹¼çºŒ...";
                 continueButton.onclick = () => { if ('speechSynthesis' in window) { speechSynthesis.cancel(); isSpeechPaused = false; } playSFX('click'); disableChoices(); loadStoryNode(node.next); };
                 choicesDisplay.appendChild(continueButton); setTimeout(() => continueButton.style.opacity = '1', 50);
             }
             storyDisplay.scrollTop = storyDisplay.scrollHeight;
        }

        function disableChoices() { choicesDisplay.querySelectorAll('button').forEach(button => { button.disabled = true; button.classList.add('btn-disabled'); }); }
        function displayEnding(node) { playSFX('ending'); endingTitle.innerHTML = highlightKeywords(node.title, false); endingDescription.innerHTML = highlightKeywords(node.description, false); showScreen('ending-screen'); }
        function addClue(clueText) { const plainClueText = clueText.replace(/<[^>]*>/g, ''); const plainCollectedClues = collectedClues.map(c => c.replace(/<[^>]*>/g, '')); if (!plainCollectedClues.includes(plainClueText)) { collectedClues.push(clueText); updateNotebook(); playSFX('discover'); } }
        function hasClue(clueSubstring) { const plainClues = collectedClues.map(clue => clue.replace(/<[^>]*>/g, '')); return plainClues.some(clue => clue.includes(clueSubstring)); }
        function updateGameState(key, value) { gameState[key] = value; console.log("GameState updated:", key, "=", value); }
        function updateNotebook() { clueList.innerHTML = ''; if (collectedClues.length === 0) clueList.innerHTML = '<li>å°šæœªç²å¾—ä»»ä½•<span class="keyword">ç·šç´¢</span>ã€‚</li>'; else collectedClues.forEach(clue => { const li = document.createElement('li'); li.innerHTML = highlightKeywords(clue, false); clueList.appendChild(li); }); }
        function openNotebook() { playSFX('ui'); notebookModal.classList.add('active'); }
        function closeNotebook() { playSFX('ui_close'); notebookModal.classList.remove('active'); }
        function openSettings() { playSFX('ui'); settingsModal.classList.add('active'); syncAudioControls(); }
        function closeSettings() { playSFX('ui_close'); settingsModal.classList.remove('active'); }

        async function initializeAudio() { console.log("[Audio] initializeAudio entered."); if (isAudioInitialized && Tone.context && Tone.context.state === 'running') return true; if (typeof Tone === 'undefined') { console.error("[Audio] Tone.js undefined!"); isAudioInitialized = false; return false; } if (typeof speechSynthesis === 'undefined') console.warn("[Audio] Speech Synthesis not supported."); if (Tone.context && Tone.context.state !== 'running') { console.log("[Audio] Context exists but not running, resuming..."); try { await Tone.context.resume(); console.log("[Audio] Context resumed."); audioContextRequiresInteraction = false; isAudioInitialized = true; setVolume(currentVolume); if ('speechSynthesis' in window) speechSynthesis.cancel(); Tone.Destination.mute = isMuted; return true; } catch (resumeError) { console.error("[Audio] Failed to resume context:", resumeError); } } console.log("[Audio] Attempting Tone.start()..."); try { await Tone.start(); console.log("[Audio] Tone.start() successful."); audioContextRequiresInteraction = false; isAudioInitialized = true; ensureAudioObjects(); setVolume(currentVolume); if ('speechSynthesis' in window) speechSynthesis.cancel(); Tone.Destination.mute = isMuted; return true; } catch (startError) { console.error("[Audio] Failed Tone.start():", startError); isAudioInitialized = false; audioContextRequiresInteraction = true; return false; } }
        function ensureAudioObjects() { if (!synth && isAudioInitialized && Tone.context.state === 'running') { try { console.log("[Audio] Creating Synth..."); synth = new Tone.Synth().toDestination(); console.log("[Audio] Synth created."); } catch (e) { console.error("[Audio] Error creating Synth:", e); return false; } } if (Tone.Transport && Tone.Transport.state !== 'started' && isAudioInitialized) { try { Tone.Transport.start(); console.log("[Audio] Transport started."); } catch (e) { console.error("[Audio] Error starting Transport:", e); } } return !!synth; }
        function playSFX(type) { if (isMuted || !isAudioInitialized) return; if (!ensureAudioObjects() || !synth) { console.error("Cannot play SFX: Audio objects not ready."); return; } try { const now = Tone.now(); switch (type) { case 'click': synth.triggerAttackRelease("E4", "16n", now); break; case 'confirm': synth.triggerAttackRelease("G4", "8n", now); break; case 'discover': synth.triggerAttackRelease("C5", "8n", now + 0.1); synth.triggerAttackRelease("G4", "8n", now); break; case 'puzzle': synth.triggerAttackRelease("A4", "8n", now + 0.1); synth.triggerAttackRelease("C5", "8n", now + 0.2); break; case 'travel': synth.triggerAttackRelease("D3", "4n", now); break; case 'confront': synth.triggerAttackRelease("A3", "4n", now); synth.triggerAttackRelease("D4", "8n", now + 0.3); break; case 'action': synth.triggerAttackRelease("C4", "8n", now); synth.triggerAttackRelease("F4", "8n", now + 0.15); break; case 'decision': synth.triggerAttackRelease("E4", "4n", now); break; case 'decision_final': synth.triggerAttackRelease("C3", "2n", now); break; case 'ending': synth.triggerAttackRelease("A4", "1n", now); break; case 'ui': synth.triggerAttackRelease("D5", "16n", now); break; case 'ui_close': synth.triggerAttackRelease("B4", "16n", now); break; default: synth.triggerAttackRelease("E4", "16n", now); } } catch (e) { console.error("SFX error:", type, e); } }

        function speakText(textToSpeak, buttonElement = null) { if (!('speechSynthesis' in window)) return; if (!textToSpeak || isMuted) return; console.log("æœ—è®€:", textToSpeak); speechSynthesis.cancel(); currentUtterance = new SpeechSynthesisUtterance(textToSpeak); currentUtterance.lang = selectedVoice ? selectedVoice.lang : 'zh-CN'; currentUtterance.voice = selectedVoice; currentUtterance.rate = currentTtsRate; currentUtterance.pitch = currentTtsPitch; lastSpokenText = textToSpeak; lastSpeakButton = buttonElement; isSpeechPaused = false; currentUtterance.onend = () => { console.log("æœ—è®€çµæŸ"); if (lastSpeakButton) { lastSpeakButton.classList.remove('speaking', 'paused'); lastSpeakButton.innerHTML = 'ğŸ”Š'; } currentUtterance = null; lastSpokenText = ""; lastSpeakButton = null; }; currentUtterance.onerror = (event) => { console.error("æœ—è®€éŒ¯èª¤:", event.error); if (lastSpeakButton) { lastSpeakButton.classList.remove('speaking', 'paused'); lastSpeakButton.innerHTML = 'ğŸ”Š'; } currentUtterance = null; lastSpokenText = ""; lastSpeakButton = null; }; speechSynthesis.speak(currentUtterance); }
        function populateVoiceList(attempt = 1) { if (!('speechSynthesis' in window)) return; availableVoices = speechSynthesis.getVoices(); if (availableVoices.length === 0 && attempt <= 5) { setTimeout(() => populateVoiceList(attempt + 1), 100 * attempt); return; } console.log("Available voices:", availableVoices); populateVoiceListAttempts = 0; settingsTtsVoiceSelect.innerHTML = ''; const currentSelectedName = selectedVoice ? selectedVoice.name : null; let foundSelected = false; const chineseVoices = availableVoices.filter(voice => voice.lang.startsWith('zh')); if (chineseVoices.length > 0) { chineseVoices.forEach((voice, index) => { const option = document.createElement('option'); let displayName = voice.name.replace(/Microsoft |Google | \(Online\)| \(Local\)| Taiwan| Chinese \(Taiwan\)| Chinese \(Traditional, Taiwan\)| Chinese \(Simplified, China\)| Chinese/g, '').trim(); if (!displayName) displayName = `èªéŸ³ ${index + 1}`; option.textContent = `${displayName} (${voice.lang})`; option.setAttribute('data-lang', voice.lang); option.setAttribute('data-name', voice.name); if (currentSelectedName === voice.name) { option.selected = true; selectedVoice = voice; foundSelected = true; } else if (!currentSelectedName && !foundSelected && (voice.lang === 'zh-CN' || voice.lang === 'zh-TW')) { option.selected = true; selectedVoice = voice; foundSelected = true; } settingsTtsVoiceSelect.appendChild(option); }); if (!settingsTtsVoiceSelect.querySelector('option[selected]') && settingsTtsVoiceSelect.options.length > 0) { settingsTtsVoiceSelect.selectedIndex = 0; const firstVoiceName = settingsTtsVoiceSelect.options[0].getAttribute('data-name'); selectedVoice = availableVoices.find(v => v.name === firstVoiceName); console.log("Defaulting to first voice:", selectedVoice); } } else { const option = document.createElement('option'); option.textContent = 'ç„¡å¯ç”¨ä¸­æ–‡èªéŸ³'; option.disabled = true; settingsTtsVoiceSelect.appendChild(option); selectedVoice = null; } syncVoiceSelection(); }
        if ('speechSynthesis' in window && speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = populateVoiceList;
        function syncVoiceSelection() { if (!selectedVoice) { settingsTtsVoiceSelect.selectedIndex = -1; return; } let found = false; for (let i = 0; i < settingsTtsVoiceSelect.options.length; i++) { if (settingsTtsVoiceSelect.options[i].getAttribute('data-name') === selectedVoice.name) { settingsTtsVoiceSelect.selectedIndex = i; found = true; break; } } if (!found && settingsTtsVoiceSelect.options.length > 0 && !settingsTtsVoiceSelect.options[0].disabled) { settingsTtsVoiceSelect.selectedIndex = 0; const firstVoiceName = settingsTtsVoiceSelect.options[0].getAttribute('data-name'); selectedVoice = availableVoices.find(v => v.name === firstVoiceName); console.warn("Selected voice not found, defaulting."); } else if (!found) selectedVoice = null; }
        function syncRateSelection() { settingsTtsRateSlider.value = currentTtsRate; } function syncPitchSelection() { settingsTtsPitchSlider.value = currentTtsPitch; }

        function toggleMute() { isMuted = !isMuted; if (isAudioInitialized && Tone.Destination) Tone.Destination.mute = isMuted; updateMuteButtons(); if (isMuted && 'speechSynthesis' in window) { speechSynthesis.cancel(); isSpeechPaused = false; document.querySelectorAll('.speak-button.speaking, .speak-button.paused').forEach(btn => { btn.classList.remove('speaking', 'paused'); btn.innerHTML = 'ğŸ”Š'; }); } }
        function updateMuteButtons() { settingsMuteButton.textContent = isMuted ? "å–æ¶ˆéœéŸ³" : "éœéŸ³"; }
        function setVolume(value) { const newVolume = parseFloat(value); currentVolume = newVolume; if (isAudioInitialized && Tone.Destination && !isMuted) Tone.Destination.volume.value = (newVolume === 0) ? -Infinity : Tone.gainToDb(newVolume); settingsVolumeSlider.value = newVolume; }
        function syncAudioControls() { settingsVolumeSlider.value = currentVolume; updateMuteButtons(); if (isAudioInitialized && Tone.Destination) { Tone.Destination.mute = isMuted; if (!isMuted) setVolume(currentVolume); } syncVoiceSelection(); syncRateSelection(); syncPitchSelection(); }
        function updateSpeedDisplay() { const speedMultiplier = (BASE_TYPEWRITER_SPEED / typewriterSpeed).toFixed(1); settingsSpeedDisplay.textContent = `x${speedMultiplier}`; }
        function increaseSpeed() { typewriterSpeed = Math.max(MAX_SPEED, typewriterSpeed - SPEED_STEP); updateSpeedDisplay(); playSFX('click'); }
        function decreaseSpeed() { typewriterSpeed = Math.min(MIN_SPEED, typewriterSpeed + SPEED_STEP); updateSpeedDisplay(); playSFX('click'); }

        function saveGame() { if (!chosenCharacter || !currentStoryNodeId) { alert("å°šæœªé–‹å§‹éŠæˆ²æˆ–è™•æ–¼ç„¡æ³•å„²å­˜çš„ç‹€æ…‹ã€‚"); playSFX('ui_close'); return; } const voiceNameToSave = selectedVoice ? selectedVoice.name : null; const saveData = { chosenCharacterId: chosenCharacter.id, currentChapter: currentChapter, currentStoryNodeId: currentStoryNodeId, collectedClues: collectedClues, gameState: gameState, currentTimeOfDay: currentTimeOfDay, currentVolume: currentVolume, isMuted: isMuted, typewriterSpeed: typewriterSpeed, selectedVoiceName: voiceNameToSave, currentTtsRate: currentTtsRate, currentTtsPitch: currentTtsPitch, currentObjectiveText: currentObjective.textContent }; try { localStorage.setItem(SAVE_GAME_KEY, JSON.stringify(saveData)); alert("é€²åº¦å·²å„²å­˜ï¼ğŸ’¾"); playSFX('confirm'); } catch (error) { console.error("å„²å­˜å¤±æ•—:", error); alert("å„²å­˜å¤±æ•—ï¼"); playSFX('ui_close'); } }
        async function loadGame() { const savedDataString = localStorage.getItem(SAVE_GAME_KEY); if (!savedDataString) { alert("æ‰¾ä¸åˆ°å­˜æª”ã€‚"); playSFX('ui_close'); return; } try { const savedData = JSON.parse(savedDataString); console.log("è®€å–:", savedData); chosenCharacter = characters[savedData.chosenCharacterId]; currentChapter = savedData.currentChapter ?? 1; currentStoryNodeId = savedData.currentStoryNodeId; collectedClues = savedData.collectedClues || []; gameState = savedData.gameState || {}; currentTimeOfDay = savedData.currentTimeOfDay || 'day'; if (!chosenCharacter || !currentStoryNodeId) throw new Error("å­˜æª”è³‡æ–™ä¸å®Œæ•´ã€‚"); currentVolume = savedData.currentVolume ?? 0.5; isMuted = savedData.isMuted ?? false; typewriterSpeed = savedData.typewriterSpeed ?? BASE_TYPEWRITER_SPEED; currentTtsRate = savedData.currentTtsRate ?? 1; currentTtsPitch = savedData.currentTtsPitch ?? 1; const savedVoiceName = savedData.selectedVoiceName; if (savedVoiceName) { if (availableVoices.length > 0) { selectedVoice = availableVoices.find(v => v.name === savedVoiceName); if (!selectedVoice) console.warn(`æ‰¾ä¸åˆ°èªéŸ³: ${savedVoiceName}`); } else console.warn("èªéŸ³åˆ—è¡¨æœªè¼‰å…¥ï¼Œç¨å¾ŒåŒæ­¥ã€‚"); } else selectedVoice = null; let avatarSrc = chosenCharacter.avatar; playerAvatarGame.src = avatarSrc; playerAvatarGame.onerror = () => { playerAvatarGame.src = 'https://placehold.co/100x100/cccccc/ffffff?text=?'; }; playerNameGame.innerHTML = highlightKeywords(chosenCharacter.name); currentObjective.textContent = savedData.currentObjectiveText || 'ç›®æ¨™: æ¨é€²åŠ‡æƒ…'; updateNotebook(); syncAudioControls(); updateSpeedDisplay(); if (!isAudioInitialized) { console.log("éŸ³è¨Šæœªåˆå§‹åŒ–ï¼Œå˜—è©¦å•Ÿå‹•..."); const audioReady = await initializeAudio(); if (!audioReady) console.warn("éŸ³è¨Šåˆå§‹åŒ–å¤±æ•—ã€‚"); else { setVolume(currentVolume); if (Tone.Destination) Tone.Destination.mute = isMuted; syncVoiceSelection(); } } else { setVolume(currentVolume); if (Tone.Destination) Tone.Destination.mute = isMuted; syncVoiceSelection(); } storyDisplay.innerHTML = ''; const node = story[currentStoryNodeId]; if (node) { showScreen('game-screen'); choicesDisplay.innerHTML = ''; displayMessage(node); } else throw new Error(`æ‰¾ä¸åˆ°ç¯€é» ID: ${currentStoryNodeId}`); playSFX('confirm'); alert("é€²åº¦å·²è¼‰å…¥ï¼"); } catch (error) { console.error("è®€å–å¤±æ•—:", error); alert(`è®€å–å¤±æ•—ï¼š${error.message}`); localStorage.removeItem(SAVE_GAME_KEY); loadGameButton.classList.add('hidden'); showScreen('start-screen'); playSFX('ui_close'); } }


        // --- äº‹ä»¶ç›£è½å™¨ ---
        startGameButton.addEventListener('click', async () => { console.log("é–‹å§‹éŠæˆ²"); if (typeof Tone === 'undefined' || typeof speechSynthesis === 'undefined') { alert("ç„¡æ³•åˆå§‹åŒ–éŸ³è¨Šç³»çµ±ï¼"); return; } const audioReady = await initializeAudio(); if (audioReady) { playSFX('confirm'); populateVoiceList(); } else alert("éŸ³è¨Šåˆå§‹åŒ–å¤±æ•—ï¼"); populateCharacterSelection(); showScreen('character-select-screen'); });
        restartButton.addEventListener('click', () => { playSFX('click'); if (localStorage.getItem(SAVE_GAME_KEY)) { if (confirm("é‡å…¥æ±Ÿæ¹–å°‡éºå¿˜éå¾€é€²åº¦ï¼Œç¢ºå®šå—ï¼Ÿ")) { localStorage.removeItem(SAVE_GAME_KEY); loadGameButton.classList.add('hidden'); } else return; } showScreen('start-screen'); currentChapter = 0; currentStoryNodeId = null; chosenCharacter = null; collectedClues = []; gameState = {}; currentTimeOfDay = 'day'; selectedCharacterIdTemp = null; storyDisplay.innerHTML = ''; choicesDisplay.innerHTML = ''; updateNotebook(); typewriterSpeed = BASE_TYPEWRITER_SPEED; updateSpeedDisplay(); if ('speechSynthesis' in window) { speechSynthesis.cancel(); isSpeechPaused = false; } });
        notebookButton.addEventListener('click', openNotebook);
        openSettingsButton.addEventListener('click', openSettings);
        saveGameButton.addEventListener('click', saveGame);
        loadGameButton.addEventListener('click', loadGame);
        settingsVolumeSlider.addEventListener('input', (event) => setVolume(event.target.value));
        settingsMuteButton.addEventListener('click', toggleMute);
        settingsSpeedUpButton.addEventListener('click', increaseSpeed);
        settingsSpeedDownButton.addEventListener('click', decreaseSpeed);
        settingsTtsVoiceSelect.addEventListener('change', (event) => { const selectedOption = event.target.options[event.target.selectedIndex]; if (selectedOption && !selectedOption.disabled) { const voiceName = selectedOption.getAttribute('data-name'); selectedVoice = availableVoices.find(voice => voice.name === voiceName); syncVoiceSelection(); if ((speechSynthesis.speaking || speechSynthesis.paused) && currentUtterance && lastSpokenText && lastSpeakButton) { speakText(lastSpokenText, lastSpeakButton); lastSpeakButton.classList.remove('paused'); lastSpeakButton.classList.add('speaking'); lastSpeakButton.innerHTML = 'ğŸ”Š'; } } });
        settingsTtsRateSlider.addEventListener('input', (event) => { currentTtsRate = parseFloat(event.target.value); syncRateSelection(); if ((speechSynthesis.speaking || speechSynthesis.paused) && currentUtterance && lastSpokenText && lastSpeakButton) { speakText(lastSpokenText, lastSpeakButton); lastSpeakButton.classList.remove('paused'); lastSpeakButton.classList.add('speaking'); lastSpeakButton.innerHTML = 'ğŸ”Š'; } });
        settingsTtsPitchSlider.addEventListener('input', (event) => { currentTtsPitch = parseFloat(event.target.value); syncPitchSelection(); if ((speechSynthesis.speaking || speechSynthesis.paused) && currentUtterance && lastSpokenText && lastSpeakButton) { speakText(lastSpokenText, lastSpeakButton); lastSpeakButton.classList.remove('paused'); lastSpeakButton.classList.add('speaking'); lastSpeakButton.innerHTML = 'ğŸ”Š'; } });

        // --- åˆå§‹è¨­å®š ---
        showScreen('start-screen');
        if (localStorage.getItem(SAVE_GAME_KEY)) loadGameButton.classList.remove('hidden'); else loadGameButton.classList.add('hidden');
        syncAudioControls(); updateSpeedDisplay(); populateVoiceList();
        window.onclick = function(event) { if (event.target == notebookModal) closeNotebook(); if (event.target == settingsModal) closeSettings(); }

    </script>
</body>
</html>