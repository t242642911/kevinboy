<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>劇本殺單次消費金額分佈</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        :root {
            --color-bg: #232946;
            --color-card: #fffffe;
            --color-section: #eebbc3;
            --color-text: #232946;
            --color-text-light: #4a5568;
            --color-accent: #eebbc3;
            --color-highlight: #b8c1ec;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            --radius: 12px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            
            /* 箱型圖配色 */
            --box-1-fill: rgba(111, 168, 220, 0.6);
            --box-1-stroke: #4285f4;
            --box-2-fill: rgba(106, 204, 134, 0.6);
            --box-2-stroke: #34a853;
            --box-3-fill: rgba(255, 179, 71, 0.6);
            --box-3-stroke: #fbbc05;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--color-bg);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(91, 104, 235, 0.1) 0%, rgba(0, 0, 0, 0) 20%),
                radial-gradient(circle at 90% 80%, rgba(238, 187, 195, 0.1) 0%, rgba(0, 0, 0, 0) 20%),
                radial-gradient(circle at 50% 50%, rgba(184, 193, 236, 0.08) 0%, rgba(0, 0, 0, 0) 100%);
            background-attachment: fixed;
            color: var(--color-text);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: var(--color-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            padding: 2rem;
            overflow: hidden;
        }
        
        .header {
            margin-bottom: 2rem;
            text-align: center;
            position: relative;
        }
        
        .title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--color-text);
            position: relative;
            display: inline-block;
        }
        
        .title::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 10%;
            width: 80%;
            height: 3px;
            background: linear-gradient(90deg, var(--box-1-stroke), var(--box-2-stroke), var(--box-3-stroke));
            border-radius: 3px;
        }
        
        .subtitle {
            font-size: 1rem;
            color: var(--color-text-light);
            font-weight: 400;
            margin-top: 1rem;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: var(--color-highlight);
            background-image: linear-gradient(135deg, var(--color-highlight) 0%, rgba(255,255,255,0.8) 100%);
            border-radius: var(--radius);
        }
        
        .control-group {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .custom-checkbox {
            position: relative;
            display: inline-block;
            width: 18px;
            height: 18px;
            margin-right: 0.5rem;
            border-radius: 4px;
            border: 2px solid var(--color-text-light);
            transition: var(--transition);
        }
        
        .custom-checkbox::after {
            content: "✓";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 12px;
            color: white;
            transition: var(--transition);
        }
        
        .checkbox-container input {
            display: none;
        }
        
        .checkbox-container input:checked + .custom-checkbox {
            background-color: var(--color-accent);
            border-color: var(--color-accent);
        }
        
        .checkbox-container input:checked + .custom-checkbox::after {
            transform: translate(-50%, -50%) scale(1);
        }
        
        .checkbox-label {
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        button {
            background-color: var(--color-bg);
            color: white;
            border: 1px solid transparent;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        button:hover {
            background-color: rgba(35, 41, 70, 0.8);
            box-shadow: var(--shadow-sm);
        }
        
        button.active {
            background-color: var(--color-accent);
            color: var(--color-bg);
        }
        
        button svg {
            width: 16px;
            height: 16px;
        }
        
        .chart-container {
            position: relative;
            height: 500px;
            margin: 1rem 0 2rem;
            border: 1px solid #e2e8f0;
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            background-color: #ffffff;
            background-image: linear-gradient(135deg, #ffffff 0%, #f7f9fc 100%);
            overflow: hidden;
        }
        
        .tooltip {
            position: absolute;
            background-color: rgba(35, 41, 70, 0.95);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            pointer-events: none;
            opacity: 0;
            z-index: 20;
            box-shadow: var(--shadow-md);
            transition: opacity 0.2s;
            max-width: 250px;
        }
        
        .tooltip-title {
            font-weight: 700;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .tooltip-row {
            display: flex;
            justify-content: space-between;
            margin: 0.25rem 0;
        }
        
        .tooltip-label {
            margin-right: 1rem;
            opacity: 0.8;
        }
        
        .symbol-guide {
            margin: 2rem 0;
            background-color: var(--color-section);
            background-image: linear-gradient(135deg, var(--color-section) 0%, rgba(255,255,255,0.9) 100%);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }
        
        .guide-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--color-text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .guide-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        
        .guide-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
        }
        
        .guide-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.25rem;
        }
        
        .guide-symbol {
            font-size: 1.3rem;
            font-weight: 500;
            color: var(--color-text);
            min-width: 35px;
            text-align: center;
            background-color: var(--color-highlight);
            padding: 3px 6px;
            border-radius: 4px;
        }
        
        .guide-label {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .guide-text {
            font-size: 0.9rem;
            color: var(--color-text-light);
            margin-left: 2.8rem;
        }
        
        .method {
            font-style: italic;
            margin-top: 0.5rem;
            font-size: 0.85rem;
            background-color: rgba(255, 255, 255, 0.5);
            padding: 0.5rem;
            border-radius: 4px;
            border-left: 3px solid var(--color-accent);
        }
        
        .box {
            fill-opacity: 0.7;
            transition: var(--transition);
        }
        
        .box:hover {
            fill-opacity: 0.9;
        }
        
        .median-line {
            stroke-width: 2.5;
            stroke-linecap: round;
        }
        
        .whisker {
            stroke-width: 1.5;
            stroke-dasharray: 3, 3;
        }
        
        .whisker-end {
            stroke-width: 1.5;
            stroke-linecap: round;
        }
        
        .outlier {
            stroke-width: 1.5;
            transition: var(--transition);
        }
        
        .outlier:hover {
            r: 6;
        }
        
        .value-label {
            font-size: 11px;
            font-weight: 500;
            dominant-baseline: middle;
        }
        
        .axis-title {
            font-size: 14px;
            font-weight: 500;
            fill: var(--color-text-light);
        }
        
        .tick text {
            font-size: 12px;
            fill: var(--color-text-light);
        }
        
        .tick line {
            stroke: #e2e8f0;
        }
        
        .domain {
            stroke: #cbd5e1;
            stroke-width: 1.5;
        }
        
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin: 2rem 0;
            display: none;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        
        .stats-table th, .stats-table td {
            padding: 0.75rem 1rem;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        
        .stats-table th {
            background-color: var(--color-highlight);
            font-weight: 500;
            position: relative;
        }
        
        .stats-table th:first-child {
            text-align: left;
        }
        
        .stats-table tbody tr:nth-child(even) {
            background-color: #f8fafc;
        }
        
        .stats-table tbody tr:hover {
            background-color: rgba(238, 187, 195, 0.1);
        }
        
        .stats-table td:first-child {
            font-weight: 500;
            text-align: left;
        }
        
        .th-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .th-symbol {
            font-size: 0.9rem;
            color: var(--color-text);
        }
        
        .footer {
            text-align: center;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
            font-size: 0.875rem;
            color: var(--color-text-light);
        }
        
        /* 標籤背景，避免重疊 */
        .stat-label {
            font-size: 11px;
            font-weight: 500;
            fill: var(--color-text);
            paint-order: stroke;
            stroke: white;
            stroke-width: 3px;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        .stat-value {
            font-size: 12px;
            font-weight: 600;
            fill: var(--color-text);
            paint-order: stroke;
            stroke: white;
            stroke-width: 3px;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        .stat-line {
            stroke: #cbd5e1;
            stroke-width: 1;
            stroke-dasharray: 2, 2;
        }
        
        .chart-legend {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 6px;
            box-shadow: var(--shadow-sm);
            font-size: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 2px;
            border: 1px solid #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">劇本殺單次消費金額分佈</h1>
            <p class="subtitle">比較不同類型劇本殺的價格區間與分佈特徵</p>
        </div>
        
        <div class="controls">
            <div class="control-group" id="checkboxes">
                <!-- 複選框會由JavaScript動態生成 -->
            </div>
            <div class="control-group">
                <button id="toggle-values">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2z"></path><path d="M4 2v6"></path><path d="M2 4h6"></path><path d="M14 2v4"></path><path d="M20 2v4"></path><path d="M10 2v1"></path></svg>
                    顯示數值
                </button>
                <button id="toggle-stats">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"></path><path d="m3.3 7 8.7 5 8.7-5"></path><path d="M12 22V12"></path></svg>
                    統計詳情
                </button>
            </div>
        </div>
        
        <div class="chart-container" id="boxplot"></div>
        
        <div class="symbol-guide">
            <h3 class="guide-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
                箱型圖符號說明
            </h3>
            <div class="guide-grid">
                <div class="guide-item">
                    <div class="guide-header">
                        <span class="guide-symbol">x̄</span>
                        <span class="guide-label">平均值</span>
                    </div>
                    <div class="guide-text">所有數據點的算術平均值</div>
                    <div class="method">計算方法：(所有數值之和) ÷ (數據點總數)</div>
                </div>
                <div class="guide-item">
                    <div class="guide-header">
                        <span class="guide-symbol">x̃</span>
                        <span class="guide-label">中位數</span>
                    </div>
                    <div class="guide-text">將所有數據從小到大排序後的中間值</div>
                    <div class="method">計算方法：奇數數列取中間值，偶數數列取中間兩數的平均值</div>
                </div>
                <div class="guide-item">
                    <div class="guide-header">
                        <span class="guide-symbol">Q₁</span>
                        <span class="guide-label">第一四分位數</span>
                    </div>
                    <div class="guide-text">數據從小到大排序後，位於25%位置的值</div>
                    <div class="method">計算方法：先找出中位數，再從下半部分找出中間值</div>
                </div>
                <div class="guide-item">
                    <div class="guide-header">
                        <span class="guide-symbol">Q₃</span>
                        <span class="guide-label">第三四分位數</span>
                    </div>
                    <div class="guide-text">數據從小到大排序後，位於75%位置的值</div>
                    <div class="method">計算方法：先找出中位數，再從上半部分找出中間值</div>
                </div>
                <div class="guide-item">
                    <div class="guide-header">
                        <span class="guide-symbol">Min</span>
                        <span class="guide-label">最小值</span>
                    </div>
                    <div class="guide-text">數據集中的最小數值，不包括離群值</div>
                    <div class="method">通常是大於 Q₁ - 1.5×IQR 的最小值</div>
                </div>
                <div class="guide-item">
                    <div class="guide-header">
                        <span class="guide-symbol">Max</span>
                        <span class="guide-label">最大值</span>
                    </div>
                    <div class="guide-text">數據集中的最大數值，不包括離群值</div>
                    <div class="method">通常是小於 Q₃ + 1.5×IQR 的最大值</div>
                </div>
                <div class="guide-item">
                    <div class="guide-header">
                        <span class="guide-symbol">IQR</span>
                        <span class="guide-label">四分位距</span>
                    </div>
                    <div class="guide-text">反映數據集中間50%的分散程度</div>
                    <div class="method">計算方法：Q₃ - Q₁</div>
                </div>
                <div class="guide-item">
                    <div class="guide-header">
                        <span class="guide-symbol">○</span>
                        <span class="guide-label">離群值</span>
                    </div>
                    <div class="guide-text">與主要數據分佈相距較遠的異常值</div>
                    <div class="method">計算方法：小於 Q₁ - 1.5×IQR 或大於 Q₃ + 1.5×IQR 的數據點</div>
                </div>
            </div>
        </div>
        
        <table class="stats-table" id="stats-table">
            <thead>
                <tr>
                    <th>類型</th>
                    <th>
                        <div class="th-content">
                            <span class="th-symbol">Min</span>
                            <span>最小值</span>
                        </div>
                    </th>
                    <th>
                        <div class="th-content">
                            <span class="th-symbol">Q₁</span>
                            <span>第一四分位數</span>
                        </div>
                    </th>
                    <th>
                        <div class="th-content">
                            <span class="th-symbol">x̃</span>
                            <span>中位數</span>
                        </div>
                    </th>
                    <th>
                        <div class="th-content">
                            <span class="th-symbol">Q₃</span>
                            <span>第三四分位數</span>
                        </div>
                    </th>
                    <th>
                        <div class="th-content">
                            <span class="th-symbol">Max</span>
                            <span>最大值</span>
                        </div>
                    </th>
                    <th>
                        <div class="th-content">
                            <span class="th-symbol">x̄</span>
                            <span>平均值</span>
                        </div>
                    </th>
                    <th>
                        <div class="th-content">
                            <span class="th-symbol">IQR</span>
                            <span>四分位距</span>
                        </div>
                    </th>
                </tr>
            </thead>
            <tbody id="stats-body">
                <!-- 數據會由JavaScript動態生成 -->
            </tbody>
        </table>
        
        <div class="footer">
            © 2025 專業統計數據可視化 · 基於D3.js實現 · 數據來源：劇本殺市場消費調研
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 設定數據
            const boxplotData = [
                {
                    category: "普通盒裝本",
                    min: 80,
                    q1: 120,
                    median: 150,
                    q3: 180,
                    max: 240,
                    outliers: [65, 260],
                    color: "var(--box-1-fill)",
                    borderColor: "var(--box-1-stroke)",
                    mean: 155,
                    iqr: 60, // 四分位距
                    symbol: "📦"
                },
                {
                    category: "城市限定本",
                    min: 120,
                    q1: 180,
                    median: 220,
                    q3: 260,
                    max: 320,
                    outliers: [100, 350],
                    color: "var(--box-2-fill)",
                    borderColor: "var(--box-2-stroke)",
                    mean: 220,
                    iqr: 80,
                    symbol: "🏙️"
                },
                {
                    category: "獨家本",
                    min: 200,
                    q1: 260,
                    median: 320,
                    q3: 380,
                    max: 450,
                    outliers: [180, 500],
                    color: "var(--box-3-fill)",
                    borderColor: "var(--box-3-stroke)",
                    mean: 320,
                    iqr: 120,
                    symbol: "💎"
                }
            ];
            
            // 初始化顯示狀態
            let showValues = false;
            let showStats = false;
            let visibleCategories = boxplotData.map(d => d.category);
            
            // 創建複選框
            const checkboxContainer = document.getElementById('checkboxes');
            boxplotData.forEach(data => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'checkbox-container';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `show-${data.category}`;
                checkbox.checked = true;
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        visibleCategories.push(data.category);
                    } else {
                        visibleCategories = visibleCategories.filter(c => c !== data.category);
                    }
                    updateChart();
                });
                
                const customCheckbox = document.createElement('span');
                customCheckbox.className = 'custom-checkbox';
                customCheckbox.style.borderColor = data.borderColor;
                
                const label = document.createElement('label');
                label.className = 'checkbox-label';
                label.htmlFor = `show-${data.category}`;
                label.textContent = `${data.symbol} ${data.category}`;
                
                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(customCheckbox);
                checkboxDiv.appendChild(label);
                checkboxContainer.appendChild(checkboxDiv);
            });
            
            // 設定圖表尺寸和邊距
            const margin = {top: 60, right: 120, bottom: 60, left: 70};
            const width = 800;
            const height = 450;
            
            // 創建SVG元素
            const svg = d3.select("#boxplot")
                .append("svg")
                .attr("width", "100%")
                .attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "xMidYMid meet");
            
            // 添加圖例
            const legend = svg.append("g")
                .attr("class", "chart-legend")
                .attr("transform", `translate(${width - 150}, 10)`);
            
            // 創建漸變填充
            const defs = svg.append("defs");
            
            // 創建垂直漸變
            boxplotData.forEach((d, i) => {
                const gradient = defs.append("linearGradient")
                    .attr("id", `box-gradient-${i}`)
                    .attr("x1", "0%")
                    .attr("y1", "0%")
                    .attr("x2", "0%")
                    .attr("y2", "100%");
                
                gradient.append("stop")
                    .attr("offset", "0%")
                    .attr("stop-color", d.color)
                    .attr("stop-opacity", 0.9);
                
                gradient.append("stop")
                    .attr("offset", "100%")
                    .attr("stop-color", d.color)
                    .attr("stop-opacity", 0.7);
            });
            
            // 創建工具提示
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip");
            
            // 創建圖表組
            const chart = svg.append("g")
                .attr("transform", `translate(${margin.left}, ${margin.top})`);
            
            // 創建X軸比例尺
            const x = d3.scaleBand()
                .range([0, width - margin.left - margin.right])
                .padding(0.3);
            
            // 創建Y軸比例尺
            const y = d3.scaleLinear()
                .range([height - margin.top - margin.bottom, 0]);
            
            // 初始化X軸
            const xAxis = chart.append("g")
                .attr("class", "x-axis")
                .attr("transform", `translate(0, ${height - margin.top - margin.bottom})`);
            
            // 初始化Y軸
            const yAxis = chart.append("g")
                .attr("class", "y-axis");
            
            // 添加Y軸標題
            chart.append("text")
                .attr("class", "axis-title")
                .attr("transform", "rotate(-90)")
                .attr("y", -50)
                .attr("x", -(height - margin.top - margin.bottom) / 2)
                .attr("text-anchor", "middle")
                .text("消費金額（元）");
            
            // 添加水平網格線
            const gridGroup = chart.append("g")
                .attr("class", "grid-lines");
            
            // 更新圖表函數
            function updateChart() {
                // 過濾可見數據
                const filteredData = boxplotData.filter(d => visibleCategories.includes(d.category));
                
                // 更新X軸域
                x.domain(filteredData.map(d => d.category));
                
                // 更新Y軸域
                const allValues = filteredData.flatMap(d => [d.min, d.q1, d.median, d.q3, d.max, ...d.outliers]);
                const yMin = Math.min(...allValues) * 0.9;
                const yMax = Math.max(...allValues) * 1.1;
                y.domain([yMin, yMax]);
                
                // 更新X軸
                xAxis.transition().duration(500)
                    .call(d3.axisBottom(x).tickSizeOuter(0))
                    .selectAll("text")
                    .attr("dy", "0.5em");
                
                // 更新X軸標籤（添加符號）
                xAxis.selectAll(".tick text")
                    .text(d => {
                        const item = boxplotData.find(item => item.category === d);
                        return `${item.symbol} ${d}`;
                    });
                
                // 更新Y軸
                yAxis.transition().duration(500)
                    .call(d3.axisLeft(y).tickSizeOuter(0).ticks(10).tickFormat(d => d));
                
                // 更新水平網格線
                const yTicks = y.ticks(10);
                
                const gridLines = gridGroup.selectAll(".grid-line")
                    .data(yTicks);
                
                gridLines.exit().remove();
                
                gridLines.enter()
                    .append("line")
                    .attr("class", "grid-line")
                    .merge(gridLines)
                    .transition().duration(500)
                    .attr("x1", 0)
                    .attr("x2", width - margin.left - margin.right)
                    .attr("y1", d => y(d))
                    .attr("y2", d => y(d))
                    .attr("stroke", "#e2e8f0")
                    .attr("stroke-width", 1)
                    .attr("stroke-dasharray", "3,3");
                
                // 更新箱型圖
                // 移除所有現有元素
                chart.selectAll(".box-container").remove();
                chart.selectAll(".value-label").remove();
                chart.selectAll(".stat-label-group").remove();
                
                // 創建箱型圖容器
                const boxContainers = chart.selectAll(".box-container")
                    .data(filteredData)
                    .enter()
                    .append("g")
                    .attr("class", "box-container")
                    .attr("transform", d => `translate(${x(d.category) + x.bandwidth()/2}, 0)`);
                
                // 創建箱體
                boxContainers.append("rect")
                    .attr("class", "box")
                    .attr("x", -x.bandwidth()/3)
                    .attr("y", d => y(d.q3))
                    .attr("width", x.bandwidth()/1.5)
                    .attr("height", d => y(d.q1) - y(d.q3))
                    .attr("rx", 3)
                    .attr("ry", 3)
                    .attr("fill", (d, i) => `url(#box-gradient-${i})`)
                    .attr("stroke", d => d.borderColor)
                    .attr("stroke-width", 2)
                    .on("mouseover", function(event, d) {
                        d3.select(this)
                            .transition()
                            .duration(150)
                            .attr("stroke-width", 3);
                            
                        tooltip.transition()
                            .duration(200)
                            .style("opacity", 0.9);
                            
                        tooltip.html(`
                            <div class="tooltip-title">${d.symbol} ${d.category}</div>
                            <div class="tooltip-row">
                                <span class="tooltip-label">最小值 (Min):</span>
                                <span>${d.min}元</span>
                            </div>
                            <div class="tooltip-row">
                                <span class="tooltip-label">第一四分位數 (Q₁):</span>
                                <span>${d.q1}元</span>
                            </div>
                            <div class="tooltip-row">
                                <span class="tooltip-label">中位數 (x̃):</span>
                                <span><strong>${d.median}元</strong></span>
                            </div>
                            <div class="tooltip-row">
                                <span class="tooltip-label">第三四分位數 (Q₃):</span>
                                <span>${d.q3}元</span>
                            </div>
                            <div class="tooltip-row">
                                <span class="tooltip-label">最大值 (Max):</span>
                                <span>${d.max}元</span>
                            </div>
                            <div class="tooltip-row">
                                <span class="tooltip-label">平均值 (x̄):</span>
                                <span>${d.mean}元</span>
                            </div>
                            <div class="tooltip-row">
                                <span class="tooltip-label">四分位距 (IQR):</span>
                                <span>${d.iqr}元</span>
                            </div>
                        `)
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", function() {
                        d3.select(this)
                            .transition()
                            .duration(150)
                            .attr("stroke-width", 2);
                            
                        tooltip.transition()
                            .duration(500)
                            .style("opacity", 0);
                    });
                
                // 創建中位數線
                boxContainers.append("line")
                    .attr("class", "median-line")
                    .attr("x1", -x.bandwidth()/3)
                    .attr("x2", x.bandwidth()/3)
                    .attr("y1", d => y(d.median))
                    .attr("y2", d => y(d.median))
                    .attr("stroke", d => d.borderColor)
                    .attr("stroke-width", 2);
                
                // 添加中位數符號標籤
                boxContainers.append("text")
                    .attr("class", "median-symbol")
                    .attr("x", -x.bandwidth()/3 - 25)
                    .attr("y", d => y(d.median))
                    .attr("text-anchor", "end")
                    .attr("dy", "0.35em")
                    .attr("font-size", "12px")
                    .attr("font-weight", "500")
                    .attr("fill", d => d.borderColor)
                    .text("x̃");
                
                // 創建上鬚線
                boxContainers.append("line")
                    .attr("class", "whisker")
                    .attr("x1", 0)
                    .attr("x2", 0)
                    .attr("y1", d => y(d.q3))
                    .attr("y2", d => y(d.max))
                    .attr("stroke", d => d.borderColor)
                    .attr("stroke-dasharray", "3,2");
                
                // 創建上鬚末端
                boxContainers.append("line")
                    .attr("class", "whisker-end")
                    .attr("x1", -x.bandwidth()/6)
                    .attr("x2", x.bandwidth()/6)
                    .attr("y1", d => y(d.max))
                    .attr("y2", d => y(d.max))
                    .attr("stroke", d => d.borderColor);
                
                // 創建下鬚線
                boxContainers.append("line")
                    .attr("class", "whisker")
                    .attr("x1", 0)
                    .attr("x2", 0)
                    .attr("y1", d => y(d.q1))
                    .attr("y2", d => y(d.min))
                    .attr("stroke", d => d.borderColor)
                    .attr("stroke-dasharray", "3,2");
                
                // 創建下鬚末端
                boxContainers.append("line")
                    .attr("class", "whisker-end")
                    .attr("x1", -x.bandwidth()/6)
                    .attr("x2", x.bandwidth()/6)
                    .attr("y1", d => y(d.min))
                    .attr("y2", d => y(d.min))
                    .attr("stroke", d => d.borderColor);
                
                // 添加平均值標記 (X 形狀)
                boxContainers.append("path")
                    .attr("d", d => {
                        const size = 6;
                        const yPos = y(d.mean);
                        return `M${-size},${yPos-size} L${size},${yPos+size} M${-size},${yPos+size} L${size},${yPos-size}`;
                    })
                    .attr("stroke", d => d.borderColor)
                    .attr("stroke-width", 2)
                    .attr("fill", "none");
                
                // 添加平均值符號標籤
                boxContainers.append("text")
                    .attr("x", x.bandwidth()/3 + 5)
                    .attr("y", d => y(d.mean))
                    .attr("dy", "0.35em")
                    .attr("text-anchor", "start")
                    .attr("font-size", "12px")
                    .attr("font-weight", "500")
                    .attr("fill", d => d.borderColor)
                    .text("x̄");
                
                // 創建離群值
                boxContainers.selectAll(".outlier")
                    .data(d => d.outliers.map(value => ({value, category: d.category, color: d.color, borderColor: d.borderColor})))
                    .enter()
                    .append("circle")
                    .attr("class", "outlier")
                    .attr("cx", 0)
                    .attr("cy", d => y(d.value))
                    .attr("r", 4.5)
                    .attr("fill", d => d.color)
                    .attr("stroke", d => d.borderColor)
                    .on("mouseover", function(event, d) {
                        d3.select(this)
                            .transition()
                            .duration(150)
                            .attr("r", 6);
                            
                        tooltip.transition()
                            .duration(200)
                            .style("opacity", 0.9);
                            
                        tooltip.html(`
                            <div class="tooltip-title">${d.category}</div>
                            <div class="tooltip-row">
                                <span class="tooltip-label">離群值:</span>
                                <span>${d.value}元</span>
                            </div>
                        `)
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", function() {
                        d3.select(this)
                            .transition()
                            .duration(150)
                            .attr("r", 4.5);
                            
                        tooltip.transition()
                            .duration(500)
                            .style("opacity", 0);
                    });
                
                // 創建統計數據標籤（避免重疊）
                if (showValues) {
                    filteredData.forEach((d, i) => {
                        const centerX = x(d.category) + x.bandwidth()/2;
                        const statLabelGroup = chart.append("g")
                            .attr("class", "stat-label-group");
                        
                        // 最右側標籤組 (Q3, Max)
                        const rightOffset = x.bandwidth()/2 + 35;
                        
                        // Q3標籤
                        statLabelGroup.append("line")
                            .attr("class", "stat-line")
                            .attr("x1", centerX + x.bandwidth()/6)
                            .attr("y1", y(d.q3))
                            .attr("x2", centerX + rightOffset - 5)
                            .attr("y2", y(d.q3));
                        
                        statLabelGroup.append("text")
                            .attr("class", "stat-label")
                            .attr("x", centerX + rightOffset)
                            .attr("y", y(d.q3))
                            .attr("text-anchor", "start")
                            .attr("dy", "0.35em")
                            .text(`Q₃:`);
                        
                        statLabelGroup.append("text")
                            .attr("class", "stat-value")
                            .attr("x", centerX + rightOffset + 25)
                            .attr("y", y(d.q3))
                            .attr("text-anchor", "start")
                            .attr("dy", "0.35em")
                            .text(d.q3);
                        
                        // Max標籤
                        statLabelGroup.append("line")
                            .attr("class", "stat-line")
                            .attr("x1", centerX + x.bandwidth()/6)
                            .attr("y1", y(d.max))
                            .attr("x2", centerX + rightOffset - 5)
                            .attr("y2", y(d.max));
                        
                        statLabelGroup.append("text")
                            .attr("class", "stat-label")
                            .attr("x", centerX + rightOffset)
                            .attr("y", y(d.max))
                            .attr("text-anchor", "start")
                            .attr("dy", "0.35em")
                            .text(`Max:`);
                        
                        statLabelGroup.append("text")
                            .attr("class", "stat-value")
                            .attr("x", centerX + rightOffset + 30)
                            .attr("y", y(d.max))
                            .attr("text-anchor", "start")
                            .attr("dy", "0.35em")
                            .text(d.max);
                        
                        // 最左側標籤組 (Q1, Min)
                        const leftOffset = -x.bandwidth()/2 - 35;
                        
                        // Q1標籤
                        statLabelGroup.append("line")
                            .attr("class", "stat-line")
                            .attr("x1", centerX - x.bandwidth()/6)
                            .attr("y1", y(d.q1))
                            .attr("x2", centerX + leftOffset + 5)
                            .attr("y2", y(d.q1));
                        
                        statLabelGroup.append("text")
                            .attr("class", "stat-label")
                            .attr("x", centerX + leftOffset)
                            .attr("y", y(d.q1))
                            .attr("text-anchor", "end")
                            .attr("dy", "0.35em")
                            .text(`Q₁:`);
                        
                        statLabelGroup.append("text")
                            .attr("class", "stat-value")
                            .attr("x", centerX + leftOffset - 5)
                            .attr("y", y(d.q1))
                            .attr("text-anchor", "end")
                            .attr("dy", "0.35em")
                            .text(d.q1);
                        
                        // Min標籤
                        statLabelGroup.append("line")
                            .attr("class", "stat-line")
                            .attr("x1", centerX - x.bandwidth()/6)
                            .attr("y1", y(d.min))
                            .attr("x2", centerX + leftOffset + 5)
                            .attr("y2", y(d.min));
                        
                        statLabelGroup.append("text")
                            .attr("class", "stat-label")
                            .attr("x", centerX + leftOffset)
                            .attr("y", y(d.min))
                            .attr("text-anchor", "end")
                            .attr("dy", "0.35em")
                            .text(`Min:`);
                        
                        statLabelGroup.append("text")
                            .attr("class", "stat-value")
                            .attr("x", centerX + leftOffset - 5)
                            .attr("y", y(d.min))
                            .attr("text-anchor", "end")
                            .attr("dy", "0.35em")
                            .text(d.min);
                        
                        // Median標籤 (頂部)
                        statLabelGroup.append("text")
                            .attr("class", "stat-value")
                            .attr("x", centerX)
                            .attr("y", y(d.median) - 15)
                            .attr("text-anchor", "middle")
                            .attr("dy", "0")
                            .attr("fill", d.borderColor)
                            .attr("font-weight", "bold")
                            .text(d.median);
                    });
                }
                
                // 更新統計表
                updateStatsTable();
                
                // 更新按鈕狀態
                document.getElementById('toggle-values').className = showValues ? 'active' : '';
                document.getElementById('toggle-stats').className = showStats ? 'active' : '';
            }
            
            // 更新統計表
            function updateStatsTable() {
                const statsBody = document.getElementById('stats-body');
                statsBody.innerHTML = '';
                
                const filteredData = boxplotData.filter(d => visibleCategories.includes(d.category));
                
                filteredData.forEach(data => {
                    const row = document.createElement('tr');
                    
                    const categoryCell = document.createElement('td');
                    categoryCell.innerHTML = `<strong>${data.symbol} ${data.category}</strong>`;
                    row.appendChild(categoryCell);
                    
                    [data.min, data.q1, data.median, data.q3, data.max, data.mean, data.iqr].forEach(value => {
                        const cell = document.createElement('td');
                        cell.textContent = value;
                        row.appendChild(cell);
                    });
                    
                    statsBody.appendChild(row);
                });
            }
            
            // 添加按鈕事件監聽器
            document.getElementById('toggle-values').addEventListener('click', function() {
                showValues = !showValues;
                this.textContent = showValues ? '隱藏數值' : '顯示數值';
                this.className = showValues ? 'active' : '';
                updateChart();
            });
            
            document.getElementById('toggle-stats').addEventListener('click', function() {
                showStats = !showStats;
                this.textContent = showStats ? '隱藏統計資料' : '統計詳情';
                this.className = showStats ? 'active' : '';
                document.getElementById('stats-table').style.display = showStats ? 'table' : 'none';
                updateStatsTable();
            });
            
            // 初始化圖表
            updateChart();
            
            // 響應窗口大小變化
            window.addEventListener('resize', updateChart);
        });
    </script>
</body>
</html>