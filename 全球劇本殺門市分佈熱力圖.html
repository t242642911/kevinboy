<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨çƒåŠ‡æœ¬æ®ºé–€åº—ç†±åŠ›åœ– | å°ˆæ¥­ç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100%; 
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            overflow: hidden;
        }
        #map { 
            height: 100vh; 
            width: 100vw; 
        }
        .control-panel {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1000;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.2);
            width: 260px;
        }
        .location-card {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.88);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 1000;
            max-width: 80%;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .location-card.show { opacity: 1; }
        .country-flag { 
            width: 20px; 
            height: 15px; 
            margin-right: 8px; 
            vertical-align: middle;
            border-radius: 2px;
            box-shadow: 0 0 3px rgba(0,0,0,0.3);
        }
        .control-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        .control-group {
            margin-bottom: 12px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            color: #555;
        }
        input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
        }
        .gradient-legend {
            height: 12px;
            width: 100%;
            background: linear-gradient(to right, #1E90FF, #00CED1, #32CD32, #FFD700, #FF4500);
            margin: 10px 0 5px;
            border-radius: 6px;
        }
        .legend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #666;
        }
        button {
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 13px;
            margin-top: 5px;
            transition: all 0.2s;
        }
        button:hover {
            background: #e0e0e0;
        }
        .info-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #FFD700;
        }
        .info-content {
            font-size: 14px;
            line-height: 1.5;
        }
        .gender-ratio {
            display: flex;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            overflow: hidden;
            margin: 5px 0;
        }
        .gender-male {
            background: #4A90E2;
        }
        .gender-female {
            background: #FF6B81;
        }
        .gender-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- å°ˆæ¥­æ§åˆ¶é¢æ¿ -->
    <div class="control-panel">
        <div class="control-title">âš™ï¸ ç†±åŠ›åœ–æ§åˆ¶é¢æ¿</div>
        
        <div class="control-group">
            <label for="radius">ç†±é»åŠå¾‘: <span id="radius-value">25</span>px</label>
            <input type="range" id="radius" min="10" max="50" value="25">
        </div>
        
        <div class="control-group">
            <label for="blur">æ¨¡ç³Šç¨‹åº¦: <span id="blur-value">15</span>px</label>
            <input type="range" id="blur" min="5" max="30" value="15">
        </div>
        
        <div class="gradient-legend"></div>
        <div class="legend-labels">
            <span>1-10å®¶</span>
            <span>10-30å®¶</span>
            <span>30-50å®¶</span>
            <span>50+å®¶</span>
        </div>
        
        <button id="reset-btn">ğŸ”„ é‡ç½®è¨­å®š</button>
        <button id="info-btn">â„¹ï¸ ç•¶å‰æ•¸æ“š</button>
    </div>
    
    <!-- åœ°é»ä¿¡æ¯å¡ -->
    <div class="location-card">
        <div class="info-title">
            <img id="country-flag" class="country-flag" src="" alt="">
            <span id="location-name">é»æ“Šç†±å€æŸ¥çœ‹</span>
        </div>
        <div class="info-content">
            <div>ğŸ“Œ é–€åº—æ•¸é‡: <span id="store-count" style="font-weight:bold;">0</span> å®¶</div>
            <div class="gender-labels">
                <span>â™‚ <span id="male-percent">50</span>%</span>
                <span>â™€ <span id="female-percent">50</span>%</span>
            </div>
            <div class="gender-ratio">
                <div id="gender-male-bar" class="gender-male" style="width:50%"></div>
                <div id="gender-female-bar" class="gender-female" style="width:50%"></div>
            </div>
            <div>ğŸ† ç†±é–€å“ç‰Œ: <span id="popular-brands">-</span></div>
            <div>ğŸ’µ å¹³å‡åƒ¹æ ¼: <span id="avg-price" style="color:#FFD700">-</span></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.min.js"></script>
    <script>
        // ==================== å…¨çƒæ•¸æ“šåº« (æ–°å¢genderRatioç”·å¥³æ¯”ä¾‹) ====================
        const globalData = {
            // äºæ´²
            "25.0330,121.5654": { 
                name:"å°åŒ—", country:"TW", stores:42, 
                genderRatio: { male:45, female:55 },
                brands:"è¬é¹¿å·¥ä½œå®¤ã€è¬€æ®ºè¡›æ˜Ÿ", price:"NT$500-800" 
            },
            "31.2304,121.4737": { 
                name:"ä¸Šæµ·", country:"CN", stores:68,
                genderRatio: { male:48, female:52 },
                brands:"æœˆå‡é…’åº—ã€ç¬¬ä¸ƒè™Ÿå«Œç–‘äºº", price:"Â¥120-200" 
            },
            "39.9042,116.4074": { 
                name:"åŒ—äº¬", country:"CN", stores:57,
                genderRatio: { male:50, female:50 },
                brands:"åŠ‡å¥½ç©ã€è¿·éœ§æ¨ç†ç¤¾", price:"Â¥150-250" 
            },
            "23.1291,113.2644": { 
                name:"å»£å·", country:"CN", stores:48,
                genderRatio: { male:47, female:53 },
                brands:"è¬å®¤ã€å»£è¬", price:"Â¥100-180" 
            },
            "22.5436,114.0549": { 
                name:"æ·±åœ³", country:"CN", stores:39,
                genderRatio: { male:52, female:48 },
                brands:"æ·±è¬ã€æ™‚å…‰æ¨ç†", price:"Â¥130-220" 
            },
            "30.6595,104.0660": { 
                name:"æˆéƒ½", country:"CN", stores:52,
                genderRatio: { male:43, female:57 },
                brands:"ç†Šè²“è¬æ¡ˆã€èœ€éƒ½æ¨ç†", price:"Â¥90-160" 
            },
            "35.6895,139.6917": { 
                name:"æ±äº¬", country:"JP", stores:35,
                genderRatio: { male:55, female:45 },
                brands:"æ±äº¬è¬æ¡ˆã€æ«»èŠ±æ¨ç†ç¤¾", price:"Â¥2,500-4,000" 
            },
            "37.5665,126.9780": { 
                name:"é¦–çˆ¾", country:"KR", stores:28,
                genderRatio: { male:40, female:60 },
                brands:"Kæ¨ç†ç¤¾ã€æœ¬æ ¼è¬é¡Œ", price:"â‚©25,000-40,000" 
            },
            "1.3521,103.8198": { 
                name:"æ–°åŠ å¡", country:"SG", stores:18,
                genderRatio: { male:47, female:53 },
                brands:"ç…åŸè¬æ¡ˆã€å—æ´‹æ¨ç†", price:"S$30-50" 
            },
            "22.3193,114.1694": { 
                name:"é¦™æ¸¯", country:"HK", stores:26,
                genderRatio: { male:49, female:51 },
                brands:"ç•°åº¦ç©ºé–“ã€HKæ¨ç†ç¤¾", price:"HK$200-350" 
            },
            
            // åŒ—ç¾
            "40.7128,-74.0060": { 
                name:"ç´ç´„", country:"US", stores:25,
                genderRatio: { male:42, female:58 },
                brands:"Mystery NYCã€Boxed Inn", price:"$35-60" 
            },
            "34.0522,-118.2437": { 
                name:"æ´›æ‰ç£¯", country:"US", stores:22,
                genderRatio: { male:45, female:55 },
                brands:"Escape Room LA", price:"$30-55" 
            },
            "43.6532,-79.3832": { 
                name:"å¤šå€«å¤š", country:"CA", stores:15,
                genderRatio: { male:38, female:62 },
                brands:"Mystery Mansion", price:"CA$40-65" 
            },
            "41.8781,-87.6298": { 
                name:"èŠåŠ å“¥", country:"US", stores:12,
                genderRatio: { male:50, female:50 },
                brands:"Chicago Mystery", price:"$35-60" 
            },
            
            // æ­æ´²
            "51.5074,-0.1278": { 
                name:"å€«æ•¦", country:"GB", stores:32,
                genderRatio: { male:43, female:57 },
                brands:"Deadlockedã€Mystery Village", price:"Â£25-45" 
            },
            "48.8566,2.3522": { 
                name:"å·´é»", country:"FR", stores:18,
                genderRatio: { male:47, female:53 },
                brands:"Escape Hunt Paris", price:"â‚¬30-50" 
            },
            "52.5200,13.4050": { 
                name:"æŸæ—", country:"DE", stores:12,
                genderRatio: { male:52, female:48 },
                brands:"Mystery Berlin", price:"â‚¬25-40" 
            },
            "41.9028,12.4964": { 
                name:"ç¾…é¦¬", country:"IT", stores:10,
                genderRatio: { male:55, female:45 },
                brands:"Rome Mystery", price:"â‚¬30-55" 
            },
            "55.6761,12.5683": { 
                name:"å“¥æœ¬å“ˆæ ¹", country:"DK", stores:8,
                genderRatio: { male:40, female:60 },
                brands:"Nordic Mysteries", price:"DKK200-350" 
            },
            
            // å¤§æ´‹æ´²
            "-33.8688,151.2093": { 
                name:"é›ªæ¢¨", country:"AU", stores:14,
                genderRatio: { male:45, female:55 },
                brands:"Mystery Rooms", price:"AU$40-70" 
            },
            "-37.8136,144.9631": { 
                name:"å¢¨çˆ¾æœ¬", country:"AU", stores:11,
                genderRatio: { male:48, female:52 },
                brands:"Melbourne Mysteries", price:"AU$35-65" 
            },
            
            // å…¶ä»–åœ°å€
            "19.4326,-99.1332": { 
                name:"å¢¨è¥¿å“¥åŸ", country:"MX", stores:9,
                genderRatio: { male:53, female:47 },
                brands:"Misterio MX", price:"MXN300-500" 
            },
            "-23.5505,-46.6333": { 
                name:"è–ä¿ç¾…", country:"BR", stores:7,
                genderRatio: { male:58, female:42 },
                brands:"MistÃ©rio Brasil", price:"R$80-150" 
            },
            "28.6139,77.2090": { 
                name:"æ–°å¾·é‡Œ", country:"IN", stores:6,
                genderRatio: { male:60, female:40 },
                brands:"Bollywood Mystery", price:"â‚¹800-1,500" 
            }
        };

        // ç”Ÿæˆç†±åŠ›é»æ•¸æ“š
        const heatPoints = Object.keys(globalData).map(key => {
            const [lat, lng] = key.split(',').map(Number);
            const intensity = Math.min(globalData[key].stores * 2, 100); // å¼·åº¦ä¸Šé™100
            return [lat, lng, intensity];
        });

        // ==================== åœ°åœ–åˆå§‹åŒ– ====================
        const map = L.map('map').setView([25, 110], 3);
        
        // ä½¿ç”¨OpenStreetMapåº•åœ–
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            maxZoom: 18
        }).addTo(map);

        // ==================== ç†±åŠ›åœ–å±¤ ====================
        let heatLayer = L.heatLayer(heatPoints, {
            radius: 25,
            blur: 15,
            maxZoom: 16,
            minOpacity: 0.7,
            max: 100,
            gradient: {
                0.2: '#1E90FF',  // è— (1-10å®¶)
                0.4: '#00CED1',   // é’ (10-20å®¶)
                0.6: '#32CD32',   // ç¶  (20-30å®¶)
                0.8: '#FFD700',   // é»ƒ (30-50å®¶)
                1.0: '#FF4500'    // ç´… (50+å®¶)
            }
        }).addTo(map);

        // ==================== æ§åˆ¶é¢æ¿é‚è¼¯ ====================
        const radiusSlider = document.getElementById('radius');
        const blurSlider = document.getElementById('blur');
        const radiusValue = document.getElementById('radius-value');
        const blurValue = document.getElementById('blur-value');
        const resetBtn = document.getElementById('reset-btn');
        const infoBtn = document.getElementById('info-btn');
        const locationCard = document.querySelector('.location-card');
        let cardTimeout;

        // æ»‘å‹•æ¢æ§åˆ¶
        radiusSlider.addEventListener('input', (e) => {
            const value = e.target.value;
            radiusValue.textContent = value;
            heatLayer.setOptions({ radius: parseInt(value) });
        });

        blurSlider.addEventListener('input', (e) => {
            const value = e.target.value;
            blurValue.textContent = value;
            heatLayer.setOptions({ blur: parseInt(value) });
        });

        // é‡ç½®æŒ‰éˆ•
        resetBtn.addEventListener('click', () => {
            map.setView([25, 110], 3);
            heatLayer.setOptions({ radius: 25, blur: 15 });
            radiusSlider.value = 25;
            blurSlider.value = 15;
            radiusValue.textContent = '25';
            blurValue.textContent = '15';
            showLocationCard('è¨­å®šå·²é‡ç½®', 'æ‰€æœ‰åƒæ•¸æ¢å¾©é»˜èªå€¼', '', '', 2000);
        });

        // æ•¸æ“šä¿¡æ¯æŒ‰éˆ•
        infoBtn.addEventListener('click', () => {
            const totalStores = Object.values(globalData).reduce((sum, city) => sum + city.stores, 0);
            showLocationCard(
                'å…¨çƒæ•¸æ“šçµ±è¨ˆ',
                `ğŸŒ è¦†è“‹ ${Object.keys(globalData).length} å€‹åŸå¸‚\nğŸ“Š ç¸½é–€åº—æ•¸: ${totalStores} å®¶`,
                '',
                '',
                3000
            );
        });

        // ==================== åœ°åœ–äº’å‹• ====================
        map.on('click', function(e) {
            clearTimeout(cardTimeout); // æ¸…é™¤ä¹‹å‰çš„è¨ˆæ™‚å™¨
            
            const { lat, lng } = e.latlng;
            let nearestCity = null;
            let minDistance = Infinity;
            
            // å°‹æ‰¾æœ€è¿‘çš„åŸå¸‚ (150å…¬é‡Œç¯„åœå…§)
            Object.keys(globalData).forEach(key => {
                const [cityLat, cityLng] = key.split(',').map(Number);
                const distance = Math.sqrt(Math.pow(cityLat - lat, 2) + Math.pow(cityLng - lng, 2));
                
                if (distance < minDistance && distance < 1.35) { // ç´„150å…¬é‡Œ
                    minDistance = distance;
                    nearestCity = globalData[key];
                }
            });
            
            if (nearestCity) {
                updateLocationCard(nearestCity);
                cardTimeout = setTimeout(() => {
                    locationCard.classList.remove('show');
                }, 10000); // 10ç§’å¾Œè‡ªå‹•éš±è—
            } else {
                showLocationCard('æœªåµæ¸¬åˆ°é–€åº—', 'è«‹é»æ“Šå½©è‰²ç†±å€æŸ¥çœ‹è©³ç´°æ•¸æ“š', '', '', 2000);
            }
        });

        // ç§»å‹•åœ°åœ–æ™‚éš±è—å¡ç‰‡
        map.on('movestart', () => {
            clearTimeout(cardTimeout);
            locationCard.classList.remove('show');
        });

        // ==================== å·¥å…·å‡½æ•¸ ====================
        function updateLocationCard(cityData) {
            document.getElementById('location-name').textContent = cityData.name;
            document.getElementById('store-count').textContent = cityData.stores;
            document.getElementById('popular-brands').textContent = cityData.brands;
            document.getElementById('avg-price').textContent = cityData.price;
            
            // è¨­ç½®ç”·å¥³æ¯”ä¾‹
            const malePercent = cityData.genderRatio.male;
            const femalePercent = cityData.genderRatio.female;
            document.getElementById('male-percent').textContent = malePercent;
            document.getElementById('female-percent').textContent = femalePercent;
            document.getElementById('gender-male-bar').style.width = `${malePercent}%`;
            document.getElementById('gender-female-bar').style.width = `${femalePercent}%`;
            
            // åŠ è¼‰åœ‹æ——
            const flagImg = document.getElementById('country-flag');
            flagImg.src = `https://flagcdn.com/w20/${cityData.country.toLowerCase()}.png`;
            flagImg.alt = cityData.country;
            
            locationCard.classList.add('show');
        }
        
        function showLocationCard(title, stores, brands, price, duration) {
            document.getElementById('location-name').textContent = title;
            document.getElementById('store-count').textContent = stores;
            document.getElementById('popular-brands').textContent = brands;
            document.getElementById('avg-price').textContent = price;
            locationCard.classList.add('show');
            setTimeout(() => locationCard.classList.remove('show'), duration);
        }
    </script>
</body>
</html>
